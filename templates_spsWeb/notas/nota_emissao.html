{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/ui.css' %}">
<div class="container page-container">
  <div class="page-header-custom">
    <h2 class="page-title"><i class="bi bi-upload"></i> Emissão de Nota Fiscal</h2>
    <div class="page-actions d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/web/{{ slug }}/notas-fiscais/">Voltar</a>
    </div>
  </div>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-principal" type="button"
        role="tab">Principal</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cliente" type="button"
        role="tab">Cliente</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-itens" type="button" role="tab">Itens</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cfop" type="button" role="tab">CFOP &
        Tributos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-transporte" type="button"
        role="tab">Transporte</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-totais" type="button"
        role="tab">Totais</button>
    </li>
  </ul>

  <form id="emit-form" class="tab-content border border-top-0 p-3">
    <div class="tab-pane fade show active" id="tab-principal" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Modelo</label>
          <select class="form-select" name="modelo">
            <option value="55">NF-e</option>
            <option value="65">NFC-e</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Série</label>
          <input type="number" class="form-control" name="serie" value="1" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Número</label>
          <input type="number" class="form-control" name="numero" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Data de Emissão</label>
          <input type="date" class="form-control" name="data_emissao" value="{{ data_emissao_default }}" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Data de Saída</label>
          <input type="date" class="form-control" name="data_saida" value="{{ data_saida_default }}" />
        </div>
        <div class="col-md-12">
          <label class="form-label">Natureza da Operação</label>
          <input type="text" class="form-control" name="natureza_operacao" value="Venda de mercadoria" />
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cliente" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Cliente</label>
          <input type="text" class="form-control" id="cli-autocomplete"
            placeholder="Digite nome/CNPJ/CPF e selecione" />
          <input type="hidden" name="destinatario" id="destinatario-id" />
          <small class="text-muted">Busca limitada a 20 resultados</small>
        </div>
        <div class="col-md-4">
          <div class="form-text">Após selecionar, os dados do cliente serão inferidos automaticamente.</div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-itens" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Produto</label>
          <input type="text" class="form-control" id="prod-autocomplete"
            placeholder="Digite descrição/ref/código e selecione" />
          <input type="hidden" id="produto-codigo" />
        </div>
        <div class="col-md-3">
          <label class="form-label">NCM</label>
          <input type="text" class="form-control" name="item_ncm" id="item-ncm" value="00000000" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Unidade</label>
          <input type="text" class="form-control" name="item_unidade" id="item-unidade" value="UN" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Quantidade</label>
          <input type="number" step="0.0001" class="form-control" name="item_quantidade" id="item-quantidade"
            value="1" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Unitário</label>
          <input type="number" step="0.01" class="form-control" name="item_unitario" id="item-unitario" value="0" />
          <small class="text-muted">Preço sugerido vem de Tabela de Preços</small>
        </div>
        <div class="col-md-3">
          <label class="form-label">Desconto</label>
          <input type="number" step="0.01" class="form-control" name="item_desconto" id="item-desconto" value="0" />
        </div>
        <div class="col-md-3">
          <label class="form-label">CFOP</label>
          <input type="text" class="form-control" name="item_cfop" id="item-cfop" value="5102" />
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-2">
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-item"><i class="bi bi-plus"></i>
          Adicionar Item</button>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-sm table-hover table-compact" id="items-table">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Qtd</th>
              <th>Unit</th>
              <th>Desc</th>
              <th>CFOP</th>
              <th>NCM</th>
              <th>Total</th>
              <th>Fonte</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-cfop" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Pesquisar CFOP</label>
          <input type="text" class="form-control" id="cfop-autocomplete" placeholder="Digite CFOP ou descrição" />
        </div>
        <div class="col-md-6">
          <div class="row g-2">
            <div class="col-4">
              <label class="form-label">CST ICMS</label>
              <input type="text" class="form-control" id="cst-icms" name="cst_icms" />
            </div>
            <div class="col-4">
              <label class="form-label">CST PIS</label>
              <input type="text" class="form-control" id="cst-pis" name="cst_pis" />
            </div>
            <div class="col-4">
              <label class="form-label">CST COFINS</label>
              <input type="text" class="form-control" id="cst-cofins" name="cst_cofins" />
            </div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-6">
              <label class="form-label">CST IBS</label>
              <input type="text" class="form-control" id="cst-ibs" name="cst_ibs" />
            </div>
            <div class="col-6">
              <label class="form-label">CST CBS</label>
              <input type="text" class="form-control" id="cst-cbs" name="cst_cbs" />
            </div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-3">
              <label class="form-label">ICMS %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-icms" name="icms_aliquota" />
            </div>
            <div class="col-3">
              <label class="form-label">IPI %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-ipi" name="ipi_aliquota" />
            </div>
            <div class="col-3">
              <label class="form-label">PIS %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-pis" name="pis_aliquota" />
            </div>
            <div class="col-3">
              <label class="form-label">COFINS %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-cof" name="cofins_aliquota" />
            </div>
            <div class="col-3">
              <label class="form-label">IBS %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-ibs" name="ibs_aliquota" />
            </div>
            <div class="col-3">
              <label class="form-label">CBS %</label>
              <input type="number" step="0.01" class="form-control" id="aliq-cbs" name="cbs_aliquota" />
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-2">
              <label class="form-label">ICMS R$</label>
              <input type="text" class="form-control" id="cfop-total-icms" readonly />
            </div>
            <div class="col-2">
              <label class="form-label">IPI R$</label>
              <input type="text" class="form-control" id="cfop-total-ipi" readonly />
            </div>
            <div class="col-2">
              <label class="form-label">PIS R$</label>
              <input type="text" class="form-control" id="cfop-total-pis" readonly />
            </div>
            <div class="col-2">
              <label class="form-label">COFINS R$</label>
              <input type="text" class="form-control" id="cfop-total-cofins" readonly />
            </div>
            <div class="col-2">
              <label class="form-label">CBS R$</label>
              <input type="text" class="form-control" id="cfop-total-cbs" readonly />
            </div>
            <div class="col-2">
              <label class="form-label">IBS R$</label>
              <input type="text" class="form-control" id="cfop-total-ibs" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="tab-transporte" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Modalidade de Transporte</label>
          <input type="text" class="form-control" name="transporte_modalidade" id="transporte-modalidade" value="01" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Transportadora</label>
          <input type="text" class="form-control" name="transportadora" id="transportadora" value="" />
          <input type="hidden" id="transportadora-id" />
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="tab-totais" role="tabpanel">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Total Produtos</label>
          <input type="text" class="form-control" name="total" id="total" value="" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Desconto</label>
          <input type="text" class="form-control" name="total_desconto" id="total-desconto" value="" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Tributos</label>
          <input type="text" class="form-control" id="total-tributos" value="" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Total Nota</label>
          <input type="text" class="form-control" id="total-nota" value="" />
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-2">
          <label class="form-label">ICMS</label>
          <input type="text" class="form-control" id="total-icms" value="" />
        </div>
        <div class="col-md-2">
          <label class="form-label">IPI</label>
          <input type="text" class="form-control" id="total-ipi" value="" />
        </div>
        <div class="col-md-2">
          <label class="form-label">PIS</label>
          <input type="text" class="form-control" id="total-pis" value="" />
        </div>
        <div class="col-md-2">
          <label class="form-label">COFINS</label>
          <input type="text" class="form-control" id="total-cofins" value="" />
        </div>
        <div class="col-md-2">
          <label class="form-label">CBS</label>
          <input type="text" class="form-control" id="total-cbs" value="" />
        </div>
        <div class="col-md-2">
          <label class="form-label">IBS</label>
          <input type="text" class="form-control" id="total-ibs" value="" />
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <a class="btn btn-secondary" href="/web/{{ slug }}/notas-fiscais/">Voltar</a>
      <button class="btn btn-outline-primary" type="button" id="btn-salvar"><span
          class="spinner-border spinner-border-sm me-1 d-none" aria-hidden="true"></span> <i class="bi bi-save"></i>
        Salvar</button>
      <button class="btn btn-success" type="submit"><span class="spinner-border spinner-border-sm me-1 d-none"
          aria-hidden="true"></span> <i class="bi bi-upload"></i> Transmitir</button>
    </div>
  </form>
</div>

<div class="modal fade" id="modal-item-calculo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do cálculo do item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modal-item-calculo-body"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const slug = localStorage.getItem('slug');
    const empresa = localStorage.getItem('empresa_id') || '1';
    const filial = localStorage.getItem('filial_id') || '1';
    const authFetch = async (url, options = {}) => {
      const token = localStorage.getItem('access');
      const headers = { 'Content-Type': 'application/json', 'X-Empresa': empresa, 'X-Filial': filial };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(url, { ...options, headers: { ...headers, ...(options.headers || {}) } });
    };

    // --- Autocomplete Cliente ---
    const mountAutocomplete = (input, source, onPick) => {
      let timer = null;
      const listId = input.id + '-list';
      const list = document.createElement('div');
      list.className = 'list-group position-absolute w-100';
      list.id = listId;
      input.parentElement.appendChild(list);
      const render = (items) => {
        list.innerHTML = '';
        items.forEach(it => {
          const a = document.createElement('a');
          a.href = '#'; a.className = 'list-group-item list-group-item-action';
          a.textContent = it.label;
          a.addEventListener('click', (e) => { e.preventDefault(); onPick(it); list.innerHTML = ''; });
          list.appendChild(a);
        });
      };
      input.addEventListener('input', async () => {
        const q = input.value.trim();
        clearTimeout(timer);
        timer = setTimeout(async () => {
          if (!q) { list.innerHTML = ''; return; }
          const resp = await authFetch(source(q));
          const data = await resp.json();
          render(Array.isArray(data) ? data : []);
        }, 250);
      });
    };

    const cliInput = document.getElementById('cli-autocomplete');
    const destId = document.getElementById('destinatario-id');
    mountAutocomplete(cliInput, (q) => `/web/${slug}/notas-fiscais/entidades-autocomplete/?q=${encodeURIComponent(q)}`, (item) => {
      cliInput.value = item.label;
      destId.value = item.value;
    });

    // --- Autocomplete Produto + preencher NCM/Unidade/Preço ---
    const prodInput = document.getElementById('prod-autocomplete');
    const prodCodigoHidden = document.getElementById('produto-codigo');
    const ncmInput = document.getElementById('item-ncm');
    const unInput = document.getElementById('item-unidade');
    const unitInput = document.getElementById('item-unitario');
    mountAutocomplete(prodInput, (q) => `/web/${slug}/notas-fiscais/produtos-autocomplete/?q=${encodeURIComponent(q)}`, async (item) => {
      prodInput.value = item.label;
      prodCodigoHidden.value = item.value;
      try {
        const resp = await authFetch(`/web/${slug}/notas-fiscais/produto-detalhe/${item.value}/`);
        const data = await resp.json();
        ncmInput.value = data?.prod_ncm || ncmInput.value;
        unInput.value = data?.prod_unid || unInput.value;
        const preco = data?.prod_preco_vista || data?.prod_preco_normal || 0;
        if (Number(preco) > 0) unitInput.value = Number(preco).toFixed(2);
      } catch { }
    });

    // --- Autocomplete CFOP + preencher tributos ---
    const cfopInput = document.getElementById('cfop-autocomplete');
    const cstIcms = document.getElementById('cst-icms');
    const cstPis = document.getElementById('cst-pis');
    const cstCof = document.getElementById('cst-cofins');
    const cstIbs = document.getElementById('cst-ibs');
    const cstCbs = document.getElementById('cst-cbs');
    const aliqIcms = document.getElementById('aliq-icms');
    const aliqIpi = document.getElementById('aliq-ipi');
    const aliqPis = document.getElementById('aliq-pis');
    const aliqCof = document.getElementById('aliq-cof');
    const aliqIbs = document.getElementById('aliq-ibs');
    const aliqCbs = document.getElementById('aliq-cbs');
    let cfopFlags = { icms: true, ipi: false, pis_cofins: true, cbs: false, ibs: false };
    mountAutocomplete(cfopInput, (q) => `/web/${slug}/notas-fiscais/cfop-autocomplete/?q=${encodeURIComponent(q)}`, (cf) => {
      document.getElementById('item-cfop').value = cf.value;
      cstIcms.value = cf.cst_icms || '';
      cstPis.value = cf.cst_pis || '';
      cstCof.value = cf.cst_cofins || '';
      cstIbs.value = cf.cst_ibs || '';
      cstCbs.value = cf.cst_cbs || '';
      aliqIcms.value = cf.icms_aliquota || '';
      aliqIpi.value = cf.ipi_aliquota || '';
      aliqPis.value = cf.pis_aliquota || '';
      aliqCof.value = cf.cofins_aliquota || '';
      aliqIbs.value = cf.ibs_aliquota || '';
      aliqCbs.value = cf.cbs_aliquota || '';
      cfopFlags.icms = Boolean(cf.exig_icms ?? true);
      cfopFlags.ipi = Boolean(cf.exig_ipi ?? false);
      cfopFlags.pis_cofins = Boolean(cf.exig_pis_cofins ?? true);
      cfopFlags.cbs = Boolean(cf.exig_cbs ?? false);
      cfopFlags.ibs = Boolean(cf.exig_ibs ?? false);
      calcTotais();
    });

    const transpInput = document.getElementById('transportadora');
    const transpIdHidden = document.getElementById('transportadora-id');
    mountAutocomplete(transpInput, (q) => `/web/${slug}/notas-fiscais/transportadoras-autocomplete/?q=${encodeURIComponent(q)}`, (item) => {
      transpInput.value = item.label;
      transpIdHidden.value = item.value;
    });

    const qtdInput = document.getElementById('item-quantidade');
    const unitInputTot = document.getElementById('item-unitario');
    const descInput = document.getElementById('item-desconto');
    const totalProdutos = document.getElementById('total');
    const totalDesconto = document.getElementById('total-desconto');
    const totalTributos = document.getElementById('total-tributos');
    const totalNota = document.getElementById('total-nota');
    const items = [];
    let backendTotals = null;
    let ultimoDebugCalculo = null;

    const calcTotais = () => {
      const sum = items.reduce((acc, it) => acc + (Number(it.quantidade) * Number(it.unitario) - Number(it.desconto || 0)), 0);
      totalProdutos.value = sum.toFixed(2);
      const totalDesc = items.reduce((acc, it) => acc + Number(it.desconto || 0), 0);
      if (totalDesconto) totalDesconto.value = totalDesc.toFixed(2);
      let vIcms;
      let vIpi;
      let vPis;
      let vCof;
      let vIbs;
      let vCbs;
      if (backendTotals) {
        vIcms = backendTotals.icms;
        vIpi = backendTotals.ipi;
        vPis = backendTotals.pis;
        vCof = backendTotals.cofins;
        vIbs = backendTotals.ibs;
        vCbs = backendTotals.cbs;
      } else {
        const icms = Number(document.getElementById('aliq-icms').value || 0);
        const ipi = Number(document.getElementById('aliq-ipi').value || 0);
        const pis = Number(document.getElementById('aliq-pis').value || 0);
        const cof = Number(document.getElementById('aliq-cof').value || 0);
        const ibs = Number(document.getElementById('aliq-ibs').value || 0);
        const cbs = Number(document.getElementById('aliq-cbs').value || 0);
        const base = sum;
        vIcms = (cfopFlags.icms ? base * icms / 100 : 0);
        vIpi = (cfopFlags.ipi ? base * ipi / 100 : 0);
        vPis = (cfopFlags.pis_cofins ? base * pis / 100 : 0);
        vCof = (cfopFlags.pis_cofins ? base * cof / 100 : 0);
        vIbs = (cfopFlags.ibs ? base * ibs / 100 : 0);
        vCbs = (cfopFlags.cbs ? base * cbs / 100 : 0);
      }
      const trib = vIcms + vIpi + vPis + vCof + vIbs + vCbs;
      if (totalTributos) totalTributos.value = trib.toFixed(2);
      if (totalNota) totalNota.value = (sum + trib).toFixed(2);
      const totIcmsEl = document.getElementById('total-icms');
      const totIpiEl = document.getElementById('total-ipi');
      const totPisEl = document.getElementById('total-pis');
      const totCofEl = document.getElementById('total-cofins');
      const totIbsEl = document.getElementById('total-ibs');
      const totCbsEl = document.getElementById('total-cbs');
      const cfIcmsEl = document.getElementById('cfop-total-icms');
      const cfIpiEl = document.getElementById('cfop-total-ipi');
      const cfPisEl = document.getElementById('cfop-total-pis');
      const cfCofEl = document.getElementById('cfop-total-cofins');
      const cfIbsEl = document.getElementById('cfop-total-ibs');
      const cfCbsEl = document.getElementById('cfop-total-cbs');
      if (totIcmsEl) totIcmsEl.value = vIcms.toFixed(2);
      if (totIpiEl) totIpiEl.value = vIpi.toFixed(2);
      if (totPisEl) totPisEl.value = vPis.toFixed(2);
      if (totCofEl) totCofEl.value = vCof.toFixed(2);
      if (totIbsEl) totIbsEl.value = vIbs.toFixed(2);
      if (totCbsEl) totCbsEl.value = vCbs.toFixed(2);
      if (cfIcmsEl) cfIcmsEl.value = vIcms.toFixed(2);
      if (cfIpiEl) cfIpiEl.value = vIpi.toFixed(2);
      if (cfPisEl) cfPisEl.value = vPis.toFixed(2);
      if (cfCofEl) cfCofEl.value = vCof.toFixed(2);
      if (cfIbsEl) cfIbsEl.value = vIbs.toFixed(2);
      if (cfCbsEl) cfCbsEl.value = vCbs.toFixed(2);
    };

    [aliqIcms, aliqIpi, aliqPis, aliqCof, aliqIbs, aliqCbs].forEach(el => { el.addEventListener('input', calcTotais); });
    calcTotais();

    const itemsTableBody = document.querySelector('#items-table tbody');
    let editIndex = -1;
    const preencherBackendDaNota = (payload) => {
      const nota = payload || {};
      const debug = payload && payload.debug_calculo ? payload.debug_calculo : null;
      ultimoDebugCalculo = debug;
      const debugMap = {};
      if (debug && Array.isArray(debug.itens)) {
        debug.itens.forEach(di => {
          if (di && di.id != null) {
            debugMap[String(di.id)] = di;
          }
        });
      }
      if (!nota || !Array.isArray(nota.itens)) {
        backendTotals = null;
        return;
      }
      let totProd = 0;
      let totDesc = 0;
      let totIcms = 0;
      let totIpi = 0;
      let totPis = 0;
      let totCof = 0;
      let totCbs = 0;
      let totIbs = 0;
      nota.itens.forEach((itBackend, idx) => {
        const qtd = Number(itBackend.quantidade || 0);
        const unit = Number(itBackend.unitario || 0);
        const desc = Number(itBackend.desconto || 0);
        const linhaTotal = qtd * unit - desc;
        totProd += linhaTotal;
        totDesc += desc;
        const imp = itBackend.impostos || {};
        totIcms += Number(imp.icms_valor || 0);
        totIpi += Number(imp.ipi_valor || 0);
        totPis += Number(imp.pis_valor || 0);
        totCof += Number(imp.cofins_valor || 0);
        totCbs += Number(imp.cbs_valor || 0);
        totIbs += Number(imp.ibs_valor || 0);
        if (items[idx]) {
          items[idx] = {
            ...items[idx],
            fonte_tributacao: itBackend.fonte_tributacao || items[idx].fonte_tributacao,
            debug_calculo: debugMap[String(itBackend.id)] || items[idx].debug_calculo,
          };
        }
      });
      backendTotals = {
        produtos: totProd,
        desconto: totDesc,
        icms: totIcms,
        ipi: totIpi,
        pis: totPis,
        cofins: totCof,
        cbs: totCbs,
        ibs: totIbs,
      };
      if (totalProdutos) totalProdutos.value = totProd.toFixed(2);
      if (totalDesconto) totalDesconto.value = totDesc.toFixed(2);
      const trib = totIcms + totIpi + totPis + totCof + totCbs + totIbs;
      if (totalTributos) totalTributos.value = trib.toFixed(2);
      if (totalNota) totalNota.value = (totProd + trib).toFixed(2);
      const totIcmsEl = document.getElementById('total-icms');
      const totIpiEl = document.getElementById('total-ipi');
      const totPisEl = document.getElementById('total-pis');
      const totCofEl = document.getElementById('total-cofins');
      const totIbsEl = document.getElementById('total-ibs');
      const totCbsEl = document.getElementById('total-cbs');
      const cfIcmsEl = document.getElementById('cfop-total-icms');
      const cfIpiEl = document.getElementById('cfop-total-ipi');
      const cfPisEl = document.getElementById('cfop-total-pis');
      const cfCofEl = document.getElementById('cfop-total-cofins');
      const cfIbsEl = document.getElementById('cfop-total-ibs');
      const cfCbsEl = document.getElementById('cfop-total-cbs');
      if (totIcmsEl) totIcmsEl.value = totIcms.toFixed(2);
      if (totIpiEl) totIpiEl.value = totIpi.toFixed(2);
      if (totPisEl) totPisEl.value = totPis.toFixed(2);
      if (totCofEl) totCofEl.value = totCof.toFixed(2);
      if (totIbsEl) totIbsEl.value = totIbs.toFixed(2);
      if (totCbsEl) totCbsEl.value = totCbs.toFixed(2);
      if (cfIcmsEl) cfIcmsEl.value = totIcms.toFixed(2);
      if (cfIpiEl) cfIpiEl.value = totIpi.toFixed(2);
      if (cfPisEl) cfPisEl.value = totPis.toFixed(2);
      if (cfCofEl) cfCofEl.value = totCof.toFixed(2);
      if (cfIbsEl) cfIbsEl.value = totIbs.toFixed(2);
      if (cfCbsEl) cfCbsEl.value = totCbs.toFixed(2);
    };

    const renderItems = () => {
      itemsTableBody.innerHTML = '';
      items.forEach((it, idx) => {
        const tr = document.createElement('tr');
        const total = (Number(it.quantidade) * Number(it.unitario) - Number(it.desconto || 0)).toFixed(2);
        tr.innerHTML = `
          <td>${it.descricao || ''}</td>
          <td>${it.quantidade}</td>
          <td>${Number(it.unitario).toFixed(2)}</td>
          <td>${Number(it.desconto || 0).toFixed(2)}</td>
          <td>${it.cfop}</td>
          <td>${it.ncm}</td>
          <td>${total}</td>
          <td>${it.fonte_tributacao || '-'}</td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-edit="${idx}"><i class="bi bi-pencil"></i></button>
            <button type="button" class="btn btn-sm btn-outline-info" data-debug="${idx}"><i class="bi bi-search"></i></button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-remove="${idx}"><i class="bi bi-trash"></i></button>
          </td>`;
        itemsTableBody.appendChild(tr);
      });
      calcTotais();
    };

    document.getElementById('btn-add-item').addEventListener('click', () => {
      const codigo = document.getElementById('produto-codigo').value || '';
      const descricao = document.getElementById('prod-autocomplete').value || '';
      const ncm = document.getElementById('item-ncm').value || '00000000';
      const cfop = document.getElementById('item-cfop').value || '5102';
      const unidade = document.getElementById('item-unidade').value || 'UN';
      const quantidade = Number(document.getElementById('item-quantidade').value || 0);
      const unitario = Number(document.getElementById('item-unitario').value || 0);
      const desconto = Number(document.getElementById('item-desconto').value || 0);
      if (!codigo) { showToast('Selecione o produto.', { variant: 'warning' }); return; }
      if (quantidade <= 0 || unitario <= 0) { showToast('Quantidade e unitário devem ser maiores que zero.', { variant: 'warning' }); return; }
      const obj = { codigo, descricao, ncm, cfop, unidade, quantidade, unitario, desconto };
      if (editIndex >= 0) { items[editIndex] = obj; editIndex = -1; } else { items.push(obj); }
      renderItems();
      document.getElementById('produto-codigo').value = '';
      document.getElementById('prod-autocomplete').value = '';
      document.getElementById('item-quantidade').value = '1';
      document.getElementById('item-unitario').value = '0';
      document.getElementById('item-desconto').value = '0';
    });

    const modalItemCalculoEl = document.getElementById('modal-item-calculo');
    const modalItemCalculoBody = document.getElementById('modal-item-calculo-body');
    const modalItemCalculo = modalItemCalculoEl && typeof bootstrap !== 'undefined' ? new bootstrap.Modal(modalItemCalculoEl) : null;

    const abrirModalCalculoItem = (it, debugItem) => {
      if (!modalItemCalculo || !modalItemCalculoBody) return;
      const bases = debugItem && debugItem.bases ? debugItem.bases : {};
      const aliq = debugItem && debugItem.aliquotas ? debugItem.aliquotas : {};
      const vals = debugItem && debugItem.valores_calculados ? debugItem.valores_calculados : {};
      const csts = debugItem && debugItem.csts ? debugItem.csts : {};
      const cond = debugItem && debugItem.condicionais_aplicadas ? debugItem.condicionais_aplicadas : {};
      modalItemCalculoBody.innerHTML = `
        <div class="mb-2"><strong>Produto:</strong> ${it.descricao || ''}</div>
        <div class="mb-2"><strong>Quantidade:</strong> ${it.quantidade}</div>
        <div class="mb-2"><strong>Unitário:</strong> ${Number(it.unitario).toFixed(2)}</div>
        <div class="mb-2"><strong>Desconto:</strong> ${Number(it.desconto || 0).toFixed(2)}</div>
        <div class="mb-2"><strong>CFOP:</strong> ${it.cfop || ''}</div>
        <div class="mb-2"><strong>NCM:</strong> ${it.ncm || ''}</div>
        <div class="mb-2"><strong>Fonte da tributação:</strong> ${debugItem && debugItem.fonte_tributacao ? debugItem.fonte_tributacao : (it.fonte_tributacao || '-')}</div>
        <div class="mb-2"><strong>CFOP resolvido:</strong> ${debugItem && debugItem.cfop_resolvido ? debugItem.cfop_resolvido : '-'}</div>
        <div class="mb-2"><strong>NCM resolvido:</strong> ${debugItem && debugItem.ncm_resolvido ? debugItem.ncm_resolvido : '-'}</div>
        <hr>
        <h6>Bases</h6>
        <div class="row g-2 mb-2">
          <div class="col-4"><strong>Base raiz:</strong> ${bases.raiz || '-'}</div>
          <div class="col-4"><strong>Base ICMS:</strong> ${bases.icms || '-'}</div>
          <div class="col-4"><strong>Base ST:</strong> ${bases.st || '-'}</div>
        </div>
        <h6>Alíquotas</h6>
        <div class="row g-2 mb-2">
          <div class="col-4"><strong>ICMS %:</strong> ${aliq.icms || '-'}</div>
          <div class="col-4"><strong>IPI %:</strong> ${aliq.ipi || '-'}</div>
          <div class="col-4"><strong>PIS %:</strong> ${aliq.pis || '-'}</div>
          <div class="col-4"><strong>COFINS %:</strong> ${aliq.cofins || '-'}</div>
          <div class="col-4"><strong>CBS %:</strong> ${aliq.cbs || '-'}</div>
          <div class="col-4"><strong>IBS %:</strong> ${aliq.ibs || '-'}</div>
        </div>
        <h6>Valores calculados</h6>
        <div class="row g-2 mb-2">
          <div class="col-4"><strong>ICMS R$:</strong> ${vals.icms || '0.00'}</div>
          <div class="col-4"><strong>IPI R$:</strong> ${vals.ipi || '0.00'}</div>
          <div class="col-4"><strong>PIS R$:</strong> ${vals.pis || '0.00'}</div>
          <div class="col-4"><strong>COFINS R$:</strong> ${vals.cofins || '0.00'}</div>
          <div class="col-4"><strong>CBS R$:</strong> ${vals.cbs || '0.00'}</div>
          <div class="col-4"><strong>IBS R$:</strong> ${vals.ibs || '0.00'}</div>
        </div>
        <h6>CSTs</h6>
        <div class="row g-2 mb-2">
          <div class="col-4"><strong>CST ICMS:</strong> ${csts.icms || '-'}</div>
          <div class="col-4"><strong>CST PIS:</strong> ${csts.pis || '-'}</div>
          <div class="col-4"><strong>CST COFINS:</strong> ${csts.cofins || '-'}</div>
          <div class="col-4"><strong>CST IBS:</strong> ${csts.ibs || '-'}</div>
          <div class="col-4"><strong>CST CBS:</strong> ${csts.cbs || '-'}</div>
        </div>
        <h6>Condições aplicadas (CFOP)</h6>
        <div class="row g-2 mb-2">
          <div class="col-4"><strong>ICMS habilitado:</strong> ${String(cond.icms_habilitado_cfop)}</div>
          <div class="col-4"><strong>IPI habilitado:</strong> ${String(cond.ipi_habilitado_cfop)}</div>
          <div class="col-4"><strong>PIS/COFINS habilitado:</strong> ${String(cond.pis_cofins_habilitado_cfop)}</div>
          <div class="col-4"><strong>CBS habilitado:</strong> ${String(cond.cbs_habilitado_cfop)}</div>
          <div class="col-4"><strong>IBS habilitado:</strong> ${String(cond.ibs_habilitado_cfop)}</div>
        </div>
      `;
      modalItemCalculo.show();
    };

    itemsTableBody.addEventListener('click', (ev) => {
      const editBtn = ev.target.closest('[data-edit]');
      const rmBtn = ev.target.closest('[data-remove]');
      const dbgBtn = ev.target.closest('[data-debug]');
      if (editBtn) {
        const idx = Number(editBtn.getAttribute('data-edit'));
        const it = items[idx];
        editIndex = idx;
        document.getElementById('produto-codigo').value = it.codigo;
        document.getElementById('prod-autocomplete').value = it.descricao;
        document.getElementById('item-ncm').value = it.ncm;
        document.getElementById('item-cfop').value = it.cfop;
        document.getElementById('item-unidade').value = it.unidade;
        document.getElementById('item-quantidade').value = String(it.quantidade);
        document.getElementById('item-unitario').value = String(it.unitario);
        document.getElementById('item-desconto').value = String(it.desconto || 0);
      }
      if (dbgBtn) {
        const idx = Number(dbgBtn.getAttribute('data-debug'));
        const it = items[idx];
        if (!it || !it.debug_calculo) {
          showToast('Cálculo ainda não está disponível para este item.', { variant: 'warning' });
          return;
        }
        abrirModalCalculoItem(it, it.debug_calculo);
      }
      if (rmBtn) {
        const idx = Number(rmBtn.getAttribute('data-remove'));
        items.splice(idx, 1);
        renderItems();
      }
    });

    const criarNota = async (body) => {
      const resp = await authFetch(`/api/${slug}/notasfiscais/notas-fiscais/notas/`, { method: 'POST', body: JSON.stringify(body) });
      const created = await resp.json();
      return { ok: resp.ok, data: created };
    };

    const gravarNota = async (id) => {
      const resp = await authFetch(`/api/${slug}/notasfiscais/notas-fiscais/notas/${id}/gravar/`, { method: 'POST', body: JSON.stringify({ descricao: 'Rascunho via WEB' }) });
      const data = await resp.json();
      return { ok: resp.ok, data };
    };

    const montarPayload = (fd) => {
      const payload = {
        modelo: String(Number(fd.get('modelo') || 55)),
        serie: String(Number(fd.get('serie') || 1)),
        numero: Number(fd.get('numero') || 0),
        data_emissao: fd.get('data_emissao') || null,
        data_saida: fd.get('data_saida') || fd.get('data_emissao') || null,
        tipo_operacao: 1,
        finalidade: 1,
        ambiente: 2,
        destinatario: Number(document.getElementById('destinatario-id').value || 0),
        itens: items.map(it => ({
          produto: Number(it.codigo || 0),
          quantidade: Number(it.quantidade || 0),
          unitario: Number(it.unitario || 0),
          desconto: Number(it.desconto || 0),
          cfop: it.cfop || '5102',
          ncm: it.ncm || '00000000',
          cest: '',
          cst_icms: document.getElementById('cst-icms').value || '102',
          cst_pis: document.getElementById('cst-pis').value || '49',
          cst_cofins: document.getElementById('cst-cofins').value || '49',
          cst_ibs: document.getElementById('cst-ibs').value || '',
          cst_cbs: document.getElementById('cst-cbs').value || '',
        })),
        impostos: items.map(() => ({
          icms_aliquota: Number(document.getElementById('aliq-icms').value || 0),
          ibs_aliquota: Number(document.getElementById('aliq-ibs').value || 0),
          cbs_aliquota: Number(document.getElementById('aliq-cbs').value || 0),
        })),
        transporte: {
          modalidade_frete: Number(document.getElementById('transporte-modalidade').value || 0),
          transportadora: Number(document.getElementById('transportadora-id').value || 0) || null,
          placa_veiculo: '',
          uf_veiculo: '',
        },
      };
      console.log("mostrar payload:", payload);
      return payload;
    };

    const btnSalvar = document.getElementById('btn-salvar');
    btnSalvar.addEventListener('click', async () => {
      const fd = new FormData(document.getElementById('emit-form'));
      const destinatarioId = document.getElementById('destinatario-id').value;
      if (!destinatarioId) { showToast('Selecione o cliente na aba Cliente.', { variant: 'warning' }); return; }
      if (!items.length) { showToast('Adicione ao menos um item.', { variant: 'warning' }); return; }
      const sp = btnSalvar.querySelector('.spinner-border'); btnSalvar.disabled = true; if (sp) sp.classList.remove('d-none');
      const payload = montarPayload(fd);
      const created = await criarNota(payload);
      if (!created.ok) { showToast('Falha ao salvar: ' + (created.data?.detail || created.data?.motivo || 'Erro'), { variant: 'danger', delay: 4000 }); btnSalvar.disabled = false; if (sp) sp.classList.add('d-none'); return; }
      const notaId = created.data?.id || created.data?.pk || created.data?.nota?.id;
      if (!notaId) { showToast('Nota criada, porém ID não retornado.', { variant: 'warning' }); btnSalvar.disabled = false; if (sp) sp.classList.add('d-none'); return; }
      try {
        preencherBackendDaNota(created.data);
        renderItems();
      } catch (e) { }
      const grav = await gravarNota(notaId);
      if (!grav.ok) { showToast('Falha ao gravar rascunho: ' + (grav.data?.detail || 'Erro'), { variant: 'danger', delay: 4000 }); btnSalvar.disabled = false; if (sp) sp.classList.add('d-none'); return; }
      window.location.href = `/web/${slug}/notas-fiscais/`;
      btnSalvar.disabled = false; if (sp) sp.classList.add('d-none');
    });

    const formEl = document.getElementById('emit-form');
    formEl.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const fd = new FormData(ev.target);
      const dados_nfe = {
        numero: Number(fd.get('numero') || 0),
        serie: Number(fd.get('serie') || 1),
        natureza_operacao: fd.get('natureza_operacao') || 'Venda de mercadoria',
        modelo: Number(fd.get('modelo') || 55),
        data_emissao: fd.get('data_emissao') || null,
        data_saida_entrada: fd.get('data_saida') || fd.get('data_emissao') || null,
        tipo_documento: 1,
        forma_pagamento: 0,
        tipo_pagamento: 1,
        empresa: Number(empresa),
        filial: Number(filial),
      };
      const destinatarioId = document.getElementById('destinatario-id').value;
      if (!destinatarioId) { showToast('Selecione o cliente na aba Cliente.', { variant: 'warning' }); return; }
      if (!items.length) { showToast('Adicione ao menos um item.', { variant: 'warning' }); return; }
      const impostos = [{
        icms_aliquota: Number(document.getElementById('aliq-icms').value || 0),
        ipi_valor: null,
        pis_valor: null,
        cofins_valor: null,
      }];
      try {
        const btnSubmit = formEl.querySelector('button[type="submit"]');
        const sp = btnSubmit?.querySelector('.spinner-border');
        if (btnSubmit) { btnSubmit.disabled = true; if (sp) sp.classList.remove('d-none'); }
        const payload = montarPayload(fd);
        const created = await criarNota(payload);
        if (!created.ok) {
          showToast('Falha na criação: ' + (created.data?.detail || created.data?.motivo || created.data?.erro || 'Erro'), { variant: 'danger', delay: 4000 });
          if (btnSubmit) { btnSubmit.disabled = false; if (sp) sp.classList.add('d-none'); }
          return;
        }
        const notaId = created.data?.id || created.data?.pk || created.data?.nota?.id;
        if (!notaId) {
          showToast('Nota criada, porém ID não retornado.', { variant: 'warning' });
          if (btnSubmit) { btnSubmit.disabled = false; if (sp) sp.classList.add('d-none'); }
          return;
        }
        try {
          preencherBackendDaNota(created.data);
          renderItems();
        } catch (e) { }
        await gravarNota(notaId);
        const respEmit = await authFetch(`/api/emitir/${slug}/${notaId}/`, { method: 'GET' });
        const dataEmit = await respEmit.json();
        if (respEmit.ok) {
          showToast('Emitida com sucesso. Chave: ' + (dataEmit?.chave || dataEmit?.chave_acesso || ''), { variant: 'success' });
          window.location.href = `/web/${slug}/notas-fiscais/`;
        } else {
          const rawError =
            dataEmit?.detail ||
            dataEmit?.detalhes ||
            dataEmit?.mensagem ||
            dataEmit?.motivo ||
            dataEmit?.erro ||
            dataEmit?.error ||
            (typeof dataEmit === 'string' ? dataEmit : '') ||
            (dataEmit ? JSON.stringify(dataEmit) : '');
          showToast('Falha na emissão: ' + (rawError || 'Erro'), { variant: 'danger', delay: 4000 });
        }
      } catch (e) {
        showToast('Erro: ' + e, { variant: 'danger', delay: 4000 });
      } finally {
        if (btnSubmit) { btnSubmit.disabled = false; if (sp) sp.classList.add('d-none'); }
      }
    });
  })();
</script>
{% endblock %}