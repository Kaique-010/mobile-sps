{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<style>
    .config-banco-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card-header-custom {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
    }

    .card-header-custom h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-header-custom small {
        opacity: 0.9;
        font-size: 0.9rem;
        display: block;
        margin-top: 0.5rem;
    }

    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #2c3e50;
    }

    .form-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-label.required::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.15);
    }

    .form-select-lg {
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        transition: all 0.2s;
    }

    .form-select-lg:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.3rem rgba(44, 62, 80, 0.15);
    }

    .field-hint {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
        display: block;
        font-style: italic;
    }

    .text-danger {
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .btn-action-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-start;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #dee2e6;
    }

    #btnSalvarConta {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
        color: white;
        padding: 0.75rem 2.5rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(39, 174, 96, 0.3);
    }

    #btnSalvarConta:hover {
        background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(39, 174, 96, 0.4);
    }

    .btn-secondary-custom {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-secondary-custom:hover {
        background: #5a6268;
        transform: translateY(-1px);
        color: white;
    }

    .info-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 5px solid #2196f3;
        padding: 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .info-card-title {
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-card ul {
        margin: 0;
        padding-left: 1.5rem;
        color: #424242;
    }

    .info-card ul li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    /* Badge para o select de banco */
    .banco-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #2c3e50;
        color: white;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* Inputs numéricos alinhados à direita */
    input[inputmode="numeric"] {
        text-align: right;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        letter-spacing: 1px;
    }

    /* Conta formatada visualmente */
    .conta-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: #e9ecef;
        border-radius: 0.375rem;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .conta-display span {
        color: #6c757d;
    }

    /* Estado com badge */
    .uf-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: #e9ecef;
        border-radius: 0.25rem;
        font-weight: 700;
        text-align: center;
    }

    @media (max-width: 768px) {
        .btn-action-group {
            flex-direction: column;
        }

        .btn-action-group .btn {
            width: 100%;
        }

        .form-section {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'css/form.css' %}">
<style>
    #btnSalvarConta {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
        color: white;
        padding: 0.75rem 2.5rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(39, 174, 96, 0.3);
    }

    #btnSalvarConta:hover {
        background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(39, 174, 96, 0.4);
    }

    .btn-secondary-custom {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-secondary-custom:hover {
        background: #5a6268;
        transform: translateY(-1px);
        color: white;
    }
</style>
<div class="container">
    <div class="card shadow">
        <h3 class="card-title mb-4 fs-4  text-center">
            {% if entidade.enti_clie %}
            <i class="bi bi-pencil-square"></i> Editar Conta Bancária
            {% else %}
            <i class="bi bi-plus-circle-fill"></i> Nova Conta Bancária
            {% endif %}
        </h3>
        <small>
            {% if entidade.enti_nome %}
            {{ entidade.enti_nome }}
            {% else %}

            {% endif %}
        </small>
    </div>



    <form method="post" id="bancoConfigForm" novalidate>
        {% csrf_token %}

        <!-- Seção: Seleção do Banco -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-bank2"></i> Seleção do Banco
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label required">
                        {{ form.codigo_banco.label }}
                    </label>
                    {{ form.codigo_banco }}
                    <span class="field-hint">Selecione o banco na lista acima</span>
                    {% if form.codigo_banco.errors %}
                    <div class="text-danger">
                        {{ form.codigo_banco.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Seção: Identificação da Conta -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-card-text"></i> Identificação da Conta
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label {% if form.enti_nome.field.required %}required{% endif %}">
                        {{ form.enti_nome.label }}
                    </label>
                    {{ form.enti_nome }}
                    <span class="field-hint">Nome para identificar esta conta no sistema</span>
                    {% if form.enti_nome.errors %}
                    <div class="text-danger">
                        {{ form.enti_nome.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label {% if form.enti_fant.field.required %}required{% endif %}">
                        {{ form.enti_fant.label }}
                    </label>
                    {{ form.enti_fant }}
                    <span class="field-hint">Apelido curto para facilitar visualização</span>
                    {% if form.enti_fant.errors %}
                    <div class="text-danger">
                        {{ form.enti_fant.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="bancoTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-dados" data-bs-toggle="tab" data-target="#pane-dados-conta"
                    type="button" role="tab">Dados Bancários</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-carteiras" data-bs-toggle="tab" data-target="#pane-carteiras"
                    type="button" role="tab">Carteiras</button>
            </li>
        </ul>

        <!-- Seção: Dados da Conta -->
        <div class="form-section tab-pane active" id="pane-dados-conta" role="tabpanel">
            <div class="form-section-title">
                <i class="bi bi-hash"></i> Dados da Conta Bancária
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label {% if form.enti_agen.field.required %}required{% endif %}">
                        {{ form.enti_agen.label }}
                    </label>
                    {{ form.enti_agen }}
                    <span class="field-hint">Apenas números</span>
                    {% if form.enti_agen.errors %}
                    <div class="text-danger">
                        {{ form.enti_agen.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label {% if form.enti_diag.field.required %}required{% endif %}">
                        {{ form.enti_diag.label }}
                    </label>
                    {{ form.enti_diag }}
                    <span class="field-hint">DV (opcional)</span>
                    {% if form.enti_diag.errors %}
                    <div class="text-danger">
                        {{ form.enti_diag.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <label class="form-label {% if form.enti_coco.field.required %}required{% endif %}">
                        {{ form.enti_coco.label }}
                    </label>
                    {{ form.enti_coco }}
                    <span class="field-hint">Número da conta sem DV</span>
                    {% if form.enti_coco.errors %}
                    <div class="text-danger">
                        {{ form.enti_coco.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label {% if form.enti_dico.field.required %}required{% endif %}">
                        {{ form.enti_dico.label }}
                    </label>
                    {{ form.enti_dico }}
                    <span class="field-hint">DV obrigatório</span>
                    {% if form.enti_dico.errors %}
                    <div class="text-danger">
                        {{ form.enti_dico.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label {% if form.enti_tien.field.required %}required{% endif %}">
                        {{ form.enti_tien.label }}
                    </label>
                    {{ form.enti_tien }}
                    {% if form.enti_tien.errors %}
                    <div class="text-danger">
                        {{ form.enti_tien.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label">
                        {{ form.logo_variation.label }}
                    </label>
                    {{ form.logo_variation }}
                    <span class="field-hint">Preferência de exibição do logo</span>
                </div>

                <!-- Preview da conta formatada -->
                <div class="col-12">
                    <div class="conta-display" id="contaPreview" style="display: none;">
                        <strong>Conta completa:</strong>
                        <span>Ag:</span> <span id="previewAg">----</span>
                        <span>C/C:</span> <span id="previewConta">--------</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section tab-pane" id="pane-carteiras" role="tabpanel" style="display:none;"
            data-entidade-id="{% if entidade and entidade.enti_clie %}{{ entidade.enti_clie }}{% endif %}">
            <div class="form-section-title">
                <i class="bi bi-card-checklist"></i> Carteiras
            </div>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Código da Carteira</label>
                    <input type="number" class="form-control" id="carteiraCodigo" name="cart_codi" placeholder="Código">
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-outline-secondary" id="btnCarteiraProximo">Próximo
                        Código</button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-outline-info" id="btnCarteiraBuscar">Buscar</button>
                </div>

            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label class="form-label required">Nome</label>
                    <input type="text" class="form-control" id="carteiraNome" name="cart_nome"
                        placeholder="Nome da carteira">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Convênio</label>
                    <input type="text" class="form-control" id="carteiraConvenio" name="cart_conv">
                </div>
                <div class="col-md-2">
                    <label class="form-label required">Carteira</label>
                    <input type="text" class="form-control" id="carteiraNumero" name="cart_cart"
                        placeholder="Nº Carteira">
                </div>
                <div class="col-md-2">
                    <label class="form-label">CNAB</label>
                    <select class="form-select" id="carteiraCnab" name="cart_cnab">
                        {% for value, label in CNAB_CHOICES %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Código Transmissão</label>
                    <input type="text" class="form-control" id="carteiraCodigoTrans" name="cart_codi_tran"
                        placeholder="Código Transmissão">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Código Cedente</label>
                    <input type="text" class="form-control" id="carteiraCodigoCedente" name="cart_codi_cede"
                        placeholder="Código Cedente">
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Nosso Número</label>
                    <input type="text" class="form-control" id="carteiraNossoNumero" name="cart_noss_nume"
                        placeholder="Nosso Número">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Multa %</label>
                    <input type="number" class="form-control" id="carteiraMulta" name="cart_mult" step="0.01"
                        placeholder="Multa %">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Juro %</label>
                    <input type="number" class="form-control" id="carteiraJuro" name="cart_juro" step="0.001"
                        placeholder="Juro %">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Desconto %</label>
                    <input type="number" class="form-control" id="carteiraDesconto" name="cart_desc" step="0.01"
                        placeholder="Desconto %">
                </div>
                <div class="col-md-9">
                    <label class="form-label">Mensagem de Envio</label>
                    <input type="text" class="form-control" id="carteiraMensLocacao" name="cart_mens_loca"
                        placeholder="Mensagem de Envio">
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label class="form-label">Espécie</label>
                    <input type="text" class="form-control" id="carteiraEspecie" name="cart_espe"
                        placeholder="Espécie Ex DMI">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Moeda</label>
                    <input type="text" class="form-control" id="carteiraMoeda" name="cart_espe_moed"
                        placeholder="Moeda Ex BRL">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Aceite</label>
                    <input type="number" class="form-control" id="carteiraAceite" name="cart_acei"
                        placeholder="Aceite S/N">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Nº Arquivo</label>
                    <input type="number" class="form-control" id="carteiraNumArquivo" name="cart_nume_arqu"
                        placeholder="Nº do arquivo gerado">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Boleto</label>
                    <input type="number" class="form-control" id="carteiraBoleto" name="cart_bole"
                        placeholder="Nº Boleto">
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Tipo Documento</label>
                    <input type="number" class="form-control" id="carteiraTipoDoc" name="cart_tipo_docu"
                        placeholder="Tipo Documento">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Baixa</label>
                    <input type="number" class="form-control" id="carteiraBaixa" name="cart_baix" placeholder="Baixa">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Protesto</label>
                    <input type="number" class="form-control" id="carteiraProtesto" name="cart_prot"
                        placeholder="Protesto">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Negociação</label>
                    <input type="text" class="form-control" id="carteiraNegoc" name="cart_nega"
                        placeholder="Negativação">
                </div>
            </div>


            <div class="form-section-title mt-4">
                <i class="bi bi-globe2"></i> WebServices
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">ClientID</label>
                    <input type="text" class="form-control" id="websClientId" name="cart_webs_clie_id">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ClientSecret</label>
                    <input type="text" class="form-control" id="websClientSecret" name="cart_webs_clie_secr">
                </div>
                <div class="col-md-3">
                    <label class="form-label">KeyUser</label>
                    <input type="text" class="form-control" id="websKeyUser" name="cart_webs_user_key">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Scope</label>
                    <input type="text" class="form-control" id="websScope" name="cart_webs_scop">
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="websPix" name="cart_webs_indi_pix">
                        <label class="form-check-label" for="websPix">Indicador de Pix</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Chave PIX</label>
                    <input type="text" class="form-control" id="websChavePix" name="cart_webs_chav_pix">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Arquivo CRT</label>
                    <input type="text" class="form-control" id="websCrt" name="cart_webs_crt"
                        placeholder="caminho/arquivo.crt">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Arquivo Key</label>
                    <input type="text" class="form-control" id="websKey" name="cart_webs_key"
                        placeholder="caminho/arquivo.key">
                </div>
            </div>
            <div class="mt-3 d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" id="btnCarteiraSalvar">Salvar Carteira</button>
            </div>
        </div>

        <!-- Seção: Endereço (Opcional) -->
        <div class="form-section" id="pane-endereco">
            <div class="form-section-title">
                <i class="bi bi-geo-alt-fill"></i> Endereço <small class="text-muted">(opcional)</small>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">
                        {{ form.enti_cep.label }}
                    </label>
                    {{ form.enti_cep }}
                    <span class="field-hint">Somente números, 8 dígitos</span>
                    {% if form.enti_cep.errors %}
                    <div class="text-danger">
                        {{ form.enti_cep.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-7">
                    <label class="form-label">
                        {{ form.enti_ende.label }}
                    </label>
                    {{ form.enti_ende }}
                    {% if form.enti_ende.errors %}
                    <div class="text-danger">
                        {{ form.enti_ende.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label">
                        {{ form.enti_nume.label }}
                    </label>
                    {{ form.enti_nume }}
                    {% if form.enti_nume.errors %}
                    <div class="text-danger">
                        {{ form.enti_nume.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-8">
                    <label class="form-label">
                        {{ form.enti_cida.label }}
                    </label>
                    {{ form.enti_cida }}
                    {% if form.enti_cida.errors %}
                    <div class="text-danger">
                        {{ form.enti_cida.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">
                        {{ form.enti_esta.label }}
                    </label>
                    {{ form.enti_esta }}
                    {% if form.enti_esta.errors %}
                    <div class="text-danger">
                        {{ form.enti_esta.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="btn-action-group">
            <button class="btn btn-primary-custom" id="btnSalvarConta" type="submit">
                <i class="bi bi-check-circle-fill"></i>
                {% if entidade.enti_clie %}
                Salvar Alterações
                {% else %}
                Cadastrar Conta
                {% endif %}
            </button>
            <a class="btn btn-secondary-custom" href="{% url 'banco_config_list' slug=slug %}">
                <i class="bi bi-arrow-left-circle-fill"></i> Cancelar
            </a>
        </div>
    </form>
</div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const cepInput = document.querySelector('[name="enti_cep"]');
    if (cepInput) {
        cepInput.addEventListener('input', function (e) {
            let v = e.target.value.replace(/\D/g, '').slice(0, 8);
            e.target.value = v;
        });
    }

    // Forçar maiúsculas no campo UF
    const ufInput = document.querySelector('[name="enti_esta"]');
    if (ufInput) {
        ufInput.addEventListener('input', function (e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }

    // Preview da conta formatada
    function atualizarPreview() {
        const agencia = document.querySelector('[name="enti_agen"]').value;
        const digAg = document.querySelector('[name="enti_diag"]').value;
        const conta = document.querySelector('[name="enti_coco"]').value;
        const digConta = document.querySelector('[name="enti_dico"]').value;

        const preview = document.getElementById('contaPreview');
        const previewAg = document.getElementById('previewAg');
        const previewConta = document.getElementById('previewConta');

        if (agencia || conta) {
            preview.style.display = 'flex';

            // Formatar agência
            if (agencia) {
                previewAg.textContent = digAg ? `${agencia}-${digAg}` : agencia;
            } else {
                previewAg.textContent = '----';
            }

            // Formatar conta
            if (conta) {
                previewConta.textContent = digConta ? `${conta}-${digConta}` : conta;
            } else {
                previewConta.textContent = '--------';
            }
        } else {
            preview.style.display = 'none';
        }
    }

    // Atualizar preview em tempo real
    ['enti_agen', 'enti_diag', 'enti_coco', 'enti_dico'].forEach(name => {
        const input = document.querySelector(`[name="${name}"]`);
        if (input) {
            input.addEventListener('input', atualizarPreview);
            input.addEventListener('blur', atualizarPreview);
        }
    });

    // Executar preview inicial
    atualizarPreview();

    // Validação visual do select de banco
    const bancoSelect = document.querySelector('[name="codigo_banco"]');
    if (bancoSelect) {
        bancoSelect.addEventListener('change', function (e) {
            if (e.target.value) {
                e.target.classList.add('is-valid');
                e.target.classList.remove('is-invalid');
            } else {
                e.target.classList.remove('is-valid');
            }
        });
    }

    const formEl = document.getElementById('bancoConfigForm');
    if (formEl) {
        formEl.addEventListener('submit', function (e) {
            e.preventDefault();
            const submitBtn = document.getElementById('btnSalvarConta');
            const originalBtnHtml = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Salvando…';
            }
            const fd = new FormData(formEl);
            Array.from(formEl.querySelectorAll('[data-field-error="1"]')).forEach(function (el) { el.remove(); });
            Array.from(formEl.querySelectorAll('.is-invalid')).forEach(function (el) { el.classList.remove('is-invalid'); });
            fetch(window.location.href, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
            }).then(async function (res) {
                try {
                    const data = await res.json();
                    if (res.ok && data && data.ok) {
                        if (window.showToast) window.showToast('Configuração salva com sucesso', { variant: 'success', delay: 1500 });
                        const cancelLink = document.querySelector('.btn.btn-secondary-custom');
                        const target = cancelLink ? cancelLink.getAttribute('href') : window.location.pathname;
                        setTimeout(function () { window.location.href = target; }, 1500);
                    } else {
                        if (data && data.errors) {
                            const entries = Object.entries(data.errors);
                            entries.forEach(function ([name, messages]) {
                                const field = formEl.querySelector('[name="' + name + '"]');
                                if (field) {
                                    field.classList.add('is-invalid');
                                    const msg = Array.isArray(messages) ? messages.join(' ') : String(messages);
                                    const div = document.createElement('div');
                                    div.className = 'text-danger';
                                    div.setAttribute('data-field-error', '1');
                                    div.textContent = msg;
                                    field.insertAdjacentElement('afterend', div);
                                }
                            });
                        }
                        if (window.showToast) window.showToast('Erro ao salvar configuração', { variant: 'danger', delay: 3000 });
                    }
                } catch (_) {
                    if (window.showToast) window.showToast('Falha ao processar resposta', { variant: 'warning', delay: 3000 });
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            }).catch(function () {
                if (window.showToast) window.showToast('Falha na comunicação com o servidor', { variant: 'danger', delay: 3000 });
                const submitBtn = document.getElementById('btnSalvarConta');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            });
        });
    }

    const carteiraBuscarBtn = document.getElementById('btnCarteiraBuscar');
    const carteiraProximoBtn = document.getElementById('btnCarteiraProximo');
    function getBancoEntidadeId() {
        const pane = document.getElementById('pane-carteiras');
        return pane ? (pane.dataset.entidadeId || '') : '';
    }
    if (carteiraProximoBtn) {
        carteiraProximoBtn.addEventListener('click', async function () {
            const bancoEntId = getBancoEntidadeId();
            if (!bancoEntId) { if (window.showToast) window.showToast('Salve a conta bancária antes de cadastrar carteiras', { variant: 'warning', delay: 2500 }); return; }
            const url = new URL('{% url "carteira_proximo" slug=slug %}', window.location.origin);
            url.searchParams.set('banco', bancoEntId);
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.ok) {
                const input = document.getElementById('carteiraCodigo');
                if (input) input.value = data.proximo;
            }
        });
    }
    if (carteiraBuscarBtn) {
        carteiraBuscarBtn.addEventListener('click', async function () {
            const bancoEntId = getBancoEntidadeId();
            if (!bancoEntId) { if (window.showToast) window.showToast('Salve a conta bancária antes de buscar carteiras', { variant: 'warning', delay: 2500 }); return; }
            const codigo = document.getElementById('carteiraCodigo').value;
            const url = new URL('{% url "carteira_lookup" slug=slug %}', window.location.origin);
            url.searchParams.set('banco', bancoEntId);
            if (codigo) url.searchParams.set('cart_codi', codigo);
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.ok && data.carteira) {
                const container = document.getElementById('pane-carteiras');
                Object.entries(data.carteira).forEach(function ([k, v]) {
                    const el = container.querySelector('[name="' + k + '"]');
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = !!v;
                        } else {
                            el.value = v == null ? '' : v;
                        }
                    }
                });
                container.dataset.codigoOriginal = String(data.carteira.cart_codi || '');
                document.getElementById('pane-carteiras').dataset.existe = '1';

            } else {
                if (window.showToast) window.showToast('Carteira não encontrada', { variant: 'warning', delay: 2000 });
                document.getElementById('pane-carteiras').dataset.existe = '0';
                container.dataset.codigoOriginal = '';
                const container = document.getElementById('pane-carteiras');
                Array.from(container.querySelectorAll('input[name^="cart_"], select[name^="cart_"], textarea[name^="cart_"]')).forEach(function (el) {
                    if (el.type === 'checkbox') { el.checked = false; } else { el.value = ''; }
                });
            }
        });
    }

    const btnSalvarCarteira = document.getElementById('btnCarteiraSalvar');
    if (btnSalvarCarteira) {
        btnSalvarCarteira.addEventListener('click', async function () {
            const container = document.getElementById('pane-carteiras');
            const existe = container.dataset.existe === '1';
            const bancoEntId = getBancoEntidadeId();
            if (!bancoEntId) { if (window.showToast) window.showToast('Salve a conta bancária antes de cadastrar carteiras', { variant: 'warning', delay: 2500 }); return; }
            const codigo = document.getElementById('carteiraCodigo').value;
            const fd = new FormData();
            Array.from(container.querySelectorAll('input[name^="cart_"], select[name^="cart_"], textarea[name^="cart_"]')).forEach(function (el) {
                let val = '';
                if (el.type === 'checkbox') {
                    val = el.checked ? 'on' : '';
                } else {
                    val = el.value || '';
                }
                fd.append(el.name, val);
            });
            fd.append('banco', bancoEntId);
            // limpar erros anteriores
            Array.from(container.querySelectorAll('[data-field-error="1"]')).forEach(function (el) { el.remove(); });
            let url;
            try {
                const urlLookupPre = new URL('{% url "carteira_lookup" slug=slug %}', window.location.origin);
                urlLookupPre.searchParams.set('banco', bancoEntId);
                const codigoConsulta = codigo || container.dataset.codigoOriginal || '';
                if (codigoConsulta) urlLookupPre.searchParams.set('cart_codi', codigoConsulta);
                const preRes = await fetch(urlLookupPre);
                const preData = await preRes.json();
                if (preRes.ok && preData && preData.ok && preData.carteira) {
                    const codigoOriginal = container.dataset.codigoOriginal || String(preData.carteira.cart_codi || codigo || '');
                    url = new URL('{% url "carteira_editar" slug=slug codigo=0 %}'.replace('0', encodeURIComponent(codigoOriginal)), window.location.origin);
                    container.dataset.existe = '1';
                } else {
                    url = new URL('{% url "carteira_criar" slug=slug %}', window.location.origin);
                    container.dataset.existe = '0';
                }
            } catch (e) {
                if (existe) {
                    const codigoOriginal = container.dataset.codigoOriginal || codigo || '';
                    url = new URL('{% url "carteira_editar" slug=slug codigo=0 %}'.replace('0', encodeURIComponent(codigoOriginal)), window.location.origin);
                } else {
                    url = new URL('{% url "carteira_criar" slug=slug %}', window.location.origin);
                }
            }
            try {
                const csrftoken = (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';
                const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }, body: fd, credentials: 'same-origin' });
                const data = await res.json();
                if (res.ok && data && data.ok) {
                    if (window.showToast) window.showToast('Carteira salva', { variant: 'success', delay: 1500 });
                    container.dataset.existe = '1';
                    try {
                        const novoCodigo = (data.carteira && data.carteira.cart_codi != null) ? String(data.carteira.cart_codi) : (container.querySelector('[name="cart_codi"]').value || '');
                        container.dataset.codigoOriginal = novoCodigo;
                        const codigoInput = document.getElementById('carteiraCodigo');
                        if (codigoInput) { codigoInput.value = novoCodigo; }
                        // Recarregar dados do servidor para refletir normalizações
                        const bancoEntId = getBancoEntidadeId();
                        const urlLookup = new URL('{% url "carteira_lookup" slug=slug %}', window.location.origin);
                        urlLookup.searchParams.set('banco', bancoEntId);
                        urlLookup.searchParams.set('cart_codi', novoCodigo);
                        const resLookup = await fetch(urlLookup);
                        const dataLookup = await resLookup.json();
                        if (dataLookup && dataLookup.ok && dataLookup.carteira) {
                            Object.entries(dataLookup.carteira).forEach(function ([k, v]) {
                                const el = container.querySelector('[name="' + k + '"]');
                                if (el) {
                                    if (el.type === 'checkbox') { el.checked = !!v; } else { el.value = v == null ? '' : v; }
                                }
                            });
                        }
                    } catch (e) { }
                } else {
                    if (data && data.errors) {
                        Object.entries(data.errors).forEach(function ([name, msgs]) {
                            const field = container.querySelector('[name="' + name + '"]');
                            if (field) {
                                const div = document.createElement('div');
                                div.className = 'text-danger';
                                div.setAttribute('data-field-error', '1');
                                div.textContent = Array.isArray(msgs) ? msgs.join(' ') : String(msgs);
                                field.insertAdjacentElement('afterend', div);
                            }
                        });
                    }
                    if (window.showToast) window.showToast('Erro ao salvar carteira', { variant: 'danger', delay: 3000 });
                }
            } catch (e) {
                if (window.showToast) window.showToast('Falha na comunicação com o servidor', { variant: 'danger', delay: 3000 });
            }
        });
    }

    // Tabs simples e visibilidade de Endereço
    const tabs = document.querySelectorAll('#bancoTabs .nav-link');
    tabs.forEach(function (btn) {
        btn.addEventListener('click', function () {
            tabs.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const targetId = btn.getAttribute('data-target');
            document.querySelectorAll('.tab-pane').forEach(p => {
                if ('#' + p.id === targetId) { p.style.display = ''; } else { p.style.display = 'none'; }
            });
            const endereco = document.getElementById('pane-endereco');
            if (endereco) {
                if (targetId === '#pane-carteiras') endereco.style.display = 'none'; else endereco.style.display = '';
            }
        });
    });
</script>
{% endblock %}