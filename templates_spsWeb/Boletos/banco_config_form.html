{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<style>
    .config-banco-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card-header-custom {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
    }

    .card-header-custom h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-header-custom small {
        opacity: 0.9;
        font-size: 0.9rem;
        display: block;
        margin-top: 0.5rem;
    }

    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #2c3e50;
    }

    .form-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-label.required::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.15);
    }

    .form-select-lg {
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        transition: all 0.2s;
    }

    .form-select-lg:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.3rem rgba(44, 62, 80, 0.15);
    }

    .field-hint {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
        display: block;
        font-style: italic;
    }

    .text-danger {
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .btn-action-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-start;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #dee2e6;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
        color: white;
        padding: 0.75rem 2.5rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(39, 174, 96, 0.3);
    }

    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(39, 174, 96, 0.4);
    }

    .btn-secondary-custom {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-secondary-custom:hover {
        background: #5a6268;
        transform: translateY(-1px);
        color: white;
    }

    .info-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 5px solid #2196f3;
        padding: 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .info-card-title {
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-card ul {
        margin: 0;
        padding-left: 1.5rem;
        color: #424242;
    }

    .info-card ul li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    /* Badge para o select de banco */
    .banco-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #2c3e50;
        color: white;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* Inputs numéricos alinhados à direita */
    input[inputmode="numeric"] {
        text-align: right;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        letter-spacing: 1px;
    }

    /* Conta formatada visualmente */
    .conta-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: #e9ecef;
        border-radius: 0.375rem;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .conta-display span {
        color: #6c757d;
    }

    /* Estado com badge */
    .uf-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: #e9ecef;
        border-radius: 0.25rem;
        font-weight: 700;
        text-align: center;
    }

    @media (max-width: 768px) {
        .btn-action-group {
            flex-direction: column;
        }

        .btn-action-group .btn {
            width: 100%;
        }

        .form-section {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'css/form.css' %}">
<div class="container">
    <div class="card shadow">
        <h3 class="card-title mb-4 fs-4  text-center">
            {% if entidade.enti_clie %}
            <i class="bi bi-pencil-square"></i> Editar Conta Bancária
            {% else %}
            <i class="bi bi-plus-circle-fill"></i> Nova Conta Bancária
            {% endif %}
        </h3>
        <small>
            {% if entidade.enti_nome %}
            {{ entidade.enti_nome }}
            {% else %}

            {% endif %}
        </small>
    </div>



    <form method="post" id="bancoConfigForm" novalidate>
        {% csrf_token %}

        <!-- Seção: Seleção do Banco -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-bank2"></i> Seleção do Banco
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label required">
                        {{ form.codigo_banco.label }}
                    </label>
                    {{ form.codigo_banco }}
                    <span class="field-hint">Selecione o banco na lista acima</span>
                    {% if form.codigo_banco.errors %}
                    <div class="text-danger">
                        {{ form.codigo_banco.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Seção: Identificação da Conta -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-card-text"></i> Identificação da Conta
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label {% if form.enti_nome.field.required %}required{% endif %}">
                        {{ form.enti_nome.label }}
                    </label>
                    {{ form.enti_nome }}
                    <span class="field-hint">Nome para identificar esta conta no sistema</span>
                    {% if form.enti_nome.errors %}
                    <div class="text-danger">
                        {{ form.enti_nome.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label {% if form.enti_fant.field.required %}required{% endif %}">
                        {{ form.enti_fant.label }}
                    </label>
                    {{ form.enti_fant }}
                    <span class="field-hint">Apelido curto para facilitar visualização</span>
                    {% if form.enti_fant.errors %}
                    <div class="text-danger">
                        {{ form.enti_fant.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Seção: Dados da Conta -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-hash"></i> Dados da Conta Bancária
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label {% if form.enti_agen.field.required %}required{% endif %}">
                        {{ form.enti_agen.label }}
                    </label>
                    {{ form.enti_agen }}
                    <span class="field-hint">Apenas números</span>
                    {% if form.enti_agen.errors %}
                    <div class="text-danger">
                        {{ form.enti_agen.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label {% if form.enti_diag.field.required %}required{% endif %}">
                        {{ form.enti_diag.label }}
                    </label>
                    {{ form.enti_diag }}
                    <span class="field-hint">DV (opcional)</span>
                    {% if form.enti_diag.errors %}
                    <div class="text-danger">
                        {{ form.enti_diag.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <label class="form-label {% if form.enti_coco.field.required %}required{% endif %}">
                        {{ form.enti_coco.label }}
                    </label>
                    {{ form.enti_coco }}
                    <span class="field-hint">Número da conta sem DV</span>
                    {% if form.enti_coco.errors %}
                    <div class="text-danger">
                        {{ form.enti_coco.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label {% if form.enti_dico.field.required %}required{% endif %}">
                        {{ form.enti_dico.label }}
                    </label>
                    {{ form.enti_dico }}
                    <span class="field-hint">DV obrigatório</span>
                    {% if form.enti_dico.errors %}
                    <div class="text-danger">
                        {{ form.enti_dico.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label {% if form.enti_tien.field.required %}required{% endif %}">
                        {{ form.enti_tien.label }}
                    </label>
                    {{ form.enti_tien }}
                    {% if form.enti_tien.errors %}
                    <div class="text-danger">
                        {{ form.enti_tien.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label">
                        {{ form.logo_variation.label }}
                    </label>
                    {{ form.logo_variation }}
                    <span class="field-hint">Preferência de exibição do logo</span>
                </div>

                <!-- Preview da conta formatada -->
                <div class="col-12">
                    <div class="conta-display" id="contaPreview" style="display: none;">
                        <strong>Conta completa:</strong>
                        <span>Ag:</span> <span id="previewAg">----</span>
                        <span>C/C:</span> <span id="previewConta">--------</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Endereço (Opcional) -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-geo-alt-fill"></i> Endereço <small class="text-muted">(opcional)</small>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">
                        {{ form.enti_cep.label }}
                    </label>
                    {{ form.enti_cep }}
                    {% if form.enti_cep.errors %}
                    <div class="text-danger">
                        {{ form.enti_cep.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-7">
                    <label class="form-label">
                        {{ form.enti_ende.label }}
                    </label>
                    {{ form.enti_ende }}
                    {% if form.enti_ende.errors %}
                    <div class="text-danger">
                        {{ form.enti_ende.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-2">
                    <label class="form-label">
                        {{ form.enti_nume.label }}
                    </label>
                    {{ form.enti_nume }}
                    {% if form.enti_nume.errors %}
                    <div class="text-danger">
                        {{ form.enti_nume.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-8">
                    <label class="form-label">
                        {{ form.enti_cida.label }}
                    </label>
                    {{ form.enti_cida }}
                    {% if form.enti_cida.errors %}
                    <div class="text-danger">
                        {{ form.enti_cida.errors|striptags }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">
                        {{ form.enti_esta.label }}
                    </label>
                    {{ form.enti_esta }}
                    {% if form.enti_esta.errors %}
                    <div class="text-danger">
                        {{ form.enti_esta.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="btn-action-group">
            <button class="btn btn-primary-custom" type="submit">
                <i class="bi bi-check-circle-fill"></i>
                {% if entidade.enti_clie %}
                Salvar Alterações
                {% else %}
                Cadastrar Conta
                {% endif %}
            </button>
            <a class="btn btn-secondary-custom" href="{% url 'banco_config_list' slug=slug %}">
                <i class="bi bi-arrow-left-circle"></i> Cancelar
            </a>
        </div>
    </form>
</div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Formatar CEP automaticamente
    const cepInput = document.querySelector('[name="enti_cep"]');
    if (cepInput) {
        cepInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5, 8);
            }
            e.target.value = value;
        });
    }

    // Forçar maiúsculas no campo UF
    const ufInput = document.querySelector('[name="enti_esta"]');
    if (ufInput) {
        ufInput.addEventListener('input', function (e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }

    // Preview da conta formatada
    function atualizarPreview() {
        const agencia = document.querySelector('[name="enti_agen"]').value;
        const digAg = document.querySelector('[name="enti_diag"]').value;
        const conta = document.querySelector('[name="enti_coco"]').value;
        const digConta = document.querySelector('[name="enti_dico"]').value;

        const preview = document.getElementById('contaPreview');
        const previewAg = document.getElementById('previewAg');
        const previewConta = document.getElementById('previewConta');

        if (agencia || conta) {
            preview.style.display = 'flex';

            // Formatar agência
            if (agencia) {
                previewAg.textContent = digAg ? `${agencia}-${digAg}` : agencia;
            } else {
                previewAg.textContent = '----';
            }

            // Formatar conta
            if (conta) {
                previewConta.textContent = digConta ? `${conta}-${digConta}` : conta;
            } else {
                previewConta.textContent = '--------';
            }
        } else {
            preview.style.display = 'none';
        }
    }

    // Atualizar preview em tempo real
    ['enti_agen', 'enti_diag', 'enti_coco', 'enti_dico'].forEach(name => {
        const input = document.querySelector(`[name="${name}"]`);
        if (input) {
            input.addEventListener('input', atualizarPreview);
            input.addEventListener('blur', atualizarPreview);
        }
    });

    // Executar preview inicial
    atualizarPreview();

    // Validação visual do select de banco
    const bancoSelect = document.querySelector('[name="codigo_banco"]');
    if (bancoSelect) {
        bancoSelect.addEventListener('change', function (e) {
            if (e.target.value) {
                e.target.classList.add('is-valid');
                e.target.classList.remove('is-invalid');
            } else {
                e.target.classList.remove('is-valid');
            }
        });
    }

    const formEl = document.getElementById('bancoConfigForm');
    if (formEl) {
        formEl.addEventListener('submit', function (e) {
            e.preventDefault();
            const fd = new FormData(formEl);
            fetch(window.location.href, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
            }).then(async function(res){
                try {
                    const data = await res.json();
                    if (res.ok && data && data.ok) {
                        if (window.showToast) window.showToast('Configuração salva com sucesso', { variant: 'success', delay: 1500 });
                        const cancelLink = document.querySelector('.btn.btn-secondary-custom');
                        const target = cancelLink ? cancelLink.getAttribute('href') : window.location.pathname;
                        setTimeout(function(){ window.location.href = target; }, 1500);
                    } else {
                        if (window.showToast) window.showToast('Erro ao salvar configuração', { variant: 'danger', delay: 3000 });
                    }
                } catch (_) {
                    if (window.showToast) window.showToast('Falha ao processar resposta', { variant: 'warning', delay: 3000 });
                }
            }).catch(function(){
                if (window.showToast) window.showToast('Falha na comunicação com o servidor', { variant: 'danger', delay: 3000 });
            });
        });
    }
</script>
{% endblock %}