{% load static %}
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.cfop_empr }}

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label" for="{{ form.cfop_codi.auto_id }}">Código CFOP</label>
      {{ form.cfop_codi }}
      <div id="cfop-suggest" class="list-group mt-1" style="max-height:200px; overflow:auto;"></div>

      <!-- Datalist vazio – será preenchido via JS -->
      <datalist id="cfop-codes"></datalist>

      {% if form.cfop_codi.errors %}
        <div class="text-danger">{{ form.cfop_codi.errors }}</div>
      {% endif %}
    </div>

    <div class="col-md-8 mb-3">
      <label class="form-label" for="{{ form.cfop_desc.auto_id }}">Descrição</label>
      {{ form.cfop_desc }}
      {% if form.cfop_desc.errors %}
        <div class="text-danger">{{ form.cfop_desc.errors }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-2"><span class="form-label">Exigências</span></div>

    <div class="col-md-12 d-flex flex-wrap gap-4">

      <div class="form-check">
        {{ form.cfop_exig_ipi }}
        <label class="form-check-label" for="{{ form.cfop_exig_ipi.auto_id }}">Exige IPI</label>
      </div>

      <div class="form-check">
        {{ form.cfop_exig_icms }}
        <label class="form-check-label" for="{{ form.cfop_exig_icms.auto_id }}">Exige ICMS</label>
      </div>

      <div class="form-check">
        {{ form.cfop_exig_pis_cofins }}
        <label class="form-check-label" for="{{ form.cfop_exig_pis_cofins.auto_id }}">Exige PIS/COFINS</label>
      </div>

      <div class="form-check">
        {{ form.cfop_exig_cbs }}
        <label class="form-check-label" for="{{ form.cfop_exig_cbs.auto_id }}">Exige CBS</label>
      </div>

      <div class="form-check">
        {{ form.cfop_exig_ibs }}
        <label class="form-check-label" for="{{ form.cfop_exig_ibs.auto_id }}">Exige IBS</label>
      </div>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Salvar</button>
    <a href="/web/{{ slug }}/cfop/" class="btn btn-secondary">Voltar</a>
  </div>
</form>

<script>
(function () {
  var input = document.getElementById('{{ form.cfop_codi.auto_id }}');
  var desc  = document.getElementById('{{ form.cfop_desc.auto_id }}');
  var list = document.getElementById('cfop-codes');
  var suggest = document.getElementById('cfop-suggest');
  var slug = '{{ slug }}';

  function renderDatalist(items) {
    list.innerHTML = '';
    items.forEach(function (it) {
      var opt = document.createElement('option');
      opt.value = it.value;
      opt.textContent = it.label;
      list.appendChild(opt);
    });
  }

  function renderSuggest(items) {
    suggest.innerHTML = '';
    items.slice(0, 10).forEach(function (it) {
      var a = document.createElement('a');
      a.href = '#';
      a.className = 'list-group-item list-group-item-action';
      a.textContent = it.label;
      a.onclick = function (e) {
        e.preventDefault();
        input.value = it.value;

        var parts = it.label.split(' - ');
        if (parts.length > 1) {
          desc.value = parts.slice(1).join(' - ');
        }

        suggest.innerHTML = '';
      };
      suggest.appendChild(a);
    });
  }

  function fetchSuggest(q) {
    var url = '/web/' + slug + '/cfop/autocomplete/?q=' + encodeURIComponent(q);

    fetch(url)
      .then(r => r.json())
      .then(data => {
        var items = data.results || [];
        renderDatalist(items);
        renderSuggest(items);
      });
  }

  input.addEventListener('input', function () {
    var q = input.value.trim();
    if (q.length >= 2) {
      fetchSuggest(q);
    } else {
      suggest.innerHTML = '';
    }
  });
})();
</script>
