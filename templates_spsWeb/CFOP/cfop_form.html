{% extends "base.html" %}
{% load static %}
{% block title %} Cadastrar CFOP {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'css/form.css' %}">
<div class="container py-4">
  <h3 class="card-title mb-4 fs-4 text-center"> {% if form.instance.pk %}Editar{% else %}Cadastrar{% endif %} CFOP</h3>
  <div class="card shadow-sm border-primary">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.cfop_empr }}

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
        {% endif %}

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label" for="{{ form.cfop_codi.auto_id }}">Código CFOP</label>
            {{ form.cfop_codi }}
            <div id="cfop-suggest" class="list-group mt-1" style="max-height:200px; overflow:auto;"></div>

            <!-- Datalist vazio – será preenchido via JS -->
            <datalist id="cfop-codes"></datalist>

            {% if form.cfop_codi.errors %}
            <div class="text-danger">{{ form.cfop_codi.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-8 mb-3">
            <label class="form-label" for="{{ form.cfop_desc.auto_id }}">Descrição</label>
            {{ form.cfop_desc }}
            {% if form.cfop_desc.errors %}
            <div class="text-danger">{{ form.cfop_desc.errors }}</div>
            {% endif %}
          </div>
        </div>
        <div id="exigencias-auto" class="mb-3" style="display:none;">
          <strong>Exigências detectadas automaticamente:</strong>
          <div id="exigencias-badges" class="mt-1 d-flex flex-wrap gap-2"></div>
        </div>

        <div class="row">
          <div class="col-md-12 mb-2"><span class="form-label">Exigências</span></div>

          <div class="col-md-12 d-flex flex-wrap gap-4">

            <div class="form-check">
              {{ form.cfop_exig_ipi }}
              <label class="form-check-label" for="{{ form.cfop_exig_ipi.auto_id }}">Exige IPI</label>
            </div>

            <div class="form-check">
              {{ form.cfop_exig_icms }}
              <label class="form-check-label" for="{{ form.cfop_exig_icms.auto_id }}">Exige ICMS</label>
            </div>

            <div class="form-check">
              {{ form.cfop_exig_pis_cofins }}
              <label class="form-check-label" for="{{ form.cfop_exig_pis_cofins.auto_id }}">Exige PIS/COFINS</label>
            </div>

            <div class="form-check">
              {{ form.cfop_exig_cbs }}
              <label class="form-check-label" for="{{ form.cfop_exig_cbs.auto_id }}">Exige CBS</label>
            </div>

            <div class="form-check">
              {{ form.cfop_exig_ibs }}
              <label class="form-check-label" for="{{ form.cfop_exig_ibs.auto_id }}">Exige IBS</label>
            </div>
            <div class="form-check">
              {{ form.cfop_gera_st }}
              <label class="form-check-label" for="{{ form.cfop_gera_st.auto_id }}">Gera ST</label>
            </div>
            <div class="form-check">
              {{ form.cfop_gera_difal }}
              <label class="form-check-label" for="{{ form.cfop_gera_difal.auto_id }}">Gera DIFAL</label>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <a href="/web/{{ slug }}/cfop/" class="btn btn-secondary">Voltar</a>
        </div>
      </form>
      <script>
        (function () {
          var inputCFOP = document.getElementById('{{ form.cfop_codi.auto_id }}');
          var desc = document.getElementById('{{ form.cfop_desc.auto_id }}');

          var boxExig = document.getElementById("exigencias-auto");
          var containerBadges = document.getElementById("exigencias-badges");
          var suggestBox = document.getElementById("cfop-suggest");
          var datalist = document.getElementById("cfop-codes");

          function atualizarExigencias(cfop) {
            cfop = (cfop || "").trim();
            if (cfop.length < 2) {
              boxExig.style.display = "none";
              containerBadges.innerHTML = "";
              return;
            }

            fetch(`/web/{{ slug }}/cfop/exigencias/?cfop=${encodeURIComponent(cfop)}`)
              .then(r => r.json())
              .then(data => {
                if (data.error) return;

                // checkboxes
                document.getElementById('{{ form.cfop_exig_icms.auto_id }}').checked = data.icms;
                document.getElementById('{{ form.cfop_exig_ipi.auto_id }}').checked = data.ipi;
                document.getElementById('{{ form.cfop_exig_pis_cofins.auto_id }}').checked = data.pis_cofins;
                document.getElementById('{{ form.cfop_exig_cbs.auto_id }}').checked = data.cbs;
                document.getElementById('{{ form.cfop_exig_ibs.auto_id }}').checked = data.ibs;
                document.getElementById('{{ form.cfop_gera_st.auto_id }}').checked = data.st;
                document.getElementById('{{ form.cfop_gera_difal.auto_id }}').checked = data.difal;

                // badges
                containerBadges.innerHTML = "";
                const labels = {
                  icms: "ICMS",
                  ipi: "IPI",
                  pis_cofins: "PIS/COFINS",
                  cbs: "CBS",
                  ibs: "IBS",
                  st: "ICMS-ST",
                  difal: "DIFAL",
                };

                Object.entries(data).forEach(([campo, ativo]) => {
                  if (ativo && labels[campo]) {
                    var badge = document.createElement("span");
                    badge.className = "badge bg-primary me-1";
                    badge.textContent = labels[campo];
                    containerBadges.appendChild(badge);
                  }
                });

                boxExig.style.display = containerBadges.children.length ? "block" : "none";
              })
              .catch(err => console.error(err));
          }

          function atualizarSugestoes(term) {
            term = (term || "").trim();
            if (term.length < 1) {
              suggestBox.innerHTML = "";
              datalist.innerHTML = "";
              return;
            }
            fetch(`/web/{{ slug }}/cfop/autocomplete/?q=${encodeURIComponent(term)}`)
              .then(r => r.json())
              .then(data => {
                var results = Array.isArray(data.results) ? data.results : [];
                suggestBox.innerHTML = "";
                datalist.innerHTML = "";
                inputCFOP.setAttribute('list', 'cfop-codes');
                results.forEach(function (item) {
                  var a = document.createElement('a');
                  a.className = 'list-group-item list-group-item-action';
                  a.setAttribute('href', '#');
                  a.setAttribute('data-value', item.value);
                  a.setAttribute('data-label', item.label);
                  a.textContent = item.label;
                  suggestBox.appendChild(a);
                  var opt = document.createElement('option');
                  opt.value = item.value;
                  opt.textContent = item.label;
                  datalist.appendChild(opt);
                });
              })
              .catch(function () {
                suggestBox.innerHTML = "";
                datalist.innerHTML = "";
              });
          }

          var debounce;
          inputCFOP.addEventListener("input", function () {
            var val = this.value;
            clearTimeout(debounce);
            debounce = setTimeout(function () {
              atualizarSugestoes(val);
              atualizarExigencias(val);
            }, 200);
          });

          suggestBox.addEventListener('click', function (e) {
            var el = e.target.closest('a');
            if (!el) return;
            e.preventDefault();
            var val = el.getAttribute('data-value') || '';
            var label = el.getAttribute('data-label') || '';
            inputCFOP.value = val;
            var parts = label.split(' - ');
            if (parts.length > 1) {
              desc.value = parts.slice(1).join(' - ');
            }
            atualizarExigencias(val);
            suggestBox.innerHTML = "";
          });
        })();
      </script>
      {% endblock %}