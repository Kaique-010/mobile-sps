{% extends 'base.html' %}
{% load static %}
{% load centrodecustos_tags %}

{% block title %}Centros de Custos{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Centros de Custos</h3>
    <div>
      <a href="{% url 'centrosdecustos:exportar' slug=slug %}?cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}"
        class="btn btn-outline-secondary btn-sm">Exportar CSV</a>
      <a href="{% url 'centrosdecustos:criar' slug=slug %}" class="btn btn-primary btn-sm">Novo</a>
    </div>
  </div>

  <form method="get" class="mb-3">
    <div class="row g-2">
      <div class="col-md-6">
        <input type="text" name="cecu_nome" class="form-control" placeholder="Nome" value="{{ cecu_nome }}" />
      </div>
      <div class="col-md-3">
        <input type="text" name="cecu_redu" class="form-control" placeholder="Código" value="{{ cecu_redu }}" />
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-outline-primary w-100">Filtrar</button>
      </div>
    </div>
  </form>

  <div class="card p-3">
    {% include 'CentrodeCustos/arvore.html' with nodes=roots empresa=empresa slug=slug max_depth=max_depth depth=1 %}
  </div>
  <div class="mt-3 d-flex gap-2">
    <input type="text" id="cc-search" class="form-control" placeholder="Buscar por código ou nome" />
    <button type="button" id="cc-expand" class="btn btn-outline-primary">Expandir</button>
    <button type="button" id="cc-collapse" class="btn btn-outline-secondary">Contrair</button>
  </div>
</div>

{% if is_paginated %}
<nav>
  <ul class="pagination pagination-sm">
    {% if page_obj.has_previous %}
    <li class="page-item"><a class="page-link"
        href="?page={{ page_obj.previous_page_number }}&cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}">Anterior</a>
    </li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{
        page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
    <li class="page-item"><a class="page-link"
        href="?page={{ page_obj.next_page_number }}&cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}">Próxima</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('click', function (e) {
    if (e.target && e.target.classList.contains('toggle-node')) {
      var li = e.target.closest('li');
      var child = li && li.querySelector(':scope > .children');
      if (child) {
        var visible = child.style.display !== 'none';
        child.style.display = visible ? 'none' : '';
        e.target.textContent = visible ? '⯆' : '⯈';
      }
    }
  });
  document.getElementById('cc-expand').addEventListener('click', function () {
    document.querySelectorAll('.children').forEach(function (c) { c.style.display = ''; });
    document.querySelectorAll('.toggle-node').forEach(function (b) { b.textContent = '⯈'; });
  });
  document.getElementById('cc-collapse').addEventListener('click', function () {
    document.querySelectorAll('.children').forEach(function (c) { c.style.display = 'none'; });
    document.querySelectorAll('.toggle-node').forEach(function (b) { b.textContent = '⯆'; });
  });
  document.getElementById('cc-search').addEventListener('input', function () {
    var q = this.value.toLowerCase().trim();
    var items = Array.from(document.querySelectorAll('li[data-code]'));
    if (!q) { items.forEach(function (li) { li.style.display = ''; }); return; }
    items.forEach(function (li) {
      var name = (li.getAttribute('data-name') || '').toLowerCase();
      var code = (li.getAttribute('data-code') || '').toLowerCase();
      var match = name.indexOf(q) >= 0 || code.indexOf(q) >= 0;
      li.style.display = match ? '' : 'none';
      if (match) {
        var p = li.parentElement.closest('li[data-code]');
        while (p) { p.style.display = ''; p = p.parentElement.closest('li[data-code]'); }
        var child = li.querySelector(':scope > .children');
        if (child) { child.style.display = ''; }
      }
    });
  });
</script>
{% endblock %}