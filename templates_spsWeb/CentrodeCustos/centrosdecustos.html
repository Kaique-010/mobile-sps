{% extends 'base.html' %}
{% load static %}
{% load centrodecustos_tags %}

{% block title %}Centros de Custos{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/list.css' %}">
<div class="container page-container">
  <div class="page-header-custom">
    <div class="container align-items-center">
      <h2 class="page-title">
        <i class="bi bi-building-check fs-4"></i> Centros de Custos
      </h2>
      <a href="{% url 'centrosdecustos:exportar' slug=slug %}?cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}"
        class="btn btn-outline-secondary btn-sm"
        style="margin-left: 10px; padding: 8px 16px; border-radius: 4px; margin-bottom: 20px; font-size: 16px; font-weight: 600; background-color: #215188; color: #fff;">Exportar
        CSV</a>
      <a href="{% url 'centrosdecustos:criar' slug=slug %}" class="btn btn-success btn-sm">Novo</a>
    </div>
  </div>



  <div class="card p-3">
    {% include 'CentrodeCustos/arvore.html' with nodes=roots empresa=empresa_id slug=slug max_depth=max_depth depth=1 %}
  </div>
  {% if messages %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    {% for message in messages %}
    <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true"
      data-bs-delay="4000" data-tag="{{ message.tags }}">
      <div class="d-flex">
        <div class="toast-body">{{ message }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <div class="mt-3 d-flex gap-2">
    <input type="text" id="cc-search" class="form-control" placeholder="Buscar por código ou nome" />
    <button type="button" id="cc-expand" class="btn btn-outline-primary">Expandir</button>
    <button type="button" id="cc-collapse" class="btn btn-outline-secondary">Contrair</button>
  </div>
</div>

{% if is_paginated %}
<nav>
  <ul class="pagination pagination-sm">
    {% if page_obj.has_previous %}
    <li class="page-item"><a class="page-link"
        href="?page={{ page_obj.previous_page_number }}&cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}">Anterior</a>
    </li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{
        page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
    <li class="page-item"><a class="page-link"
        href="?page={{ page_obj.next_page_number }}&cecu_nome={{ cecu_nome }}&cecu_redu={{ cecu_redu }}">Próxima</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('click', function (e) {
    if (e.target && e.target.classList.contains('toggle-node')) {
      var li = e.target.closest('li');
      var child = li && li.querySelector(':scope > .children');
      if (child) {
        var visible = child.style.display !== 'none';
        child.style.display = visible ? 'none' : '';
        e.target.textContent = visible ? '⯈' : '⯆';
      }
    }
  });
  document.getElementById('cc-expand').addEventListener('click', function () {
    document.querySelectorAll('.children').forEach(function (c) { c.style.display = ''; });
    document.querySelectorAll('.toggle-node').forEach(function (b) { b.textContent = '⯆'; });
  });
  document.getElementById('cc-collapse').addEventListener('click', function () {
    document.querySelectorAll('.children').forEach(function (c) { c.style.display = 'none'; });
    document.querySelectorAll('.toggle-node').forEach(function (b) { b.textContent = '⯈'; });
  });
  document.getElementById('cc-search').addEventListener('input', function () {
    var q = this.value.toLowerCase().trim();
    var items = Array.from(document.querySelectorAll('li[data-code]'));
    if (!q) { items.forEach(function (li) { li.style.display = ''; }); return; }
    items.forEach(function (li) {
      var name = (li.getAttribute('data-name') || '').toLowerCase();
      var code = (li.getAttribute('data-code') || '').toLowerCase();
      var match = name.indexOf(q) >= 0 || code.indexOf(q) >= 0;
      li.style.display = match ? '' : 'none';
      if (match) {
        var p = li.parentElement.closest('li[data-code]');
        while (p) { p.style.display = ''; p = p.parentElement.closest('li[data-code]'); }
        var child = li.querySelector(':scope > .children');
        if (child) { child.style.display = ''; }
      }
    });
  });
  try {
    document.querySelectorAll('.toast').forEach(function (t) {
      var tag = t.getAttribute('data-tag') || '';
      var cls = 'text-bg-secondary';
      if (tag.indexOf('success') >= 0) cls = 'text-bg-success';
      else if (tag.indexOf('error') >= 0) cls = 'text-bg-danger';
      else if (tag.indexOf('warning') >= 0) cls = 'text-bg-warning';
      else if (tag.indexOf('info') >= 0) cls = 'text-bg-info';
      t.classList.add(cls);
      if (window.bootstrap && bootstrap.Toast) {
        new bootstrap.Toast(t).show();
      } else {
        t.classList.add('show');
      }
    });
  } catch (e) { }
</script>
{% endblock %}