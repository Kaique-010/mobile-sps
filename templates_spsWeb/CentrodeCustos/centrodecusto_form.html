{% extends 'base.html' %}
{% load static %}
{% block title %}Centro de Custos{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="page-header-custom mb-3 d-flex justify-content-between align-items-center">
        <div class="container align-items-center">
            <h2 class="page-title"><i class="bi bi-diagram-3"></i> Centro de Custos</h2>
        </div>
        <div class="page-actions">
            <a href="{% url 'centrosdecustos:lista' slug=slug %}" class="btn btn-outline-secondary btn-sm"
                id="btnCancelar"><i class="bi bi-arrow-left"></i> Cancelar</a>
            <button type="submit" form="ccForm" class="btn btn-primary btn-sm" id="btnSalvar"><i
                    class="bi bi-check2-circle"></i> Salvar</button>
        </div>
    </div>

    {% if messages %}
    <div id="messagesBox" class="d-none">
        {% for message in messages %}
        <div class="message-item" data-level="{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <form id="ccForm" method="post" novalidate class="needs-validation">
        {% csrf_token %}
        {{ form.cecu_empr }}

        {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            {{ form.non_field_errors }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="card mb-3">
            <div class="card-header">Informações básicas</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="id_cecu_nome" class="form-label">Nome *</label>
                        <input type="text" name="cecu_nome" maxlength="60"
                            class="form-control {% if form.cecu_nome.errors %}is-invalid{% endif %}" id="id_cecu_nome"
                            value="{{ form.cecu_nome.value|default_if_none:'' }}" required>
                        {% if form.cecu_nome.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.cecu_nome.errors.0 }}
                        </div>
                        {% else %}
                        <div class="invalid-feedback">Informe o nome.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Tipo e Hierarquia</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="id_cecu_anal" class="form-label">Tipo *</label>
                        <select name="cecu_anal" class="form-select {% if form.cecu_anal.errors %}is-invalid{% endif %}"
                            id="id_cecu_anal" required>
                            <option value="">-- Selecione o tipo --</option>
                            <option value="S">Sintética (agrupa outras contas)</option>
                            <option value="A">Analítica (movimentação direta)</option>
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Sintética:</strong> agrupa outras contas (não tem movimentação direta)<br>
                                <strong>Analítica:</strong> tem movimentação direta (precisa de conta pai)
                            </small>
                        </div>
                        {% if form.cecu_anal.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.cecu_anal.errors.0 }}
                        </div>
                        {% else %}
                        <div class="invalid-feedback">Selecione o tipo.</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6" id="divPai">
                        <label for="id_cecu_niv1" class="form-label">
                            Conta Pai <span id="requiredPai" class="text-danger d-none">*</span>
                        </label>
                        <input type="text" name="cecu_niv1"
                            class="form-control {% if form.cecu_niv1.errors %}is-invalid{% endif %}" id="id_cecu_niv1"
                            value="{{ form.cecu_niv1.value|default_if_none:'' }}" list="listaPais"
                            placeholder="Digite código ou nome para buscar">
                        <datalist id="listaPais"></datalist>
                        <div class="form-text">
                            <small id="paiHelp">Deixe vazio para criar conta raiz (nível 1)</small>
                        </div>
                        {% if form.cecu_niv1.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.cecu_niv1.errors.0 }}
                        </div>
                        {% else %}
                        <div class="invalid-feedback">Conta analítica precisa de conta pai sintética.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3" id="divPreview">
            <div class="card-header bg-light">
                <i class="bi bi-eye"></i> Pré-visualização do Código
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Próximo código disponível</label>
                        <input type="text" class="form-control fw-bold" id="previewCodigo" readonly
                            placeholder="Configure tipo e pai">
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Expansão hierárquica</label>
                        <input type="text" class="form-control fw-bold" id="previewExpa" readonly
                            placeholder="Ex: 1.001">
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0" id="codigoInfo">
                    <i class="bi bi-info-circle"></i>
                    <span id="codigoInfoText">Selecione o tipo para ver o próximo código disponível</span>
                </div>
            </div>
        </div>

    </form>

    <div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Descartar alterações?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    As alterações não salvas serão perdidas.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar editando</button>
                    <a href="{% url 'centrosdecustos:lista' slug=slug %}" class="btn btn-danger"
                        id="confirmLeaveGo">Descartar</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    (function () {
        var form = document.getElementById('ccForm');
        var nome = document.getElementById('id_cecu_nome');
        var pai = document.getElementById('id_cecu_niv1');
        var tipo = document.getElementById('id_cecu_anal');
        var previewCodigo = document.getElementById('previewCodigo');
        var previewExpa = document.getElementById('previewExpa');
        var codigoInfoText = document.getElementById('codigoInfoText');
        var requiredPai = document.getElementById('requiredPai');
        var paiHelp = document.getElementById('paiHelp');
        var dirty = false;

        function setDirty() { dirty = true; }
        ['input', 'change'].forEach(function (ev) {
            if (nome) nome.addEventListener(ev, setDirty);
            if (pai) pai.addEventListener(ev, setDirty);
            if (tipo) tipo.addEventListener(ev, setDirty);
        });

        function validate() {
            var ok = true;

            // Valida nome
            if (!nome.value || !nome.value.trim()) {
                nome.classList.add('is-invalid');
                ok = false;
            } else {
                nome.classList.remove('is-invalid');
            }

            // Valida tipo
            if (!tipo.value) {
                tipo.classList.add('is-invalid');
                ok = false;
            } else {
                tipo.classList.remove('is-invalid');
            }

            // Valida pai (obrigatório para Analítica)
            if (tipo.value === 'A' && (!pai.value || String(pai.value).trim() === '')) {
                pai.classList.add('is-invalid');
                ok = false;
            } else {
                pai.classList.remove('is-invalid');
            }

            return ok;
        }

        if (form) {
            form.addEventListener('submit', function (e) {
                if (!validate()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        function fetchPreview() {
            var tipoVal = tipo.value;
            var paiVal = pai.value;

            // Limpa preview se tipo não selecionado
            if (!tipoVal) {
                previewCodigo.value = '';
                previewExpa.value = '';
                codigoInfoText.textContent = 'Selecione o tipo para ver o próximo código disponível';
                return;
            }

            // Para analítica sem pai, não busca código
            if (tipoVal === 'A' && !paiVal) {
                previewCodigo.value = '';
                previewExpa.value = '';
                codigoInfoText.textContent = 'Selecione uma conta pai para ver o próximo código';
                return;
            }

            var params = new URLSearchParams();
            if (paiVal) {
                params.set('cecu_niv1', String(paiVal));
            }

            var url = '{% url "centrosdecustos:proximo_codigo" slug=slug %}' +
                (params.toString() ? '?' + params.toString() : '');

            fetch(url)
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    if (j && j.next) {
                        previewCodigo.value = String(j.next);

                        // Calcula expansão
                        try {
                            var digits = parseInt('{{ mask_digits|default:3 }}');
                            var base = Math.pow(10, digits);
                            var code = parseInt(j.next);
                            var parts = [];

                            while (code >= base) {
                                parts.push(code % base);
                                code = Math.floor(code / base);
                            }
                            parts.push(code);
                            parts.reverse();

                            var s = String(parts[0]);
                            for (var i = 1; i < parts.length; i++) {
                                s += '.' + String(parts[i]).padStart(digits, '0');
                            }
                            previewExpa.value = s;

                            // Atualiza mensagem informativa
                            if (paiVal) {
                                codigoInfoText.textContent = 'Será criado como filho da conta ' + paiVal + ' no código ' + s;
                            } else {
                                codigoInfoText.textContent = 'Será criado como conta raiz (nível 1) no código ' + s;
                            }
                        } catch (e) {
                            previewExpa.value = '';
                        }
                    }
                })
                .catch(function () {
                    previewCodigo.value = '';
                    previewExpa.value = '';
                });
        }

        // Autocomplete de Pai
        var debounceTimer = null;
        function buscaPais(term) {
            var url = '{% url "centrosdecustos:autocomplete_pai" slug=slug %}?q=' +
                encodeURIComponent(term || '');
            fetch(url)
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    var dl = document.getElementById('listaPais');
                    if (!dl) return;
                    dl.innerHTML = '';
                    (j.results || []).forEach(function (item) {
                        var opt = document.createElement('option');
                        opt.value = String(item.id);
                        opt.label = item.text;
                        dl.appendChild(opt);
                    });
                })
                .catch(function () { });
        }

        function onPaiInput() {
            var val = String(pai.value || '').trim();
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () { buscaPais(val); }, 200);
            fetchPreview();
        }

        function onTipoChange() {
            var tipoVal = tipo.value;

            if (tipoVal === 'A') {
                // Analítica: pai obrigatório
                pai.setAttribute('required', 'required');
                requiredPai.classList.remove('d-none');
                paiHelp.innerHTML = '<small class="text-danger">Conta analítica <strong>precisa</strong> de uma conta pai sintética</small>';
            } else if (tipoVal === 'S') {
                // Sintética: pai opcional
                pai.removeAttribute('required');
                requiredPai.classList.add('d-none');
                paiHelp.innerHTML = '<small>Deixe vazio para criar conta raiz, ou escolha um pai para criar subconta</small>';
            } else {
                pai.removeAttribute('required');
                requiredPai.classList.add('d-none');
                paiHelp.innerHTML = '<small>Deixe vazio para criar conta raiz</small>';
            }

            fetchPreview();
        }

        if (pai) {
            pai.addEventListener('input', onPaiInput);
        }

        if (tipo) {
            tipo.addEventListener('change', onTipoChange);
        }

        // Inicialização
        buscaPais('');
        onTipoChange();
        fetchPreview();

        // Modal de confirmação ao cancelar
        var cancel = document.getElementById('btnCancelar');
        var modalEl = document.getElementById('confirmLeaveModal');
        var modal = null;

        if (cancel && modalEl) {
            modal = new bootstrap.Modal(modalEl);
            cancel.addEventListener('click', function (e) {
                if (dirty) {
                    e.preventDefault();
                    modal.show();
                }
            });
        }

        // Exibe mensagens
        document.addEventListener('DOMContentLoaded', function () {
            var box = document.getElementById('messagesBox');
            if (!box) return;
            var items = box.querySelectorAll('.message-item');
            items.forEach(function (it) {
                var level = (it.getAttribute('data-level') || 'success').split(' ').pop();
                if (window.showToast) {
                    window.showToast(it.textContent, {
                        variant: level === 'error' ? 'danger' : level
                    });
                }
            });
        });

        // Aviso antes de sair
        window.addEventListener('beforeunload', function (e) {
            if (dirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    })();
</script>
{% endblock %}