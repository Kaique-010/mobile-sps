{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'css/ui.css' %}">


<div class="container py-4">
  <div class="card shadow-lg border-0">
    <div class="card-header text-center py-3">
      <h3 class="mb-0 d-flex align-items-center justify-content-center">
        <i class="bi bi-wrench-adjustable me-2"></i>
        {% if form.instance.pk %}Editar Ordem de Serviço{% else %}Nova Ordem de Serviço{% endif %}
      </h3>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post">
          {% csrf_token %}

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Empresa</label>
              {{ form.osex_empr }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Filial</label>
              {{ form.osex_fili }}
            </div>
            <div class="col-md-6 position-relative">
              <label class="form-label">Cliente</label>
              <input type="text" id="autocomplete-cliente" class="form-control"
                placeholder="Buscar cliente por código ou nome..." />
              {{ form.osex_clie }}
              <small class="text-success d-block mt-1" id="cliente-selecionado"></small>
            </div>

            <div class="col-md-6 position-relative">
              <label class="form-label">Responsável</label>
              <input type="text" id="autocomplete-responsavel" class="form-control"
                placeholder="Buscar responsável por código ou nome..." />
              {{ form.osex_resp }}
              <small class="text-success d-block mt-1" id="responsavel-selecionado"></small>
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              {{ form.osex_stat }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor Total</label>
              {{ form.osex_valo_tota }}
            </div>

            <div class="col-md-3">
              <label class="form-label">Data Abertura</label>
              {{ form.osex_data_aber }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Data Fechamento</label>
              {{ form.osex_data_fech }}
            </div>

            <div class="col-12">
              <label class="form-label">Justificativa Cancelamento</label>
              {{ form.osex_canc_just }}
            </div>

            <div class="col-md-3">
              <label class="form-label">Usuário Cancelamento</label>
              {{ form.osex_canc_usua }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Usuário</label>
              {{ form.osex_usua }}
            </div>

            <div class="col-md-3">
              <label class="form-label">KM Inicial</label>
              {{ form.osex_km_inic }}
            </div>
            <div class="col-md-3">
              <label class="form-label">KM Total</label>
              {{ form.osex_km_tota }}
            </div>
          </div>

          <div class="card shadow-sm mt-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0 text-center">Serviços</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="add-servico">
                  <i class="bi bi-plus-circle"></i> Adicionar serviço
                </button>
              </div>
              {{ servicos_formset.management_form }}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Serviço</th>
                      <th class="text-center">Quantidade</th>
                      <th class="text-end">Preço Unit.</th>
                      <th class="text-end">Total</th>
                      <th class="text-center">Remover</th>
                    </tr>
                  </thead>
                  <tbody id="servicos-body">
                    {% for f in servicos_formset.forms %}
                    <tr class="servico-row">
                      <td class="position-relative">
                        <input type="text" class="form-control autocomplete-prod" data-prefix="servicos"
                          data-index="{{ forloop.counter0 }}" placeholder="Buscar serviço..." />
                        {{ f.serv_prod }}
                        <input type="checkbox" name="servicos-{{ forloop.counter0 }}-DELETE"
                          id="id_servicos-{{ forloop.counter0 }}-DELETE" class="visually-hidden">
                      </td>
                      <td><input type="number" name="servicos-{{ forloop.counter0 }}-serv_quan"
                          class="form-control text-center" min="1" value="{{ f.initial.serv_quan|default:" 1" }}"></td>
                      <td><input type="number" name="servicos-{{ forloop.counter0 }}-serv_valo_unit"
                          class="form-control text-end" step="0.01" value="{{ f.initial.serv_valo_unit|default:" 0.00"
                          }}"></td>
                      <td><input type="number" name="servicos-{{ forloop.counter0 }}-serv_valo_tota"
                          class="form-control text-end" step="0.01" value="{{ f.initial.serv_valo_tota|default:" 0.00"
                          }}" readonly></td>
                      <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-servico"><i
                            class="bi bi-trash"></i></button></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr class="table-light">
                      <td colspan="3" class="text-end">Total serviços</td>
                      <td><input type="number" id="total-servicos" class="form-control text-end" step="0.01"
                          value="0.00" readonly></td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    function createDropdown(container) {
      let dd = container.querySelector('.autocomplete-dropdown');
      if (!dd) {
        dd = document.createElement('div');
        dd.className = 'autocomplete-dropdown list-group position-absolute w-100';
        dd.style.zIndex = '1000';
        container.appendChild(dd);
      }
      return dd;
    }

    function setupInputAutocomplete({ inputEl, hiddenEl, url, onSelect }) {
      if (!inputEl || !hiddenEl) return;
      const container = inputEl.parentElement;
      const dropdown = createDropdown(container);
      let controller = null;
      let debounce = null;
      async function fetchResults(term) {
        try {
          if (controller) controller.abort();
          controller = new AbortController();
          const resp = await fetch(`${url}?term=${encodeURIComponent(term)}`, { signal: controller.signal });
          const json = await resp.json();
          const results = json.results || [];
          dropdown.innerHTML = '';
          results.forEach(item => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = item.text;
            a.dataset.id = item.id;
            a.addEventListener('click', (ev) => {
              ev.preventDefault();
              hiddenEl.value = item.id;
              inputEl.value = item.text;
              dropdown.innerHTML = '';
              if (typeof onSelect === 'function') onSelect(item);
            });
            dropdown.appendChild(a);
          });
        } catch (e) { console.error('Erro no autocomplete:', e); }
      }
      inputEl.addEventListener('input', (e) => {
        const term = e.target.value.trim();
        clearTimeout(debounce);
        dropdown.innerHTML = '';
        if (term.length < 2) return;
        debounce = setTimeout(() => fetchResults(term), 250);
      });
      document.addEventListener('click', (e) => { if (!container.contains(e.target)) dropdown.innerHTML = ''; });
    }

    (function bindAutocompletes() {
      const clientesUrl = "{% url 'OsExterna:autocomplete_clientes' slug=slug %}";
      const responsaveisUrl = "{% url 'OsExterna:autocomplete_responsaveis' slug=slug %}";
      setupInputAutocomplete({
        inputEl: document.getElementById('autocomplete-cliente'),
        hiddenEl: document.getElementById('id_osex_clie'),
        url: clientesUrl,
        onSelect: (item) => { const el = document.getElementById('cliente-selecionado'); if (el) el.textContent = `✓ ${item.text}`; }
      });
      setupInputAutocomplete({
        inputEl: document.getElementById('autocomplete-responsavel'),
        hiddenEl: document.getElementById('id_osex_resp'),
        url: responsaveisUrl,
        onSelect: (item) => { const el = document.getElementById('responsavel-selecionado'); if (el) el.textContent = `✓ ${item.text}`; }
      });
    })();

    (function bindServicosUI() {
      const produtosUrl = "{% url 'OsExterna:autocomplete_produtos' slug=slug %}";
      const $servicosBody = document.getElementById('servicos-body');
      const $totalServ = document.getElementById('total-servicos');

      function fmt(n) { return (parseFloat(n || 0).toFixed(2)); }
      function num(v) { const n = parseFloat((v || '0').toString().replace(',', '.')); return isNaN(n) ? 0 : n; }

      function recalcTotals() {
        let total = 0;
        $servicosBody.querySelectorAll('.servico-row').forEach(row => {
          const del = row.querySelector('input[name$="-DELETE"]');
          if (del && del.checked) return;
          const q = num(row.querySelector('input[name$="-serv_quan"]').value);
          const u = num(row.querySelector('input[name$="-serv_valo_unit"]').value);
          const t = q * u;
          const totEl = row.querySelector('input[name$="-serv_valo_tota"]');
          if (totEl) totEl.value = fmt(t);
          total += t;
        });
        if ($totalServ) $totalServ.value = fmt(total);
      }

      function createDropdown(container) {
        let dd = container.querySelector('.autocomplete-dropdown');
        if (!dd) {
          dd = document.createElement('div');
          dd.className = 'autocomplete-dropdown list-group position-absolute w-100';
          dd.style.zIndex = '1000';
          container.appendChild(dd);
        }
        return dd;
      }

      function setupInputAutocomplete({ inputEl, hiddenEl, url, onSelect }) {
        if (!inputEl || !hiddenEl) return;
        const container = inputEl.parentElement;
        const dropdown = createDropdown(container);
        let controller = null;
        let debounce = null;
        async function fetchResults(term) {
          try {
            if (controller) controller.abort();
            controller = new AbortController();
            const resp = await fetch(`${url}?term=${encodeURIComponent(term)}`, { signal: controller.signal });
            const json = await resp.json();
            const results = json.results || [];
            dropdown.innerHTML = '';
            results.forEach(item => {
              const a = document.createElement('a');
              a.href = '#';
              a.className = 'list-group-item list-group-item-action';
              a.textContent = item.text;
              a.dataset.id = item.id;
              a.addEventListener('click', (ev) => {
                ev.preventDefault();
                hiddenEl.value = item.id;
                inputEl.value = item.text;
                dropdown.innerHTML = '';
                if (typeof onSelect === 'function') onSelect(item);
              });
              dropdown.appendChild(a);
            });
          } catch (e) { console.error('Erro no autocomplete:', e); }
        }
        inputEl.addEventListener('input', (e) => {
          const term = e.target.value.trim();
          clearTimeout(debounce);
          dropdown.innerHTML = '';
          if (term.length < 2) return;
          debounce = setTimeout(() => fetchResults(term), 250);
        });
        document.addEventListener('click', (e) => { if (!container.contains(e.target)) dropdown.innerHTML = ''; });
      }

      function bindProdutoAutocomplete(context) {
        const rows = (context instanceof HTMLElement ? context : document).querySelectorAll('.autocomplete-prod');
        rows.forEach(inputEl => {
          if (inputEl.dataset.bound === '1') return;
          inputEl.dataset.bound = '1';
          const idx = inputEl.getAttribute('data-index');
          const hiddenEl = document.getElementById(`id_servicos-${idx}-serv_prod`);
          setupInputAutocomplete({
            inputEl,
            hiddenEl,
            url: produtosUrl,
            onSelect: () => { }
          });
        });
      }

      bindProdutoAutocomplete(document);

      document.body.addEventListener('input', (e) => {
        if (e.target.matches('input[name$="-serv_quan"], input[name$="-serv_valo_unit"]')) {
          recalcTotals();
        }
      });

      document.getElementById('add-servico').addEventListener('click', () => {
        const totalFormsEl = document.querySelector('#id_servicos-TOTAL_FORMS');
        const totalForms = parseInt(totalFormsEl.value);
        totalFormsEl.value = totalForms + 1;
        const tr = document.createElement('tr');
        tr.className = 'servico-row';
        tr.innerHTML = `
        <td class="position-relative">
          <input type="text" class="form-control autocomplete-prod" data-prefix="servicos" data-index="${totalForms}" placeholder="Buscar serviço..." />
          <input type="hidden" name="servicos-${totalForms}-serv_prod" id="id_servicos-${totalForms}-serv_prod" />
          <input type="checkbox" name="servicos-${totalForms}-DELETE" id="id_servicos-${totalForms}-DELETE" class="visually-hidden">
        </td>
        <td><input type="number" name="servicos-${totalForms}-serv_quan" class="form-control text-center" min="1" value="1"></td>
        <td><input type="number" name="servicos-${totalForms}-serv_valo_unit" class="form-control text-end" step="0.01" value="0.00"></td>
        <td><input type="number" name="servicos-${totalForms}-serv_valo_tota" class="form-control text-end" step="0.01" value="0.00" readonly></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-servico"><i class="bi bi-trash"></i></button></td>
      `;
        $servicosBody.appendChild(tr);
        bindProdutoAutocomplete(tr);
        recalcTotals();
      });

      document.body.addEventListener('click', (e) => {
        if (e.target.closest('.remove-servico')) {
          const row = e.target.closest('tr');
          if (!row) return;
          const del = row.querySelector('input[name$="-DELETE"]');
          if (del) del.checked = true;
          row.classList.add('deleted');
          row.style.display = 'none';
          recalcTotals();
        }
      });

      recalcTotals();
    })();
  </script>
  {% endblock %}