{% extends 'base.html' %}
{% load static %}
{% block title %}Alíquotas IBPT{% endblock %}

{% block content %}
<div class="container page-container">
  <div class="page-header-custom">
    <h2 class="page-title"><i class="bi bi-percent"></i> Alíquotas IBPT</h2>
    <div class="page-actions">
      <a href="{% url 'ncmaliquota_list' slug=slug %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar à Lista
      </a>
    </div>
  </div>

  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
  {% endif %}

  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-4">
            <label for="{{ form.nali_ncm.id_for_label }}">NCM</label>
            {{ form.nali_ncm }}
            <datalist id="ncm-codes"></datalist>
            <div id="ncm-suggest" class="list-group mt-1" style="max-height:200px; overflow:auto;"></div>
          </div>
          <div class="col-md-2">
            <label for="{{ form.nali_aliq_ipi.id_for_label }}">IPI (%)</label>
            {{ form.nali_aliq_ipi }}
          </div>
          <div class="col-md-2">
            <label for="{{ form.nali_aliq_pis.id_for_label }}">PIS (%)</label>
            {{ form.nali_aliq_pis }}
          </div>
          <div class="col-md-2">
            <label for="{{ form.nali_aliq_cofins.id_for_label }}">COFINS (%)</label>
            {{ form.nali_aliq_cofins }}
          </div>
          <div class="col-md-2">
            <label for="{{ form.nali_aliq_cbs.id_for_label }}">CBS (%)</label>
            {{ form.nali_aliq_cbs }}
          </div>
          <div class="col-md-2">
            <label for="{{ form.nali_aliq_ibs.id_for_label }}">IBS (%)</label>
            {{ form.nali_aliq_ibs }}
          </div>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2"></i> Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
(function(){
  var input = document.getElementById('{{ form.nali_ncm.id_for_label }}');
  var list = document.getElementById('ncm-codes');
  var suggest = document.getElementById('ncm-suggest');
  var slug = '{{ slug }}';
  var cacheKey = 'ncm_auto_' + slug;
  function renderDatalist(items){
    if(!list) return;
    list.innerHTML='';
    items.forEach(function(it){
      var opt = document.createElement('option');
      opt.value = it.value;
      opt.textContent = it.label;
      list.appendChild(opt);
    });
  }
  function renderSuggest(items){
    if(!suggest) return;
    suggest.innerHTML='';
    items.slice(0,10).forEach(function(it){
      var a = document.createElement('a');
      a.href = '#'; a.className='list-group-item list-group-item-action';
      a.textContent = it.label;
      a.addEventListener('click', function(e){
        e.preventDefault();
        input.value = it.value;
        suggest.innerHTML='';
      });
      suggest.appendChild(a);
    });
  }
  function fetchSuggest(q){
    var url = '/web/' + slug + '/produtos/autocomplete/ncms/?q=' + encodeURIComponent(q);
    fetch(url).then(function(r){return r.json()}).then(function(data){
      var items = (data&&data.results)||[];
      try{ localStorage.setItem(cacheKey, JSON.stringify(items)); }catch(e){}
      renderDatalist(items); renderSuggest(items);
    }).catch(function(){
      var cached = localStorage.getItem(cacheKey);
      if(cached){ try{ var items = JSON.parse(cached)||[]; renderDatalist(items); renderSuggest(items);}catch(e){} }
    });
  }
  if(input){
    input.addEventListener('input', function(){
      var q = input.value.trim();
      if(q.length>=2){ fetchSuggest(q); }
      else { suggest.innerHTML=''; }
    });
    var cached = localStorage.getItem(cacheKey);
    if(cached){ try{ var items = JSON.parse(cached)||[]; renderDatalist(items);}catch(e){} }
  }
})();
</script>
{% endblock %}