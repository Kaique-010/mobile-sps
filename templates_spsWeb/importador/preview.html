{% extends "base.html" %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/list.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">



<form method="POST" action="{% url 'confirmar_importacao_produtos' slug=slug %}">
    {% csrf_token %}
    <div class="container my-4">
        <div class="container align-items-center">
            <h2 class="page-title"><i class="bi bi-cash-stack"></i> Preview do Arquivo</h2>
        </div>
    </div>
    <p class="text-muted text-center">Confirme ou ajuste o mapeamento dos campos antes de importar.</p>

    {% if dup_count and dup_count > 0 %}
    <div class="alert alert-warning">Descrições duplicadas detectadas: {{ dup_count }}</div>
    {% endif %}

    <div class="container my-4">    
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Coluna do XLS</th>
                <th>Mapeamento Detectado ( campos do SPS )</th>
            </tr>
        </thead>
        <tbody>
            {% for origem, destino in pairs %}
            <tr>
                <td>{{ origem }}</td>
                <td>
                    <input name="map_{{ forloop.counter0 }}" class="form-control" value="{{ destino }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4>Prévia dos Dados</h4>
    <table class="table table-striped small">
        <thead>
            <tr>
                {% for col in colunas_origem %}
                <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>

        <tbody>
            {% for r in preview_rows %}
            <tr class="{% if dup_values and r.name in dup_values %}table-warning{% endif %}">
                {% for cell in r.cells %}
                <td>{{ cell }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button class="btn btn-success w-100" id="btn-confirm">
        <span class="spinner-border spinner-border-sm me-2 d-none" aria-hidden="true"></span>
        Confirmar Importação
    </button>
    <div id="confirm-progress" class="mt-3 d-none">
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"
                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
</form>

<script>
    (() => {
        const form = document.querySelector('form');
        const btn = document.getElementById('btn-confirm');
        const spin = btn?.querySelector('.spinner-border');
        const cont = document.getElementById('confirm-progress');
        const bar = cont?.querySelector('.progress-bar');
        let timer = null;
        form?.addEventListener('submit', () => {
            if (btn) btn.disabled = true;
            if (spin) spin.classList.remove('d-none');
            if (cont) cont.classList.remove('d-none');
            let val = 0;
            timer = setInterval(() => {
                val = Math.min(val + Math.random() * 10 + 5, 95);
                if (bar) { bar.style.width = val + '%'; bar.setAttribute('aria-valuenow', String(Math.floor(val))); }
            }, 200);
        });
        window.addEventListener('beforeunload', () => { if (timer) clearInterval(timer); });
    })();
</script>

{% endblock %}