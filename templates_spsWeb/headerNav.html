{% load static %}
<style>
    /* Rodapé fixo do offcanvas */
    .offcanvas {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
    }

    .offcanvas-body {
        padding: 0;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
    }

    .offcanvas-content {
        display: flex;
        flex-direction: column;
        flex: 1 1 auto;
        min-height: 0;
    }

    .navbar-brand,
    .offcanvas-title {
        font-size: 1.2rem;
        font-family: 'Fauna', serif;
        font-weight: bold;
        color: var(--bs-body-color);
    }
</style>
<header class="bg-body">
    <nav class="navbar fixed-top bg-body" id="main-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/web/login/" data-slug-route="/web/{slug}/home/">SPS WEB</a>
            <img src="{% static 'logo.png' %}" style="height:32px; margin-right: 35Px;" />
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasDarkNavbar" aria-controls="offcanvasDarkNavbar" aria-label="Abrir menu">
                <i class="bi bi-list fs-2"></i>
            </button>
            <div class="offcanvas offcanvas-end bg-body" tabindex="-1" id="offcanvasDarkNavbar"
                aria-labelledby="offcanvasDarkNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasDarkNavbarLabel">SPS WEB</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="px-3 pt-2">
                        <div id="login-warning" class="alert alert-warning d-none">Necessário Estar Logado</div>
                        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="/web/login/"
                                    data-slug-route="/web/{slug}/home/">
                                    <i class="bi bi-house fs-3"></i> Home
                                </a>
                            </li>

                            {% include 'parciais/navcadastros.html' %}

                            {% include 'parciais/navcompras.html' %}

                            {% include 'parciais/navestoque.html' %}

                            {% include 'parciais/navfinanceiro.html' %}

                            {% include 'parciais/navvendas.html' %}

                            {% include 'parciais/navvisitas.html' %}

                            {% include 'parciais/navmetricas.html' %}

                            {% include 'parciais/navos.html' %}

                            {% include 'parciais/navagricola.html' %}
                            {% include 'parciais/navnotificacoes.html' %}
                            {% include 'parciais/navcentraldeajuda.html' %}
                            {% include 'parciais/navconfiguracoes.html' %}
                        </ul>
                    </div>
                </div>
                <div class="offcanvas-footer bg-body px-3 py-3 d-flex gap-2">

                    <a href="/web/selecionar-empresa/" class="btn btn-outline-primary">
                        <i class="bi bi-building"></i> Trocar Empresa/Filial
                    </a>
                    <button id="logout-jwt" class="btn btn-outline-danger" type="button">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </button>
                    <button id="theme-toggle" type="button" class="btn btn-outline-dark" title="Alternar tema">
                        <i class="bi bi-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
</header>

<script>
    // Controla visibilidade do menu conforme módulos liberados para empresa/filial
    (() => {
        const access = localStorage.getItem('access');
        const slug = localStorage.getItem('slug');
        const empresaId = localStorage.getItem('empresa_id');
        const filialId = localStorage.getItem('filial_id');

        const $warning = document.getElementById('login-warning');
        const showWarning = (msg) => {
            if ($warning) {
                $warning.textContent = msg || 'Necessário Estar Logado';
                $warning.classList.remove('d-none');
            }
        };

        if (!access || !slug) {
            showWarning('Necessário Estar Logado');
            return;
        }

        // Helper de autenticação com auto-refresh (SimpleJWT)
        const authFetch = async (url, options = {}) => {
            const empresa = localStorage.getItem('empresa_id') || '1';
            const filial = localStorage.getItem('filial_id') || '1';
            const makeHeaders = (token) => ({
                'Authorization': token ? `Bearer ${token}` : '',
                'Content-Type': 'application/json',
                'X-Empresa': empresa,
                'X-Filial': filial,
            });
            const token = localStorage.getItem('access');
            let resp = await fetch(url, { ...options, headers: { ...makeHeaders(token), ...(options.headers || {}) } });
            if (resp.status !== 401) return resp;

            // Tentar refresh
            const refresh = localStorage.getItem('refresh');
            if (!refresh) return resp; // sem refresh, devolve 401
            try {
                const refreshResp = await fetch(`/api/${slug}/auth/token/refresh/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh })
                });
                if (!refreshResp.ok) return resp;
                const data = await refreshResp.json();
                const newAccess = data?.access;
                if (!newAccess) return resp;
                localStorage.setItem('access', newAccess);
                // Refaz a requisição original com novo token
                resp = await fetch(url, { ...options, headers: { ...makeHeaders(newAccess), ...(options.headers || {}) } });
                return resp;
            } catch (e) {
                console.error('Falha no refresh token:', e);
                return resp;
            }
        };

        // Carrega módulos liberados (por nome) e esconde itens não permitidos
        const aplicarModulos = (modulosLiberados) => {
            // Normalizar para comparação case-insensitive
            const allowSet = new Set(modulosLiberados.map(m => String(m).toLowerCase()));
            // Aliases globais para nomes de módulos (comparação flexível)
            const aliases = {
                'dashboard': ['dashboard', 'dashboards', 'métricas', 'dash'],
                'o_s': ['o_s', 'ordens de serviço', 'os'],
                'parametros_admin': ['parametros_admin', 'parametrizações', 'parametros'],
                // Aliases comuns para módulo de pedidos/vendas
                'pedidos': ['pedidos', 'pedido', 'pedido venda', 'pedido_venda', 'pv', 'vendas', 'Pedidos', 'listacasamento', 'pedidosvenda', 'métricas'],
                // Aliases para orçamentos
                'orcamentos': ['orcamentos', 'orçamentos', 'orcamento', 'orçamento', 'budget'],
                // Aliases para Centros de Custos
                'compras/entradas': ['compras/entradas', 'compras/entrada', 'compras/entradas dashboard', 'compras/entradas_dashboard'],
                // Aliases para Compras
                'compras': ['compras', 'compra', 'compras dashboard', 'compras_dashboard'],
                // Aliases para Finanças
                'financas': ['financas', 'financeiro', 'financeiro dashboard', 'financeiro_dashboard'],
                'centrosdecustos': ['centrosdecustos', 'centrodecustos', 'centros de custos', 'centro de custos', 'cc'],
                // Aliases para Entidades
                'entidades': ['entidades', 'entidade', 'cadastro entidades'],
                // Aliases para Visitas
                'controledevisitas': ['controledevisitas', 'visitas', 'visita', 'visitas dashboard', 'visitas_dashboard', 'controle_de_visitas', 'controle de visitas', 'ControleDeVisitas']
            };
            const normalize = (s) => String(s || '').toLowerCase().trim();
            const tokenMatch = (value) => {
                const n = normalize(value);
                if (!n) return false;
                if (allowSet.has(n)) return true;
                const tokens = n.split(/[\s/_-]+/).filter(Boolean);
                if (tokens.some(t => allowSet.has(t))) return true;
                return tokens.some(t => (
                    Object.entries(aliases).some(([key, vals]) => {
                        const setHasKey = allowSet.has(key);
                        const setHasAnyAlias = vals.some(v => allowSet.has(v));
                        const isAliasName = (t === key) || vals.includes(t);
                        return isAliasName && (setHasKey || setHasAnyAlias);
                    })
                ));
            };
            const tokenMatchStrict = (value) => {
                const n = normalize(value);
                if (!n) return false;
                if (allowSet.has(n)) return true;
                const tokens = n.split(/[\s/_-]+/).filter(Boolean);
                // Sem promoção via aliases: apenas presença direta de tokens
                return tokens.some(t => allowSet.has(t));
            };
            document.querySelectorAll('[data-modulo]')?.forEach(el => {
                const nome = el.getAttribute('data-modulo');
                if (!tokenMatch(nome)) {
                    el.style.display = 'none';
                }
            });

            // Ocultar itens que requerem módulo específico (menus colapsáveis)
            document.querySelectorAll('[data-modulo-requerido]')?.forEach(el => {
                const req = el.getAttribute('data-modulo-requerido');
                if (!tokenMatchStrict(req)) {
                    const li = el.closest('li.nav-item') || el;
                    if (li) li.style.display = 'none';
                    const target = el.getAttribute('data-bs-target');
                    if (target) {
                        const collapse = document.querySelector(target);
                        if (collapse) collapse.remove();
                    }
                }
            });

            // Exibir itens que aceitam qualquer entre múltiplos módulos
            document.querySelectorAll('[data-modulos-any]')?.forEach(el => {
                const raw = el.getAttribute('data-modulos-any') || '';
                const list = raw.split(',').map(s => String(s).trim()).filter(Boolean);
                const ok = list.some(t => tokenMatch(t));
                if (!ok) {
                    const li = el.closest('li.nav-item') || el;
                    if (li) li.style.display = 'none';
                    const target = el.getAttribute('data-bs-target');
                    if (target) {
                        const collapse = document.querySelector(target);
                        if (collapse) collapse.remove();
                    }
                }
            });
        };

        const loadModulos = async () => {
            try {
                // Preferimos endpoint que retorna nomes: detail=False action em viewset
                const params = new URLSearchParams({ empresa_id: empresaId || '1', filial_id: filialId || '1' });
                const resp = await authFetch(`/api/${slug}/parametros-admin/permissoes-modulos/modulos_empresa_filial/?${params.toString()}`);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                const nomes = data?.modulos_liberados || [];
                // Se não houver permissões configuradas, usar módulos globais ativos
                if (!Array.isArray(nomes) || nomes.length === 0) {
                    const respGlobais = await authFetch(`/api/${slug}/parametros-admin/permissoes-modulos/modulos_disponiveis/`);
                    if (!respGlobais.ok) throw new Error(`Globais HTTP ${respGlobais.status}`);
                    const globais = await respGlobais.json();
                    const nomesAtivos = (globais?.modulos || []).filter(m => m.modu_ativ).map(m => m.modu_nome);
                    aplicarModulos(nomesAtivos);
                } else {
                    aplicarModulos(nomes);
                }
            } catch (err) {
                console.error('Falha ao carregar módulos liberados:', err);
                // Fallback: tentar endpoint por códigos e buscar nomes globais para mapear
                try {
                    const params = new URLSearchParams({ empr: empresaId || '1', fili: filialId || '1' });
                    const [respCodes, respGlobais] = await Promise.all([
                        authFetch(`/api/${slug}/parametros-admin/modulos_liberados/?${params.toString()}`),
                        authFetch(`/api/${slug}/parametros-admin/permissoes-modulos/modulos_disponiveis/`)
                    ]);
                    if (!respCodes.ok || !respGlobais.ok) throw new Error('Fallback endpoints indisponíveis');
                    const codData = await respCodes.json();
                    const globais = await respGlobais.json();
                    const liberadosCodigos = new Set((codData?.modulos_liberados || []).map(c => Number(c)));
                    const nomesLiberados = (globais?.modulos || []).
                        filter(m => liberadosCodigos.has(Number(m.modu_codi))).
                        map(m => m.modu_nome);
                    // Se ainda vazio, cair para todos módulos ativos
                    const finalNames = (Array.isArray(nomesLiberados) && nomesLiberados.length > 0)
                        ? nomesLiberados
                        : (globais?.modulos || []).filter(m => m.modu_ativ).map(m => m.modu_nome);
                    aplicarModulos(finalNames);
                } catch (err2) {
                    console.error('Fallback falhou:', err2);
                    showWarning('Erro ao validar módulos');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', loadModulos);

        // Ajusta links com base no slug armazenado
        document.addEventListener('DOMContentLoaded', () => {
            const slug = localStorage.getItem('slug');
            const links = document.querySelectorAll('[data-slug-route]');
            links.forEach(el => {
                const pattern = el.getAttribute('data-slug-route');
                if (!pattern) return;
                if (slug) {
                    el.setAttribute('href', pattern.replace('{slug}', slug));
                } else {
                    // Sem slug, mantém fallback para login web
                    el.setAttribute('href', '/web/login/');
                }
            });
            // Itens por role são controlados no template via request.user
        });

        // Ordena alfabeticamente os itens de lista dentro dos menus colapsáveis
        const normalizeText = (el) => (el.textContent || '').replace(/\s+/g, ' ').trim();
        const sortCollapsedLists = () => {
            document.querySelectorAll('.collapse ul')?.forEach(ul => {
                const items = Array.from(ul.querySelectorAll(':scope > li'));
                items.sort((a, b) => normalizeText(a).localeCompare(normalizeText(b), 'pt-BR', { sensitivity: 'base' }));
                items.forEach(li => ul.appendChild(li));
            });
        };



        // Aplica a ordenação após o carregamento inicial
        document.addEventListener('DOMContentLoaded', sortCollapsedLists);

        // Ordena alfabeticamente o menu principal (itens de primeiro nível)
        const getItemLabel = (li) => {
            const a = li.querySelector(':scope > a.nav-link');
            return normalizeText(a || li);
        };
        const sortMainMenu = () => {
            const ul = document.querySelector('ul.navbar-nav');
            if (!ul) return;
            const items = Array.from(ul.querySelectorAll(':scope > li.nav-item'));
            const homeItems = items.filter(li => /^(home)$/i.test(getItemLabel(li)));
            const otherItems = items.filter(li => !/^(home)$/i.test(getItemLabel(li)));
            otherItems.sort((a, b) => getItemLabel(a).localeCompare(getItemLabel(b), 'pt-BR', { sensitivity: 'base' }));
            [...homeItems, ...otherItems].forEach(li => ul.appendChild(li));
        };
        document.addEventListener('DOMContentLoaded', sortMainMenu);
    })();
</script>