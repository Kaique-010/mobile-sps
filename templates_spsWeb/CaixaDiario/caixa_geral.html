{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/ui.css' %}">
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="toastSucesso" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Caixa aberto com sucesso</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Close"></button>
    </div>
  </div>
</div>
<div class="container py-4">
  <div class="container align-items-center">
    <h2 class="page-title text-center mb-5"><i class="bi bi-cash-coin"></i> Caixa Diário — Abertura</h2>
  </div>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header" style="font-size: 20px;">Abrir Caixa</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Caixa</label>
            <div class="input-group">
              <input type="number" class="form-control" id="caix_caix" placeholder="Número do caixa">
              <button class="btn btn-outline-secondary" type="button" id="btnBuscarCaixa">Buscar</button>
            </div>
          </div>
          <div class="list-group mt-2" id="caixaSugestoes"></div>
          <div class="mb-3">
            <label class="form-label">Origem (Número do caixa)</label>
            <input type="hidden" id="caix_orig">
            <div class="input-group">
              <input class="form-control" id="origemBusca" placeholder="Buscar Caixas...">
              <button class="btn btn-outline-secondary" type="button" id="btnBuscarOrigem">Buscar</button>
            </div>
            <div class="list-group mt-2" id="origemSugestoes"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Data de Abertura</label>
            <input type="date" class="form-control" id="caix_data" value="{{ now|date:'Y-m-d' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Valor Inicial</label>
            <input type="number" step="0.01" class="form-control" id="caix_valo" placeholder="0,00">
          </div>
          <div class="mb-3">
            <label class="form-label">Operador</label>
            <input type="number" class="form-control" id="caix_oper" placeholder="ID do operador">
            <div class="input-group mt-2">
              <input class="form-control" id="operadorBusca" placeholder="Buscar Vendedores...">
              <button class="btn btn-outline-secondary" type="button" id="btnBuscarOperador">Buscar</button>
            </div>
            <div class="list-group mt-2" id="operadorSugestoes"></div>
          </div>
          <div class="d-grid">
            <button class="btn btn-outline-primary" id="btnAbrirCaixa">Abrir Caixa</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header" style="font-size: 20px;">Status Atual</div>
        <div class="card-body">
          <div class="d-flex align-items-center gap-2">
            <div id="statusIndicator" style="width:12px;height:12px;border-radius:50%;background-color:transparent;">
            </div>
            <div id="statusCaixa" class="text-success if (statusCaixa.textContent === 'caixa abert')" style="font-size: 18px;">Verificando...</div>
          </div>
          <div class="mt-3 d-grid"><a
              class="btn btn-outline-success btn-lg d-flex justify-content-center align-items-center gap-2 w-100"
              id="btnMovimentacoes" href="#"><i class="bi bi-cash-stack"></i>
              
              <span>Movimentações</span></a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const slug = '{{ slug|default:"" }}' || (function () { try { const p = location.pathname.split('/'); return p.length > 2 ? p[2] : ''; } catch (e) { return ''; } })();
    const empresa = '{{ empresa|default:"" }}' || localStorage.getItem('empresaId') || sessionStorage.getItem('empresaId') || '';
    const filial = '{{ filial|default:"" }}' || localStorage.getItem('filialId') || sessionStorage.getItem('filialId') || '';
    function getCSRFToken() { try { const name = 'csrftoken='; for (let c of document.cookie.split(';')) { c = c.trim(); if (c.startsWith(name)) return c.substring(name.length); } } catch (e) { } return ''; }
    function headersJSON() { const h = { 'Accept': 'application/json', 'Content-Type': 'application/json' }; const t = localStorage.getItem('access') || sessionStorage.getItem('access'); if (t) h['Authorization'] = `Bearer ${t}`; if (empresa) h['X-Empresa'] = empresa; if (filial) h['X-Filial'] = filial; h['X-CSRFToken'] = getCSRFToken(); return h; }
    async function checarAberto() {
      const statusEl = document.getElementById('statusCaixa');
      const indicator = document.getElementById('statusIndicator');
      if (!empresa || !filial) {
        if (statusEl) statusEl.textContent = 'Informe empresa/filial (login/contexto)';
        if (indicator) { indicator.style.backgroundColor = 'transparent'; indicator.style.animation = 'none'; }
        return;
      }
      const url = `/web/${slug}/caixa-diario/caixas/abertos/`;
      const r = await fetch(url, { credentials: 'same-origin', headers: headersJSON() });
      if (!r.ok) {
        if (statusEl) statusEl.textContent = 'Erro ao verificar';
        if (indicator) { indicator.style.backgroundColor = 'transparent'; indicator.style.animation = 'none'; }
        return;
      }
      const d = await r.json();
      const arr = (d.results || []);
      if (arr.length > 0) {
        if (statusEl) statusEl.textContent = 'Caixa aberto';
        const c = arr[0];
        const caixNum = (c?.caixa || c?.caix_caix || '');
        document.getElementById('btnMovimentacoes').href = `/web/${slug}/caixa-diario/venda/?caixa=${caixNum}`;
        if (indicator) {
          indicator.style.backgroundColor = '#28a745';
          indicator.style.animation = 'pulse-green 1s infinite';
        }
      } else {
        if (statusEl) statusEl.textContent = 'Nenhum caixa aberto';
        if (indicator) { indicator.style.backgroundColor = 'transparent'; indicator.style.animation = 'none'; }
      }
    }
    function showSucessoToast() { try { const el = document.getElementById('toastSucesso'); if (window.bootstrap && window.bootstrap.Toast) { const t = new window.bootstrap.Toast(el); t.show(); } else { el.classList.add('show'); setTimeout(() => { el.classList.remove('show'); }, 3000); } } catch (e) { alert('Caixa aberto com sucesso'); } }
    async function abrirCaixa() {
      const usuarioRaw = localStorage.getItem('usuario') || sessionStorage.getItem('usuario');
      let operador = document.getElementById('caix_oper').value || '';
      if (!operador && usuarioRaw) {
        try {
          operador = JSON.parse(usuarioRaw)?.usuario_id || '';
        } catch (e) { }
      }
      const origemHidden = (document.getElementById('caix_orig').value || '').trim();
      const origemBuscaVal = (document.getElementById('origemBusca').value || '').trim();
      const origemBase = origemHidden || origemBuscaVal || (document.getElementById('caix_caix').value || '');
      const payload = {
        caix_empr: Number(empresa),
        caix_fili: Number(filial),
        caix_caix: Number(document.getElementById('caix_caix').value || 0),
        caix_data: document.getElementById('caix_data').value || new Date().toISOString().slice(0, 10),
        caix_aber: 'A',
        caix_oper: Number(operador || 0),
        caix_valo: Number(document.getElementById('caix_valo').value || 0),
        caix_orig: Number(origemBase || 0),
      };
      const r = await fetch(`/api/${slug}/caixadiario/caixageral/`, { method: 'POST', credentials: 'same-origin', headers: headersJSON(), body: JSON.stringify(payload) });
      if (!r.ok) { const txt = await r.text(); alert('Falha na abertura: ' + txt); return; }
      await checarAberto(); showSucessoToast();
    }
    async function buscarOrigens() { if (!empresa || !filial) return; const termo = (document.getElementById('origemBusca').value || '').trim(); const url = `/web/${slug}/caixa-diario/origens/?q=${encodeURIComponent(termo)}`; const r = await fetch(url, { credentials: 'same-origin', headers: headersJSON() }); if (!r.ok) return; const d = await r.json(); const lis = document.getElementById('origemSugestoes'); lis.innerHTML = ''; (d.results || []).forEach(v => { const id = typeof v === 'object' && v !== null ? (v.id ?? v.caix_caix ?? '') : v; const label = typeof v === 'object' && v !== null ? (v.text ?? `${v.caix_caix} - ${v.caix_oper ?? ''}`) : String(v); const a = document.createElement('a'); a.href = '#'; a.className = 'list-group-item list-group-item-action'; a.textContent = label; a.addEventListener('click', (ev) => { ev.preventDefault(); document.getElementById('origemBusca').value = label; document.getElementById('caix_orig').value = String(id); lis.innerHTML = ''; }); lis.appendChild(a); }); }
    async function buscarOperadores() { const termo = (document.getElementById('operadorBusca').value || '').trim(); const url = `/web/${slug}/caixa-diario/autocomplete/vendedores/?q=${encodeURIComponent(termo)}`; const r = await fetch(url, { credentials: 'same-origin', headers: headersJSON() }); if (!r.ok) return; const d = await r.json(); const lis = document.getElementById('operadorSugestoes'); lis.innerHTML = ''; (d.results || []).forEach(v => { const a = document.createElement('a'); a.href = '#'; a.className = 'list-group-item list-group-item-action'; a.textContent = String(v.text || v.id); a.addEventListener('click', (ev) => { ev.preventDefault(); document.getElementById('operadorBusca').value = String(v.text || v.id); document.getElementById('caix_oper').value = String(v.id); lis.innerHTML = ''; }); lis.appendChild(a); }); }
    async function buscarCaixa() { if (!empresa || !filial) return; const termo = (document.getElementById('caix_caix').value || '').trim(); const url = `/web/${slug}/caixa-diario/origens/?q=${encodeURIComponent(termo)}`; const r = await fetch(url, { credentials: 'same-origin', headers: headersJSON() }); if (!r.ok) return; const d = await r.json(); const lis = document.getElementById('caixaSugestoes'); lis.innerHTML = ''; (d.results || []).forEach(v => { const id = typeof v === 'object' && v !== null ? (v.id ?? v.caix_caix ?? '') : v; const label = typeof v === 'object' && v !== null ? (v.text ?? `${v.caix_caix} - ${v.caix_oper ?? ''}`) : String(v); const a = document.createElement('a'); a.href = '#'; a.className = 'list-group-item list-group-item-action'; a.textContent = label; a.addEventListener('click', (ev) => { ev.preventDefault(); document.getElementById('caix_caix').value = String(id); lis.innerHTML = ''; }); lis.appendChild(a); }); }
    document.addEventListener('DOMContentLoaded', () => {
      const style = document.createElement('style');
      style.textContent = `
      @keyframes pulse-green {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.5; }
        100% { transform: scale(1); opacity: 1; }
      }
    `;
      document.head.appendChild(style);
      checarAberto();
      document.getElementById('btnAbrirCaixa')?.addEventListener('click', abrirCaixa);
      document.getElementById('btnBuscarCaixa')?.addEventListener('click', buscarCaixa);
      document.getElementById('caix_caix')?.addEventListener('input', () => { const t = document.getElementById('caix_caix').value || ''; if (String(t).length >= 1) buscarCaixa(); });
      document.getElementById('btnBuscarOrigem')?.addEventListener('click', buscarOrigens);
      document.getElementById('origemBusca')?.addEventListener('input', () => { const t = document.getElementById('origemBusca').value || ''; if (t.length >= 1) buscarOrigens(); });
      document.getElementById('btnBuscarOperador')?.addEventListener('click', buscarOperadores);
      document.getElementById('operadorBusca')?.addEventListener('input', () => { const t = document.getElementById('operadorBusca').value || ''; if (t.length >= 1) buscarOperadores(); });
      const oper = localStorage.getItem('usuario_id') || sessionStorage.getItem('usuario_id'); if (oper) document.getElementById('caix_oper').value = oper;
    });
  </script>

  {% endblock %}