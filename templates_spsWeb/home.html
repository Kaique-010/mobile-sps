{% extends 'base.html' %}

{% block title %}Métricas{% endblock %}

{% block content %}
<div class="container page-container">
    <div class="card card-corporate">
        <div class="card-body">
            <div class="page-header">
                <h2 class="page-title text-center"><i class="bi bi-graph-up fs-3 justify-content-center text-center"></i> Overview</h2>
                 <p class="text-body-secondary text-center">Filtre o período e visualize métricas por vendedor.</p>
            </div>
        </div>        
</div>               

            <form id="filtroDashboard" class="mb-5 mt-5" method="get" action="">
                <div class="row g-3">
                    <div class="col-md-4 mb-3 my-3">
                        <label for="vendedor" class="form-label">Vendedor</label>
                        <select id="vendedor" name="vendedor" class="form-select">
                            <option value="">Todos os Vendedores</option>
                            {% for vendedor in vendedores %}
                            <option value="{{ vendedor.enti_nome }}" {% if vendedor.enti_nome == vendedor_selecionado %}selected{% endif %}>
                                {{ vendedor.enti_nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="data_inicio" class="form-label">Data Início</label>
                        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                    </div>
                    <div class="col-md-4">
                        <label for="data_fim" class="form-label">Data Fim</label>
                        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ data_fim }}">
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </form>

            <div class="row g-4">
                <div class="col-lg-6">
                    <h3 class="h6 text-body">Pedidos por Vendedor</h3>
                    <canvas id="totalPedidosChart"></canvas>
                </div>
                <div class="col-lg-6">
                    <h3 class="h6 text-body">Valor Pedidos por Vendedor</h3>
                    <canvas id="totalValorPedidoChart"></canvas>
                </div>
            </div>
            </div>
            </div>


            <script>
                // Helper: datas padrão (últimos 30 dias)
                function getDefaultDates() {
                    const hoje = new Date();
                    const fim = hoje.toISOString().slice(0, 10);
                    const iniDate = new Date(hoje);
                    iniDate.setDate(hoje.getDate() - 30);
                    const ini = iniDate.toISOString().slice(0, 10);
                    return { ini, fim };
                }

                // Helper: fetch autenticado com auto-refresh
                function getAuthHeaders(token) {
                    return token ? { 'Authorization': `Bearer ${token}` } : {};
                }

                async function authFetch(url, options = {}) {
                    const slug = localStorage.getItem('slug');
                    const token = localStorage.getItem('access');
                    const empresa = localStorage.getItem('empresa_id') || '1';
                    const filial = localStorage.getItem('filial_id') || '1';
                    let resp = await fetch(url, { ...options, headers: { 'Content-Type': 'application/json', 'X-Empresa': empresa, 'X-Filial': filial, ...getAuthHeaders(token), ...(options.headers || {}) } });
                    if (resp.status !== 401) return resp;
                    const refresh = localStorage.getItem('refresh');
                    if (!refresh) return resp;
                    try {
                        const refreshResp = await fetch(`/api/${slug}/auth/token/refresh/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ refresh })
                        });
                        if (!refreshResp.ok) return resp;
                        const data = await refreshResp.json();
                        const newAccess = data?.access;
                        if (!newAccess) return resp;
                        localStorage.setItem('access', newAccess);
                        resp = await fetch(url, { ...options, headers: { 'Content-Type': 'application/json', 'X-Empresa': empresa, 'X-Filial': filial, ...getAuthHeaders(newAccess), ...(options.headers || {}) } });
                        return resp;
                    } catch (e) {
                        console.error('Falha no refresh token:', e);
                        return resp;
                    }
                }

                // Estado dos gráficos
                const totalPedidosCtx = document.getElementById('totalPedidosChart');
                const totalValorPedidoCtx = document.getElementById('totalValorPedidoChart');
                let totalPedidosChart = null;
                let totalValorChart = null;

                function upsertCharts(labels, valoresCount, valoresSum) {
                    // Total de Pedidos por Vendedor
                    const baseOptions = {
                        type: 'bar',
                        options: { scales: { y: { beginAtZero: true } } }
                    };

                    const countData = {
                        labels,
                        datasets: [{
                            label: 'Total de Pedidos',
                            data: valoresCount,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    };

                    const sumData = {
                        labels,
                        datasets: [{
                            label: 'Valor Total dos Pedidos',
                            data: valoresSum,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    };

                    if (totalPedidosChart) {
                        totalPedidosChart.data = countData;
                        totalPedidosChart.update();
                    } else if (totalPedidosCtx) {
                        totalPedidosChart = new Chart(totalPedidosCtx.getContext('2d'), { ...baseOptions, data: countData });
                    }

                    if (totalValorChart) {
                        totalValorChart.data = sumData;
                        totalValorChart.update();
                    } else if (totalValorPedidoCtx) {
                        totalValorChart = new Chart(totalValorPedidoCtx.getContext('2d'), { ...baseOptions, data: sumData });
                    }
                }

                async function loadData(paramsOverride = {}) {
                    const slug = localStorage.getItem('slug');
                    const token = localStorage.getItem('access');
                    if (!slug || !token) {
                        alert('Necessário estar logado.');
                        window.location.href = '/web/login/';
                        return;
                    }

                    // Datas padrão
                    const { ini, fim } = getDefaultDates();
                    const dataInicioEl = document.getElementById('data_inicio');
                    const dataFimEl = document.getElementById('data_fim');
                    if (dataInicioEl && !dataInicioEl.value) dataInicioEl.value = ini;
                    if (dataFimEl && !dataFimEl.value) dataFimEl.value = fim;

                    const nomeVendedor = (document.getElementById('vendedor')?.value || '').trim();
                    const data_inicial = dataInicioEl?.value || ini;
                    const data_final = dataFimEl?.value || fim;

                    const params = new URLSearchParams({
                        data_inicial,
                        data_final,
                        limit: '250'
                    });
                    if (nomeVendedor) params.set('nome_vendedor', nomeVendedor);
                    // Endpoint: Pedidos gerais (usaremos para agregar por vendedor)
                    const url = `/api/${slug}/pedidos/pedidos-geral/?${params.toString()}`;

                    try {
                        const resp = await authFetch(url);
                        if (!resp.ok) throw new Error(`Erro ${resp.status}`);
                        const data = await resp.json();
                        const items = Array.isArray(data) ? data : (data.results || []);

                        const porVendedorCount = {};
                        const porVendedorValor = {};
                        for (const item of items) {
                            const vend = item.nome_vendedor || 'N/D';
                            const valor = parseFloat(item.valor_total) || 0;
                            porVendedorCount[vend] = (porVendedorCount[vend] || 0) + 1;
                            porVendedorValor[vend] = (porVendedorValor[vend] || 0) + valor;
                        }

                        const labels = Object.keys(porVendedorCount);
                        const valoresCount = labels.map(v => porVendedorCount[v]);
                        const valoresSum = labels.map(v => porVendedorValor[v]);
                        upsertCharts(labels, valoresCount, valoresSum);
                    } catch (err) {
                        console.error('Falha ao carregar dados do dashboard:', err);
                        upsertCharts([], [], []);
                    }
                }

                // Submit: apenas recarrega os dados sem navegar
                (function () {
                    const form = document.getElementById('filtroDashboard');
                    if (!form) return;
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        loadData();
                    });
                })();

                // Inicializa ao carregar a página
                document.addEventListener('DOMContentLoaded', () => {
                    loadData();
                });
            </script>
        </div>
        {% endblock %}