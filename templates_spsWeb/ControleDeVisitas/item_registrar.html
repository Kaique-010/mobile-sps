{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" x-data>
  <h4 class="mb-3">Novo Item para Visita #{{ ctrl_id }}</h4>
  <form method="post" class="card p-3">
    {% csrf_token %}
    <div class="row g-2">
      <div class="col-md-6 d-none">{{ form.produto_codigo.label_tag }}{{ form.produto_codigo }}</div>
      <div class="col-md-6">
        <label class="form-label">Produto</label>
        <input type="text" id="prod-search" class="form-control" placeholder="Buscar produto" autocomplete="off" />
        <div id="prod-results" class="list-group position-absolute w-100" style="z-index:1060;"></div>
      </div>
      <div class="col-md-3">{{ form.quantidade.label_tag }}{{ form.quantidade }}</div>
      <div class="col-md-3">{{ form.valor_unitario.label_tag }}{{ form.valor_unitario }}</div>
      <div class="col-12">{{ form.observacoes.label_tag }}{{ form.observacoes }}</div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary">Registrar</button>
      <a href="/web/{{ slug }}/controle-de-visitas/resumo/{{ ctrl_id }}/" class="btn btn-outline-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const slug = '{{ slug }}';
    const hidProd = document.getElementById('id_produto_codigo');
    const inp = document.getElementById('prod-search');
    const res = document.getElementById('prod-results');
    let t;
    function fetchAuto(term) {
      const url = `/api/${slug}/controledevisitas/autocomplete/produtos/?q=${encodeURIComponent(term)}&limit=10&offset=0`;
      return fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json()).catch(() => []);
    }
    function render(items) {
      res.innerHTML = '';
      items.forEach(it => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'list-group-item list-group-item-action';
        a.textContent = it.label || '';
        a.addEventListener('click', function (e) { e.preventDefault(); hidProd.value = it.prod_codi; inp.value = it.prod_nome; res.innerHTML = ''; });
        res.appendChild(a);
      });
    }
    inp.addEventListener('input', function () {
      const v = this.value.trim();
      clearTimeout(t);
      if (v.length < 2) { res.innerHTML = ''; return; }
      t = setTimeout(function () { fetchAuto(v).then(render); }, 250);
    });
    document.addEventListener('click', function (e) { if (res && !res.contains(e.target)) res.innerHTML = ''; });
  })();
</script>
{% endblock %}