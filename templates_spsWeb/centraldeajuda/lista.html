{% extends 'base.html' %}

{% block content %}

<style>
  .central-wrapper {
    max-width: 1400px;
    margin: 0 auto;
  }

  .central-title {
    text-align: center;
    font-weight: 600;
    letter-spacing: .2px;
  }

  .module-card .card {
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
    transition: transform .15s ease;
    border: 2px solid;
  }

  .module-card .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
  }

  /* Cores para cada card por linha */
  .module-card .col-12:nth-child(4n+1) .card {
    border-color: #3498db !important;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(52, 152, 219, 0.02));
  }

  .module-card .col-12:nth-child(4n+2) .card {
    border-color: #9b59b6 !important;
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.05), rgba(155, 89, 182, 0.02));
  }

  .module-card .col-12:nth-child(4n+3) .card {
    border-color: #e74c3c !important;
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.05), rgba(231, 76, 60, 0.02));
  }

  .module-card .col-12:nth-child(4n+4) .card {
    border-color: #f39c12 !important;
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.05), rgba(243, 156, 18, 0.02));
  }

  .module-card .card-body {
    padding: 1rem 1.25rem;
  }

  .module-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: .5rem;
  }

  .module-header .badge {
    font-size: .75rem;
  }

  .progress-sm {
    height: 8px;
    border-radius: 6px;
  }

  .progress-sm .progress-bar {
    background: linear-gradient(90deg, var(--bs-primary), #27ae60);
  }

  .manual-item {
    padding: .5rem .75rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, .12);
    margin-bottom: .75rem;
    transition: background .2s ease;
  }

  .manual-item:hover {
    background: rgba(255, 255, 255, .03);
  }

  .manual-item .title {
    font-weight: 600;
  }

  .manual-item .actions {
    display: flex;
    gap: .5rem;
  }

  .card-header {
    border-bottom: 1px solid rgba(255, 255, 255, .12);
    background: transparent;
    cursor: pointer;
    user-select: none;
    transition: background .2s ease;
  }

  .card-header:hover {
    background: rgba(255, 255, 255, .03);
  }

  .card-header .collapse-icon {
    transition: transform .3s ease;
  }

  .card-header.collapsed .collapse-icon {
    transform: rotate(-180deg);
  }

  .principal {
    background: transparent;
    border: 0;
    box-shadow: none;
  }

  .principal .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .principal .btn-group .btn {
    padding: .375rem .75rem;
  }

  /* Animação suave do colapso */
  .collapse {
    transition: height .35s ease;
  }

  .collapsing {
    transition: height .35s ease;
  }

  /* Cores para os cards de grupo (lista de manuais) */
  .cards-grupos .col-12:nth-child(4n+1) .card {
    border: 2px solid #3498db !important;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(52, 152, 219, 0.02));
  }

  .cards-grupos .col-12:nth-child(4n+2) .card {
    border: 2px solid #9b59b6 !important;
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.05), rgba(155, 89, 182, 0.02));
  }

  .cards-grupos .col-12:nth-child(4n+3) .card {
    border: 2px solid #e74c3c !important;
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.05), rgba(231, 76, 60, 0.02));
  }

  .cards-grupos .col-12:nth-child(4n+4) .card {
    border: 2px solid #f39c12 !important;
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.05), rgba(243, 156, 18, 0.02));
  }

  .cards-grupos .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
    transform: translateY(-2px);
  }
</style>

<div class="container central-wrapper">
  <h3 class="mb-4 central-title" style="font-size: 40px;">Central de Ajuda Spartacus Web</h3>
  <p class="text-muted small mb-4 text-center" style="font-size: 12px;">
    Acesse os manuais de ajuda para cada módulo. Clique nos cards para expandir/recolher.
  </p>

  <div class="card principal">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center gap-2">
        <select id="moduleFilter" class="form-select form-select-sm" style="max-width:240px;">
          <option value="">Todos os módulos</option>
          {% for card in module_cards %}
          <option value="{{ card.code }}">{{ card.name }}</option>
          {% endfor %}
        </select>
        <a class="btn btn-outline-success btn-sm" href="{% url 'central_criar' slug=slug %}">
          <i class="bi bi-plus-lg"></i> Novo
        </a>
      </div>
    </div>
  </div>

  {% if module_cards %}
  <div class="row g-4 mb-4 module-card mt-4">
    {% for card in module_cards %}
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-primary h-100">
        <div class="card-body">
          <div class="module-header mb-2">
            <span class="fw-semibold">{{ card.name }}</span>
            <span class="badge text-bg-secondary">{{ card.count }} manuais</span>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar" role="progressbar" style="width: {{ card.avg }}%;" aria-valuenow="{{ card.avg }}"
              aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="mt-2 text-muted small">Média de progresso: {{ card.avg }}%</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% regroup object_list by cent_modu as grupos %}

  {% if grupos %}
  <div class="row g-4 cards-grupos">
    {% for grupo in grupos %}
    <div class="col-12 col-sm-6 col-lg-3" data-module="{{ grupo.grouper }}">
      <div class="card h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center" data-bs-toggle="collapse"
          data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="true"
          aria-controls="collapse{{ forloop.counter }}">
          <span>{{ grupo.list.0.get_cent_modu_display }}</span>
          <i class="bi bi-chevron-up collapse-icon"></i>
        </div>
        <div id="collapse{{ forloop.counter }}" class="collapse show">
          <div class="card-body">
            {% for item in grupo.list %}
            <div class="manual-item">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="title flex-grow-1">{{ item.cent_titu }}</span>
                <span class="badge text-bg-{{ item.status_class }} me-2">{{ item.status }}</span>
              </div>
              <div class="progress mt-2 progress-sm">
                <div class="progress-bar" role="progressbar" style="width: {{ item.prog|default:0 }}%;"
                  aria-valuenow="{{ item.prog|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="small text-muted">Progresso: {{ item.prog|default:0 }}%</span>
                <a class="btn btn-outline-primary btn-sm"
                  href="{% url 'central_detalhe' slug=slug pk=item.pk %}">Abrir</a>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info mt-4" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    Nenhum conteúdo cadastrado ainda. Clique em "Novo" para começar!
  </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Filtro de módulos
    var sel = document.getElementById('moduleFilter');
    if (sel) {
      var cols = document.querySelectorAll('[data-module]');
      sel.addEventListener('change', function () {
        var val = this.value;
        cols.forEach(function (el) {
          el.style.display = (!val || el.getAttribute('data-module') === val) ? '' : 'none';
        });
      });
    }

    // Animação do ícone de colapso
    var collapseHeaders = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseHeaders.forEach(function (header) {
      var target = document.querySelector(header.getAttribute('data-bs-target'));
      if (target) {
        target.addEventListener('show.bs.collapse', function () {
          header.classList.remove('collapsed');
        });
        target.addEventListener('hide.bs.collapse', function () {
          header.classList.add('collapsed');
        });
      }
    });
  });
</script>
{% endblock %}