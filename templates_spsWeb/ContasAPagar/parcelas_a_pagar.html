{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/form.css' %}">
<div class="container py-4">
    <div class="card shadow-lg border-0">
        <div class="card-header text-center py-3">
            <h3 class="mb-0 d-flex align-items-center justify-content-center">
                <i class="bi bi-calendar-plus me-2"></i>
                Gerar Parcelas — Pagar
            </h3>
        </div>
        <div class="card-body p-4">
            <form method="post">
                {% csrf_token %}
                <div class="form-section">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Empresa</label>
                            <input type="text" class="form-control readonly-field" value="{{ empresa_id|default:'' }}"
                                readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Filial</label>
                            <input type="text" class="form-control readonly-field" value="{{ filial_id|default:'' }}"
                                readonly>
                        </div>
                        <div class="col-md-8 position-relative">
                            <label class="form-label" for="{{ form.titu_forn.id_for_label }}">Fornecedor</label>
                            <input type="text" class="form-control" id="autocomplete-fornecedor" placeholder="Digite nome ou código do fornecedor">
                            {{ form.titu_forn.as_hidden }}
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_titu.id_for_label }}">Título</label>
                            {{ form.titu_titu }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_seri.id_for_label }}">Série</label>
                            {{ form.titu_seri }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_parc.id_for_label }}">Qtde Parcelas</label>
                            {{ form.titu_parc }}
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_valo.id_for_label }}">Valor Total (R$)</label>
                            {{ form.titu_valo }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_emis.id_for_label }}">Emissão</label>
                            {{ form.titu_emis }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_venc.id_for_label }}">1º Vencimento</label>
                            {{ form.titu_venc }}
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label" for="{{ form.titu_cecu.id_for_label }}">Centro de Custo</label>
                            {{ form.titu_cecu }}
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'contas_a_pagar_web:titulos_pagar_list' slug=request.resolver_match.kwargs.slug %}"
                        class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> Gerar Parcelas
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
  const slugTplP = '{{ slug|default:"" }}';
  const slugP = slugTplP || (function () {
    try {
      const p = location.pathname.split('/');
      return p.length > 2 ? p[2] : ''
    } catch (e) {
      return ''
    }
  })();
  (function(){
    const input = document.getElementById('autocomplete-fornecedor');
    const hidden = document.getElementById('{{ form.titu_forn.id_for_label }}');
    if (!input || !hidden) return;
    let controller = null;
    let dd = null;
    function dropdown() {
      if (dd) return dd;
      dd = document.createElement('div');
      dd.className = 'list-group position-absolute w-100';
      dd.style.zIndex = '1000';
      dd.style.maxHeight = '260px';
      dd.style.overflowY = 'auto';
      dd.style.marginTop = '4px';
      input.parentElement.appendChild(dd);
      return dd;
    }
    input.addEventListener('input', async function () {
      const term = this.value.trim();
      if (term.length < 2) { if (dd) dd.innerHTML=''; return; }
      try {
        if (controller) controller.abort();
        controller = new AbortController();
        const url = `/web/${slugP}/contas-a-pagar/autocomplete/fornecedores/?q=${encodeURIComponent(term)}`;
        const r = await fetch(url, { signal: controller.signal });
        const j = await r.json();
        const results = j.results || [];
        const d = dropdown(); d.innerHTML = '';
        if (results.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'list-group-item text-muted';
          empty.textContent = 'Nenhum fornecedor encontrado';
          d.appendChild(empty);
          return;
        }
        results.forEach(it => {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'list-group-item list-group-item-action';
          a.textContent = it.text || it.id || '';
          a.addEventListener('click', ev => {
            ev.preventDefault();
            hidden.value = it.id || '';
            input.value = it.text || it.id || '';
            d.innerHTML = '';
          });
          d.appendChild(a);
        });
      } catch(e) {
        if (e.name !== 'AbortError') console.error(e);
      }
    });
    document.addEventListener('click', e => {
      if (dd && !input.parentElement.contains(e.target)) dd.innerHTML = '';
    });
  })();
</script>
{% endblock %}
