{% extends 'base.html' %}
{% load static %}
{% load finance_tags %}

{% block content %}
<style>
  @media (max-width: 768px) {
    .page-header-custom .card { padding: 8px }
    .page-header-custom .card .card-title { font-size: 10px }
    .page-header-custom .card .card-title i { font-size: 10px }
    .page-header-custom .card .card-text { font-size: 10px }
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/list.css' %}">

<div class="container page-container">
  <div class="page-header-custom">
    <div class="container align-items-center">
      <h2 class="page-title">
        <i class="bi bi-credit-card"></i> Contas a Pagar
      </h2>
    </div>
    <div class="container">
      <div class="row row-cols-4 g-2">
        <div class="col">
          <div class="card totalpago" style="box-shadow: 2px 2px 4px 4px rgba(142, 196, 212, 0.733);">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-cash-stack me-1"></i> Total Pago</h5>
              <p class="card-text">{{ total_pago|brl }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card totalaberto" style="box-shadow: 2px 2px 4px 4px rgba(254, 255, 186, 0.733);">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-wallet2 me-1"></i> Total em Aberto</h5>
              <p class="card-text">{{ total_em_aberto|brl }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card totalaberto" style="box-shadow: 2px 2px 4px 4px rgba(182, 250, 239, 0.733);">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-graph-up me-1"></i> % Pago sobre o Total</h5>
              <p class="card-text">{{ percent_pago|floatformat:1 }}%</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card totalaberto" style="box-shadow: 2px 2px 4px 4px rgba(250, 167, 167, 0.733);">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-graph-down me-1"></i> % A Pagar sobre o Total</h5>
              <p class="card-text">{{ percent_a_pagar|floatformat:1 }}%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container d-flex justify-content-end">
    <a class="btn btn-success" href="">Novo T√≠tulo</a>
  </div>
  <div class="card">
    <div class="card-body">
      <form method="get" class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">Fornecedor (ID)</label>
          <input type="text" name="titu_forn" value="{{ filters.titu_forn }}" class="form-control"
            placeholder="ID do fornecedor">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fornecedor (Nome)</label>
          <input type="text" name="fornecedor_nome" value="{{ filters.fornecedor_nome }}" class="form-control"
            placeholder="Nome do fornecedor">
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select name="titu_aber" class="form-select">
            <option value="">Todos</option>
            <option value="A" {% if filters.titu_aber == 'A' %}selected{% endif %}>Aberto</option>
            <option value="P" {% if filters.titu_aber == 'P' %}selected{% endif %}>Parcial</option>
            <option value="T" {% if filters.titu_aber == 'T' %}selected{% endif %}>Total</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Venc. Inicial</label>
          <input type="date" name="venc_ini" value="{{ filters.venc_ini }}" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Venc. Final</label>
          <input type="date" name="venc_fim" value="{{ filters.venc_fim }}" class="form-control">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-outline-primary">Filtrar</button>
          <a href="?" class="btn btn-outline-secondary">Limpar</a>
        </div>
      </form>
    
    

    <div class="row">
      {% for t in titulos %}
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title">T√≠tulo {{ t.titu_titu }}</h5>
              {% if t.titu_aber == 'A' %}
              <span class="badge bg-danger">Aberto</span>
              {% elif t.titu_aber == 'P' %}
              <span class="badge bg-warning text-dark">Parcial</span>
              {% else %}
              <span class="badge bg-success">Quitado</span>
              {% endif %}
            </div>
            <p class="card-text mb-1"><strong>Fornecedor:</strong> {{ t.fornecedor_nome }} (ID {{ t.titu_forn }})
            </p>
            <p class="card-text"><strong>Vencimento:</strong> {{ t.titu_venc|date:'d/m/Y' }}<br>
              <strong>Valor:</strong> {{ t.titu_valo|brl }}
            </p>
            <div class="mt-3 d-flex flex-wrap gap-2">
              {% if t.titu_aber == 'A' %}
              <button type="button" class="btn btn-outline-success btn-sm btn-baixar" title="Pagar t√≠tulo" data-tipo="pagar"
                data-empr="{{ t.titu_empr }}" data-fili="{{ t.titu_fili }}" data-forn="{{ t.titu_forn }}"
                data-titu="{{ t.titu_titu }}" data-seri="{{ t.titu_seri }}" data-parc="{{ t.titu_parc }}"
                data-emis="{{ t.titu_emis|date:'Y-m-d' }}" data-venc="{{ t.titu_venc|date:'Y-m-d' }}">üíµ
                Pagar</button>
              {% endif %}
              {% if t.titu_aber == 'T' or t.titu_aber == 'P' %}
              <button type="button" class="btn btn-outline-warning btn-sm btn-reabrir" title="Reabrir/Liquidar"
                data-empr="{{ t.titu_empr }}" data-fili="{{ t.titu_fili }}" data-forn="{{ t.titu_forn }}"
                data-titu="{{ t.titu_titu }}" data-seri="{{ t.titu_seri }}" data-parc="{{ t.titu_parc }}"
                data-emis="{{ t.titu_emis|date:'Y-m-d' }}" data-venc="{{ t.titu_venc|date:'Y-m-d' }}">üîÑ
                Reabrir/Liquidar</button>
              {% endif %}
              <button type="button" class="btn btn-outline-primary btn-sm" title="Editar" disabled>‚úèÔ∏è Editar</button>
              <button type="button" class="btn btn-outline-danger btn-sm btn-excluir" title="Excluir"
                data-empr="{{ t.titu_empr }}" data-fili="{{ t.titu_fili }}" data-forn="{{ t.titu_forn }}"
                data-titu="{{ t.titu_titu }}" data-seri="{{ t.titu_seri }}" data-parc="{{ t.titu_parc }}"
                data-emis="{{ t.titu_emis|date:'Y-m-d' }}" data-venc="{{ t.titu_venc|date:'Y-m-d' }}">üóëÔ∏è
                Excluir</button>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="alert alert-info">Nenhum t√≠tulo encontrado com os filtros atuais.</div>
      </div>
      {% endfor %}
    </div>


    {% include 'components/pagination.html' with page_obj=page_obj extra_query=extra_query %}
    {% endblock %}

    {% block extra_js %}
    <script>
      function getCSRFToken() {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
          c = c.trim();
          if (c.startsWith(name)) return c.substring(name.length, c.length);
        }
        return '';
      }

      // Obt√©m empresa/filial do localStorage com fallback para sess√£o
      function getEmpresaFilial() {
        try {
          const empresaLS = localStorage.getItem('empresa_id');
          const filialLS = localStorage.getItem('filial_id');
          const empresaSess = '{{ request.session.empresa_id|default_if_none:"" }}';
          const filialSess = '{{ request.session.filial_id|default_if_none:"" }}';
          const empresa = empresaLS || empresaSess || '';
          const filial = filialLS || filialSess || '';
          return { empresa, filial };
        } catch (e) {
          return { empresa: '{{ request.session.empresa_id|default_if_none:"" }}', filial: '{{ request.session.filial_id|default_if_none:"" }}' };
        }
      }

      function formatDateISO(value) {
        const s = (value || '').toString();
        // Se j√° est√° em YYYY-MM-DD, retorna como est√° para evitar altera√ß√µes por timezone
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        // Converte de DD/MM/AAAA para YYYY-MM-DD
        const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (m) return `${m[3]}-${m[2]}-${m[1]}`;
        // Fallback: retorna at√© 10 caracteres sem tentar Date.toISOString
        return s.slice(0, 10);
      }

      async function excluirContaPagar(btn) {
        const empr = btn.dataset.empr;
        const fili = btn.dataset.fili;
        const forn = btn.dataset.forn;
        const titu = btn.dataset.titu;
        const seri = btn.dataset.seri;
        const parc = btn.dataset.parc;
        const emis = formatDateISO(btn.dataset.emis);
        const venc = formatDateISO(btn.dataset.venc);

        if (!confirm(`Confirma excluir o t√≠tulo ${titu}?`)) return;

        const url = `/api/{{ slug }}/contas_a_pagar/titulos-pagar/${empr}/${fili}/${forn}/${titu}/${seri}/${parc}/${emis}/${venc}/`;
        try {
          const resp = await fetch(url, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'X-Empresa': getEmpresaFilial().empresa,
              'X-Filial': getEmpresaFilial().filial,
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({})
          });
          if (!resp.ok) {
            const text = await resp.text();
            alert('Erro ao excluir: ' + text);
            return;
          }
          // Reload para refletir exclus√£o
          window.location.reload();
        } catch (err) {
          alert('Falha na requisi√ß√£o: ' + err.message);
        }
      }

      // Reabrir: escolher qual baixa excluir
      let contextoReabrir = null;
      async function reabrirTituloPagar(btn) {
        const empr = btn.dataset.empr;
        const fili = btn.dataset.fili;
        const forn = btn.dataset.forn;
        const titu = btn.dataset.titu;
        const seri = btn.dataset.seri;
        const parc = btn.dataset.parc;
        const emis = formatDateISO(btn.dataset.emis);
        const venc = formatDateISO(btn.dataset.venc);

        const histUrl = `/api/{{ slug }}/contas_a_pagar/titulos-pagar/${empr}/${fili}/${forn}/${titu}/${seri}/${parc}/${emis}/${venc}/historico_baixas/`;
        try {
          const hr = await fetch(histUrl, {
            credentials: 'same-origin',
            headers: {
              'Accept': 'application/json',
              'X-Empresa': getEmpresaFilial().empresa,
              'X-Filial': getEmpresaFilial().filial,
            }
          });
          const historico = await hr.json();
          if (!Array.isArray(historico) || historico.length === 0) {
            alert('Nenhuma baixa encontrada para reabrir.');
            return;
          }
          contextoReabrir = { empr, fili, forn, titu, seri, parc, emis, venc, historico };
          preencherModalReabrirPag(historico);
          document.getElementById('modal-reabrir-pag').style.display = 'block';
        } catch (err) {
          alert('Falha na requisi√ß√£o: ' + err.message);
        }
      }

      function preencherModalReabrirPag(historico) {
        const lista = document.getElementById('lista-baixas-pag');
        lista.innerHTML = '';
        historico.forEach(b => {
          const id = b.bapa_sequ ?? b.id ?? b.sequencia ?? '';
          const li = document.createElement('li');
          li.innerHTML = `<label><input type="radio" name="baixa_pag" value="${id}"> Baixa #${id}</label>`;
          lista.appendChild(li);
        });
      }

      // Inicializa√ß√£o segura ap√≥s o DOM estar pronto
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-excluir').forEach(btn => {
          btn.addEventListener('click', () => excluirContaPagar(btn));
        });
        document.querySelectorAll('.btn-reabrir').forEach(btn => {
          btn.addEventListener('click', () => reabrirTituloPagar(btn));
        });

        // Modal de Baixa (pagar)
        const modal = document.getElementById('modal-baixa');
        const form = document.getElementById('form-baixa');
        let contextoBaixa = null;

        function abrirModalBaixa(btn) {
          contextoBaixa = {
            tipo: btn.dataset.tipo, // 'pagar'
            empr: btn.dataset.empr,
            fili: btn.dataset.fili,
            forn: btn.dataset.forn,
            titu: btn.dataset.titu,
            seri: btn.dataset.seri,
            parc: btn.dataset.parc,
            emis: formatDateISO(btn.dataset.emis),
            venc: formatDateISO(btn.dataset.venc),
          };
          // reset
          if (form) form.reset();
          document.getElementById('historico').value = `Baixa do t√≠tulo ${contextoBaixa.titu}`;
          modal.style.display = 'block';
        }

        function fecharModalBaixa() {
          modal.style.display = 'none';
          contextoBaixa = null;
        }

        document.querySelectorAll('.btn-baixar').forEach(btn => {
          btn.addEventListener('click', () => abrirModalBaixa(btn));
        });

        document.getElementById('btn-cancelar-baixa')?.addEventListener('click', fecharModalBaixa);

        document.getElementById('btn-confirmar-baixa')?.addEventListener('click', async () => {
          if (!contextoBaixa) return;
          const dataPagamento = document.getElementById('data_pagamento').value;
          const valorPago = parseFloat(document.getElementById('valor_pago').value || '0');
          const valorJuros = parseFloat(document.getElementById('valor_juros').value || '0');
          const valorMulta = parseFloat(document.getElementById('valor_multa').value || '0');
          const valorDesconto = parseFloat(document.getElementById('valor_desconto').value || '0');
          const historico = document.getElementById('historico').value || '';
          const banco = document.getElementById('banco').value || '';
          const cheque = document.getElementById('cheque').value || '';
          const formaPagamento = document.getElementById('forma_pagamento').value || 'B';
          const tipoBaixa = 'N';

          if (!dataPagamento || isNaN(valorPago) || valorPago <= 0) {
            alert('Informe data e valor pago v√°lido.');
            return;
          }

          const url = `/api/{{ slug }}/contas_a_pagar/titulos-pagar/${contextoBaixa.empr}/${contextoBaixa.fili}/${contextoBaixa.forn}/${contextoBaixa.titu}/${contextoBaixa.seri}/${contextoBaixa.parc}/${contextoBaixa.emis}/${contextoBaixa.venc}/baixar/`;
          const payload = {
            data_pagamento: dataPagamento,
            valor_pago: valorPago,
            valor_juros: valorJuros,
            valor_multa: valorMulta,
            valor_desconto: valorDesconto,
            historico: historico,
            banco: banco ? parseInt(banco) : null,
            cheque: cheque ? parseInt(cheque) : null,
            tipo_baixa: tipoBaixa,
            forma_pagamento: formaPagamento,
          };
          console.log("Payload:", payload);

          try {
            const resp = await fetch(url, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Empresa': getEmpresaFilial().empresa,
                'X-Filial': getEmpresaFilial().filial,
                'Content-Type': 'application/json',
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            if (!resp.ok) {
              const text = await resp.text();
              alert('Erro ao baixar: ' + text);
              return;
            }
            fecharModalBaixa();
            window.location.reload();
          } catch (err) {
            alert('Falha na requisi√ß√£o: ' + err.message);
          }
        });

        // Fechar modal ao clicar fora
        window.addEventListener('click', (event) => {
          if (event.target === modal) fecharModalBaixa();
        });

        // Modal Reabrir (pagar)
        const modalReabrirPag = document.getElementById('modal-reabrir-pag');
        function fecharModalReabrirPag() {
          modalReabrirPag.style.display = 'none';
          contextoReabrir = null;
          document.getElementById('lista-baixas-pag').innerHTML = '';
          document.getElementById('motivo-reabrir-pag').value = '';
        }
        document.getElementById('btn-cancelar-reabrir-pag')?.addEventListener('click', fecharModalReabrirPag);
        document.getElementById('btn-confirmar-reabrir-pag')?.addEventListener('click', async () => {
          if (!contextoReabrir) return;
          const selecionado = document.querySelector('input[name="baixa_pag"]:checked');
          if (!selecionado) {
            alert('Selecione uma baixa para excluir.');
            return;
          }
          const baixaId = selecionado.value;
          const motivo = document.getElementById('motivo-reabrir-pag').value || `Reaberto via Web - t√≠tulo ${contextoReabrir.titu}`;
          const delUrl = `/api/{{ slug }}/contas_a_pagar/titulos-pagar/${contextoReabrir.empr}/${contextoReabrir.fili}/${contextoReabrir.forn}/${contextoReabrir.titu}/${contextoReabrir.seri}/${contextoReabrir.parc}/${contextoReabrir.emis}/${contextoReabrir.venc}/excluir_baixa/?baixa_id=${encodeURIComponent(baixaId)}`;
          try {
            const resp = await fetch(delUrl, {
              method: 'DELETE',
              credentials: 'same-origin',
              headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Empresa': getEmpresaFilial().empresa,
                'X-Filial': getEmpresaFilial().filial,
                'Content-Type': 'application/json',
                'Accept': 'application/json',
              },
              body: JSON.stringify({ confirmar_exclusao: true, motivo_exclusao: motivo })
            });
            if (!resp.ok) {
              const text = await resp.text();
              alert('Erro ao reabrir: ' + text);
              return;
            }
            fecharModalReabrirPag();
            window.location.reload();
          } catch (err) {
            alert('Falha na requisi√ß√£o: ' + err.message);
          }
        });
        window.addEventListener('click', (event) => {
          if (event.target === modalReabrirPag) fecharModalReabrirPag();
        });
      });
      // Fim da inicializa√ß√£o
    </script>
    <style>
      /* Modal simples sem depend√™ncias */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        max-width: 520px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .modal-grid .full {
        grid-column: 1 / -1;
      }

      .modal-grid input,
      .modal-grid select {
        width: 100%;
        padding: 6px;
      }
    </style>

    {% include 'ContasAPagar/partials/modal_baixa_pagar.html' %}
    {% include 'ContasAPagar/partials/modal_reabrir_pagar.html' %}
    {% endblock %}