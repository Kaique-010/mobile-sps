{% extends 'base.html' %}
{% load static %}
{% block title %}Nova Leitura de Estoque{% endblock %}

{% block content %}
<div class="container page-container">
    <div class="page-header-custom d-flex justify-content-between align-items-center">
        <h2 class="page-title"><i class="bi bi-upc-scan"></i> Nova Leitura</h2>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/web/{{ slug }}/coleta-estoque/">Leituras</a>
            <a class="btn btn-outline-secondary" href="/web/{{ slug }}/coleta-estoque/resumo/">Resumo</a>
        </div>
    </div>

    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            <form method="post" class="row g-3">
                {% csrf_token %}
                <div class="col-md-6">
                    <label class="form-label" for="id_codigo_barras">Código de Barras</label>
                    {{ form.codigo_barras }}
                    <div class="form-text">Use o leitor para preencher o campo.</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="id_quantidade">Quantidade</label>
                    {{ form.quantidade }}
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check2-circle"></i> Registrar
                    </button>
                </div>
            </form>
            <div class="mt-3">
                <div id="produto-info" class="alert d-none"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const slug = '{{ slug }}';
        const input = document.getElementById('id_codigo_barras');
        const info = document.getElementById('produto-info');
        const qtd = document.getElementById('id_quantidade');
        let debounce;
        function setInfo(cls, text) {
            info.className = 'alert ' + cls;
            info.textContent = text || '';
            info.classList.toggle('d-none', !text);
        }
        async function buscar(codigo) {
            if (!codigo || codigo.trim().length < 3) { setInfo('d-none', ''); return; }
            const token = localStorage.getItem('access');
            const headers = { 'Accept': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            try {
                const r = await fetch(`/api/${slug}/coletaestoque/buscar-produto/?codigo=${encodeURIComponent(codigo)}`, { headers });
                const j = await r.json();
                if (!r.ok) { setInfo('alert-warning', j.error || 'Produto não encontrado'); return; }
                setInfo('alert-info', `${j.prod_nome} • EAN: ${j.prod_coba || ''} • Saldo: ${j.saldo_atual}`);
                if (qtd && !qtd.value) qtd.value = '1.00';
            } catch (e) { setInfo('alert-danger', 'Falha ao buscar produto'); }
        }
        function onChange() {
            clearTimeout(debounce);
            debounce = setTimeout(() => buscar(input.value), 250);
        }
        input && input.addEventListener('input', onChange);
        input && input.addEventListener('blur', () => buscar(input.value));
    })();
</script>
{% endblock %}