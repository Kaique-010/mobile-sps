{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .login-wrapper {
    padding: 1rem;
  }
  .login-card {
    max-width: 640px;
    box-shadow: 0 0 20px rgba(127, 198, 255, 0.938);
  }
  .login-header .subtitle {
    color: var(--bs-secondary-color);
  }
  [data-bs-theme="dark"] .login-header .subtitle {
    color: var(--bs-secondary-color);
  }
</style>

<div class="login-wrapper container min-vh-80 d-flex align-items-center justify-content-center">
  <div class="login-card w-100 bg-body border rounded-3">
    <div class="login-header p-4 pb-0 text-center">
      <h1 class="h4 mb-1">Seleção de Empresa e Filial</h1>
      <p class="subtitle mb-0">Escolha a empresa e filial para continuar.</p>
    </div>

    <div class="px-4 pt-3">
      <div id="alert" class="alert alert-danger d-none" role="alert"></div>
    </div>

    <div class="login-body p-4 pt-0">
      <form id="selForm">
        {% csrf_token %}
        <div class="form-floating mb-3">
          <select class="form-select" id="empresa" required>
            <option value="" selected disabled>Carregando...</option>
          </select>
          <label for="empresa">Empresa</label>
        </div>
        <div class="form-floating mb-3">
          <select class="form-select" id="filial" required>
            <option value="" selected disabled>Selecione a empresa primeiro</option>
          </select>
          <label for="filial">Filial</label>
        </div>
        <button type="submit" class="btn btn-success w-100">Continuar</button>
      </form>
    </div>

    <div class="login-footer px-4 pb-4 text-center">
      <small class="text-body-secondary">Após selecionar, você será direcionado à home.</small>
    </div>
  </div>
</div>

<script>
  // ====== Logger util para depuração no navegador ======
  const DEBUG = true; // altere para false para silenciar
  const L = {
    prefix: '[SEL_EMP]'
  };
  L.group = (label) => DEBUG && console.groupCollapsed(`${L.prefix} ${label}`);
  L.groupEnd = () => DEBUG && console.groupEnd();
  L.log = (...args) => DEBUG && console.log(L.prefix, ...args);
  L.info = (...args) => DEBUG && console.info(L.prefix, ...args);
  L.warn = (...args) => DEBUG && console.warn(L.prefix, ...args);
  L.error = (...args) => DEBUG && console.error(L.prefix, ...args);
  L.time = (label) => DEBUG && console.time(`${L.prefix} ${label}`);
  L.timeEnd = (label) => DEBUG && console.timeEnd(`${L.prefix} ${label}`);
  L.table = (data) => DEBUG && console.table(data);

  const showError = (msg) => {
    const el = document.getElementById('alert');
    el.textContent = msg;
    el.classList.remove('d-none');
    L.error('Alerta mostrado:', msg);
  };

  const slug = localStorage.getItem('slug');
  const access = localStorage.getItem('access');
  L.group('Sessão');
  L.log('slug:', slug);
  L.log('access presente:', !!access);
  L.groupEnd();

  const authFetch = (url) => {
    L.group('authFetch');
    L.log('URL:', url);
    L.groupEnd();
    return fetch(url, {
    headers: {
      'Authorization': `Bearer ${access}`,
      'Content-Type': 'application/json'
    }
    });
  };

  const carregarEmpresas = async () => {
    try {
      const url = `/api/${slug}/licencas/empresas/`;
      L.time('Empresas:fetch');
      const resp = await authFetch(url);
      const data = await resp.json();
      L.group('Empresas:resposta');
      L.log('status:', resp.status);
      L.log('ok:', resp.ok);
      L.table(Array.isArray(data) ? data : [data]);
      L.groupEnd();
      L.timeEnd('Empresas:fetch');
      if (!resp.ok) return showError(data?.error || 'Erro ao carregar empresas');
      const sel = document.getElementById('empresa');
      sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
      data.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.empr_codi;
        opt.textContent = `${e.empr_nome} (${e.empr_docu})`;
        sel.appendChild(opt);
      });
      L.info('Empresas carregadas:', data.length);
    } catch (e) {
      console.error(e);
      showError('Erro inesperado ao carregar empresas');
    }
  };

  const carregarFiliais = async (empresaId) => {
    try {
      const url = `/api/${slug}/licencas/filiais/?empresa_id=${encodeURIComponent(empresaId)}`;
      L.time('Filiais:fetch');
      L.log('Empresa selecionada:', empresaId);
      const resp = await authFetch(url);
      const data = await resp.json();
      L.group('Filiais:resposta');
      L.log('status:', resp.status);
      L.log('ok:', resp.ok);
      L.table(Array.isArray(data) ? data : [data]);
      L.groupEnd();
      L.timeEnd('Filiais:fetch');
      if (!resp.ok) return showError(data?.error || 'Erro ao carregar filiais');
      const sel = document.getElementById('filial');
      sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
      data.forEach(f => {
        const opt = document.createElement('option');
        // Usa o identificador primário da filial (empr_empr)
        opt.value = f.empr_empr;
        opt.textContent = f.empr_nome;
        sel.appendChild(opt);
      });
      L.info('Filiais carregadas:', data.length);
    } catch (e) {
      console.error(e);
      showError('Erro inesperado ao carregar filiais');
    }
  };

  document.getElementById('empresa').addEventListener('change', (e) => {
    const empresaId = e.target.value;
    L.log('Change empresa ->', empresaId);
    if (empresaId) carregarFiliais(empresaId);
  });

  // Helper para obter CSRF do cookie
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      const token = parts.pop().split(';').shift();
      L.log('CSRF do cookie encontrado:', !!token);
      return token;
    }
  }

  document.getElementById('selForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const empresaId = document.getElementById('empresa').value;
    const filialId = document.getElementById('filial').value;
    const empresaNome = document.querySelector('#empresa option:checked')?.textContent || '';
    const filialNome = document.querySelector('#filial option:checked')?.textContent || '';
    if (!empresaId || !filialId) return showError('Selecione empresa e filial.');

    // Persistir também no localStorage para compatibilidade com rotas que usam headers
    try {
      localStorage.setItem('empresa_id', String(empresaId));
      localStorage.setItem('filial_id', String(filialId));
      if (empresaNome) localStorage.setItem('empresa_nome', empresaNome);
      if (filialNome) localStorage.setItem('filial_nome', filialNome);
      L.info('LocalStorage atualizado', { empresaId, filialId, empresaNome, filialNome });
    } catch (e) {
      console.warn('Não foi possível persistir no localStorage:', e);
      L.warn('Falha ao persistir no localStorage:', e?.message);
    }

    // Persistir no servidor (sessão) para padronização nos web views
    try {
      const csrfToken = getCookie('csrftoken') || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
      const payload = new URLSearchParams({ empresa_id: empresaId, filial_id: filialId, empresa_nome: empresaNome, filial_nome: filialNome });
      L.group('POST selecionar-empresa');
      L.log('Headers:', { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': !!csrfToken });
      L.log('Payload:', Object.fromEntries(payload.entries()));
      const resp = await fetch('/web/selecionar-empresa/', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        },
        body: payload
      });
      // Trata respostas 2xx como sucesso; backend retorna JSON
      L.log('Resposta selecionar-empresa:', resp.status, resp.ok);
      if (!resp.ok) {
        const txt = await resp.text();
        L.error('Erro selecionar-empresa body:', txt);
        L.groupEnd();
        return showError('Falha ao salvar seleção.');
      }
      // Opcionalmente, ler JSON e usar redirect informado
      try {
        const data = await resp.json();
        L.log('JSON selecionar-empresa:', data);
        if (data?.redirect) {
          L.groupEnd();
          return window.location.href = data.redirect;
        }
      } catch (_) {}
      // Redireciona para a Home do sistema (corrigido)
      L.groupEnd();
      window.location.href = '/web/home/';
    } catch (err) {
      console.error(err);
      L.error('Exceção ao comunicar com o servidor:', err?.message);
      showError('Erro ao comunicar com o servidor.');
    }
  });

  // Inicializa
  if (!slug || !access) {
    showError('Sessão inválida. Faça login novamente.');
  } else {
    L.info('Inicializando carregamento de empresas...');
    carregarEmpresas();
  }
</script>
{% endblock %}