{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header">
            <h3 class="card-title">{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Talh√£o</h3>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {% for field in form %}
                {% if field.name == 'talh_faze' %}
                <div class="mb-3 position-relative">
                    <label for="autocomplete-fazenda" class="form-label">{{ field.label }}</label>
                    <div class="input-group">
                        <input type="text" id="autocomplete-fazenda" class="form-control"
                            placeholder="Digite o nome da fazenda..." autocomplete="off">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                    <div id="fazenda-dropdown" class="autocomplete-dropdown list-group position-absolute w-100"
                        style="z-index: 1000;"></div>
                </div>
                {% else %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endfor %}
                <div class="mt-4">
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Salvar</button>
                    <a href="{% url 'AgricolaWeb:talhao_list' slug=view.kwargs.slug %}" class="btn btn-secondary"><i
                            class="bi bi-x-circle"></i> Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('autocomplete-fazenda');
        const hidden = document.getElementById('{{ form.talh_faze.id_for_label }}');
        const dropdown = document.getElementById('fazenda-dropdown');
        const url = "{% url 'AgricolaWeb:autocomplete_fazendas' slug=view.kwargs.slug %}";

        let controller = null;
        let debounce = null;

        if (input && hidden) {
            // Prefill if value exists
            if (hidden.value) {
                fetch(`${url}?id=${hidden.value}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            input.value = data.results[0].text;
                        }
                    })
                    .catch(e => console.error('Error prefilling fazenda:', e));
            }

            input.addEventListener('input', function (e) {
                const term = e.target.value.trim();

                // Clear hidden if input is cleared
                if (term === '') {
                    hidden.value = '';
                }

                clearTimeout(debounce);

                if (term.length < 1) {
                    dropdown.innerHTML = '';
                    return;
                }

                debounce = setTimeout(async () => {
                    try {
                        if (controller) controller.abort();
                        controller = new AbortController();

                        const resp = await fetch(`${url}?term=${encodeURIComponent(term)}`, { signal: controller.signal });
                        const data = await resp.json();

                        dropdown.innerHTML = '';

                        if (data.results && data.results.length > 0) {
                            data.results.forEach(item => {
                                const a = document.createElement('a');
                                a.href = '#';
                                a.className = 'list-group-item list-group-item-action';
                                a.textContent = item.text;
                                a.addEventListener('click', (ev) => {
                                    ev.preventDefault();
                                    input.value = item.text;
                                    hidden.value = item.id;
                                    dropdown.innerHTML = '';
                                });
                                dropdown.appendChild(a);
                            });
                        } else {
                            dropdown.innerHTML = '<div class="list-group-item">Nenhuma fazenda encontrada</div>';
                        }
                    } catch (e) {
                        if (e.name !== 'AbortError') {
                            console.error('Autocomplete error:', e);
                        }
                    }
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.innerHTML = '';
                }
            });
        }
    });
</script>
{% endblock %}