{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header">
            <h3 class="card-title">Registrar Movimentações de Estoque</h3>
        </div>
        <div class="card-body">
            <form method="post" id="movimentacao-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="movimentacoes_json" id="movimentacoes_json">

                <!-- Área de Inserção de Itens -->
                <ul class="nav nav-tabs mb-3" id="movimentacaoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral"
                            type="button" role="tab" aria-controls="geral" aria-selected="true">Dados Gerais</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financeiro-tab" data-bs-toggle="tab" data-bs-target="#financeiro"
                            type="button" role="tab" aria-controls="financeiro"
                            aria-selected="false">Financeiro</button>
                    </li>
                </ul>

                <div class="tab-content border-bottom pb-4 mb-4" id="movimentacaoTabContent">
                    <!-- Aba Geral -->
                    <div class="tab-pane fade show active" id="geral" role="tabpanel" aria-labelledby="geral-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="autocomplete-fazenda" class="form-label">Fazenda</label>
                                <div class="input-group position-relative">
                                    <input type="text" id="autocomplete-fazenda" class="form-control"
                                        placeholder="Buscar fazenda..." autocomplete="off"
                                        value="{{ initial_fazenda|default:'' }}">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <div id="fazenda-dropdown"
                                        class="autocomplete-dropdown list-group position-absolute w-100"
                                        style="z-index: 1000; top: 100%;"></div>
                                </div>
                                {{ form.movi_estq_faze }}
                            </div>

                            <div class="col-md-6">
                                <label for="autocomplete-produto" class="form-label">Produto</label>
                                <div class="input-group position-relative">
                                    <input type="text" id="autocomplete-produto" class="form-control"
                                        placeholder="Buscar produto..." autocomplete="off"
                                        value="{{ initial_produto|default:'' }}">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <div id="produto-dropdown"
                                        class="autocomplete-dropdown list-group position-absolute w-100"
                                        style="z-index: 1000; top: 100%;"></div>
                                </div>
                                {{ form.movi_estq_prod }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">{{ form.movi_estq_tipo.label }}</label>
                                {{ form.movi_estq_tipo }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">{{ form.movi_estq_quant.label }}</label>
                                {{ form.movi_estq_quant }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">{{ form.movi_estq_cust_unit.label }}</label>
                                {{ form.movi_estq_cust_unit }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Custo Total (Estimado)</label>
                                <input type="text" class="form-control" id="custo-total-display" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">{{ form.movi_estq_moti.label }}</label>
                                {{ form.movi_estq_moti }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">{{ form.movi_estq_docu_refe.label }}</label>
                                {{ form.movi_estq_docu_refe }}
                            </div>
                        </div>
                    </div>

                    <!-- Aba Financeiro -->
                    <div class="tab-pane fade" id="financeiro" role="tabpanel" aria-labelledby="financeiro-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="autocomplete-entidade" class="form-label">
                                    {{ form.movi_estq_enti.label }}</label>
                                <div class="input-group position-relative">
                                    <input type="text" id="autocomplete-entidade" class="form-control"
                                        placeholder="Buscar entidade (Cliente/Fornecedor)..." autocomplete="off"
                                        value="{{ initial_entidade|default:'' }}">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <div id="entidade-dropdown"
                                        class="autocomplete-dropdown list-group position-absolute w-100"
                                        style="z-index: 1000; top: 100%;"></div>
                                </div>
                                {{ form.movi_estq_enti }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">{{ form.movi_estq_venc.label }}</label>
                                {{ form.movi_estq_venc }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">{{ form.movi_estq_form_paga.label }}</label>
                                {{ form.movi_estq_form_paga }}
                            </div>

                            <div class="col-12 mt-3">
                                {% if object.pk %}
                                <button type="submit" name="gerar_financeiro" value="true" class="btn btn-warning"
                                    id="btn-gerar-financeiro">
                                    <i class="bi bi-cash-coin"></i> Salvar e Gerar Financeiro
                                </button>
                                {% endif %}
                            </div>

                            <!-- Lista de Títulos Financeiros -->
                            <div class="col-12 mt-4">
                                <h5 class="border-bottom pb-2">Títulos Financeiros Vinculados</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-hover" id="tabela-financeiro">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Título</th>
                                                <th>Parcela</th>
                                                <th>Vencimento</th>
                                                <th>Valor</th>
                                                <th>Situação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    {% if object.pk %}
                                                    Carregando...
                                                    {% else %}
                                                    Salve a movimentação para visualizar o financeiro.
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 text-end mb-4">
                    <button type="button" class="btn btn-primary" id="btn-adicionar">
                        <i class="bi bi-plus-circle"></i> Adicionar Movimentação
                    </button>
                </div>

                <!-- Lista de Itens Adicionados -->
                <div class="table-responsive mb-4">
                    <table class="table table-hover table-bordered" id="tabela-movimentacoes">
                        <thead class="table-light">
                            <tr>
                                <th>Fazenda</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Qtd.</th>
                                <th>Custo Unit.</th>
                                <th>Motivo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Itens serão inseridos via JS -->
                        </tbody>
                    </table>
                    <div id="empty-message" class="text-center text-muted p-3">Nenhuma movimentação adicionada.</div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-success" id="btn-salvar-todos" disabled>
                        <i class="bi bi-check-circle"></i> Processar Todas
                    </button>
                    <a href="{% url 'AgricolaWeb:movimentacao_estoque_list' slug=view.kwargs.slug %}"
                        class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Referências DOM ---
        const form = document.getElementById('movimentacao-form');
        const hiddenJson = document.getElementById('movimentacoes_json');
        const btnAdd = document.getElementById('btn-adicionar');
        const btnSave = document.getElementById('btn-salvar-todos');
        const tbody = document.querySelector('#tabela-movimentacoes tbody');
        const emptyMsg = document.getElementById('empty-message');
        const btnGerarFinanceiro = document.getElementById('btn-gerar-financeiro');
        const tableContainer = document.getElementById('tabela-movimentacoes').parentElement; // Container da tabela de itens

        // Inputs
        const inputFaze = document.getElementById('autocomplete-fazenda');
        const hiddenFaze = document.getElementById('{{ form.movi_estq_faze.id_for_label }}');
        const inputProd = document.getElementById('autocomplete-produto');
        const hiddenProd = document.getElementById('{{ form.movi_estq_prod.id_for_label }}');

        const inputTipo = document.getElementById('{{ form.movi_estq_tipo.id_for_label }}');
        const inputQuant = document.getElementById('{{ form.movi_estq_quant.id_for_label }}');
        const inputCust = document.getElementById('{{ form.movi_estq_cust_unit.id_for_label }}');
        const inputMoti = document.getElementById('{{ form.movi_estq_moti.id_for_label }}');
        const inputDoc = document.getElementById('{{ form.movi_estq_docu_refe.id_for_label }}');
        const displayTotal = document.getElementById('custo-total-display');

        let items = [];
        const isEditMode = "{{ object.pk|default:'' }}" !== "";

        // Ajustes de UI para Modo Edição
        if (isEditMode) {
            if (btnAdd) btnAdd.style.display = 'none'; // Esconde botão Adicionar
            if (tableContainer) tableContainer.style.display = 'none'; // Esconde tabela de itens
            if (btnSave) {
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Alterações';
            }
        }


        // --- Helper: Atualizar Total ---
        function updateTotal() {
            const q = parseFloat(inputQuant.value) || 0;
            const c = parseFloat(inputCust.value) || 0;
            displayTotal.value = (q * c).toFixed(2);
        }
        inputQuant.addEventListener('input', updateTotal);
        inputCust.addEventListener('input', updateTotal);

        // --- Helper: Renderizar Tabela ---
        function renderTable() {
            tbody.innerHTML = '';
            if (items.length === 0) {
                emptyMsg.style.display = 'block';
                // Disable save only if NOT in edit mode
                if (!isEditMode) {
                    btnSave.disabled = true;
                }
                return;
            }
            emptyMsg.style.display = 'none';
            btnSave.disabled = false;

            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.fazeText}</td>
                    <td>${item.prodText}</td>
                    <td><span class="badge ${item.movi_estq_tipo === 'entrada' ? 'bg-success' : 'bg-danger'}">${(item.movi_estq_tipo || '').toUpperCase()}</span></td>
                    <td>${item.movi_estq_quant}</td>
                    <td>${item.movi_estq_cust_unit || '-'}</td>
                    <td>${item.movi_estq_moti || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-remove" data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Rebind remove buttons
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', function () {
                    const idx = parseInt(this.dataset.index);
                    items.splice(idx, 1);
                    renderTable();
                });
            });

            // Update JSON
            hiddenJson.value = JSON.stringify(items);
        }

        // --- Ação: Adicionar Item ---
        btnAdd.addEventListener('click', function () {
            // Validação simples
            if (!hiddenFaze.value || !hiddenProd.value || !inputQuant.value || !inputTipo.value) {
                alert('Preencha os campos obrigatórios (Fazenda, Produto, Tipo, Quantidade).');
                return;
            }

            const item = {
                movi_estq_faze: hiddenFaze.value,
                fazeText: inputFaze.value,
                movi_estq_prod: hiddenProd.value,
                prodText: inputProd.value,
                movi_estq_tipo: inputTipo.value,
                movi_estq_quant: inputQuant.value,
                movi_estq_cust_unit: inputCust.value,
                movi_estq_moti: inputMoti.value,
                movi_estq_docu_refe: inputDoc.value
            };

            items.push(item);
            renderTable();

            // Limpar inputs (exceto Fazenda, talvez o usuário queira continuar na mesma)
            // Mas vamos limpar Produto e Qtd para evitar duplicidade acidental
            hiddenProd.value = '';
            inputProd.value = '';
            inputQuant.value = '';
            inputCust.value = '';
            inputMoti.value = '';
            inputDoc.value = '';
            displayTotal.value = '';
            // Focar no produto para próxima entrada
            inputProd.focus();
        });

        // --- Autocomplete Setup ---
        function setupAutocomplete(inputId, hiddenId, dropdownId, url) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            let debounce = null;
            let controller = null;

            if (!input || !hidden || !dropdown) return;

            input.addEventListener('input', function () {
                const term = this.value.trim();
                clearTimeout(debounce);

                if (term.length < 2) {
                    dropdown.innerHTML = '';
                    return;
                }

                debounce = setTimeout(async () => {
                    try {
                        if (controller) controller.abort();
                        controller = new AbortController();

                        const response = await fetch(`${url}?term=${encodeURIComponent(term)}`, {
                            signal: controller.signal
                        });
                        const data = await response.json();

                        dropdown.innerHTML = '';

                        if (data.results && data.results.length > 0) {
                            data.results.forEach(item => {
                                const a = document.createElement('a');
                                a.className = 'list-group-item list-group-item-action';
                                a.href = '#';
                                a.textContent = item.text;
                                a.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    input.value = item.text;
                                    hidden.value = item.id;
                                    dropdown.innerHTML = '';
                                });
                                dropdown.appendChild(a);
                            });
                        } else {
                            dropdown.innerHTML = '<div class="list-group-item text-muted">Nenhum resultado</div>';
                        }
                    } catch (e) {
                        if (e.name !== 'AbortError') console.error(e);
                    }
                }, 300);
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.innerHTML = '';
                }
            });
        }

        setupAutocomplete(
            'autocomplete-fazenda',
            '{{ form.movi_estq_faze.id_for_label }}',
            'fazenda-dropdown',
            "{% url 'AgricolaWeb:autocomplete_fazendas' slug=view.kwargs.slug %}"
        );

        setupAutocomplete(
            'autocomplete-produto',
            '{{ form.movi_estq_prod.id_for_label }}',
            'produto-dropdown',
            "{% url 'AgricolaWeb:autocomplete_produtos_agro' slug=view.kwargs.slug %}"
        );

        setupAutocomplete(
            'autocomplete-entidade',
            '{{ form.movi_estq_enti.id_for_label }}',
            'entidade-dropdown',
            "{% url 'AgricolaWeb:autocomplete_entidades' slug=view.kwargs.slug %}"
        );

        // Intercept form submit
        form.addEventListener('submit', function (e) {
            // Se for Edição, não valida items.length (salva direto o form)
            if (isEditMode) {
                return;
            }

            // Se for Criação (Batch), exige itens na lista
            if (items.length === 0) {
                const submitter = e.submitter;
                if (submitter && submitter.id === 'btn-gerar-financeiro') return;

                e.preventDefault();
                alert('Adicione pelo menos uma movimentação.');
            }
        });

        // --- Carregar Financeiro ao mudar de aba ---
        const financeiroTabBtn = document.getElementById('financeiro-tab');
        const tabelaFinanceiroBody = document.querySelector('#tabela-financeiro tbody');

        if (financeiroTabBtn && isEditMode) {
            financeiroTabBtn.addEventListener('shown.bs.tab', function (e) {
                console.log("Aba Financeiro ativada. Carregando dados...");
                loadFinanceiroData();
            });

            // Se já estiver na aba financeiro ao carregar (ex: refresh), carrega também
            if (financeiroTabBtn.classList.contains('active')) {
                loadFinanceiroData();
            }
        }

        async function loadFinanceiroData() {
            if (!isEditMode) return;

            // Define URL
            const url = "{% if object.pk %}{% url 'AgricolaWeb:movimentacao_estoque_financeiro_list' slug=view.kwargs.slug pk=object.pk %}{% endif %}";
            if (!url) return;

            console.log("Buscando financeiro em:", url);
            tabelaFinanceiroBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando dados financeiros...</td></tr>';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro na requisição: ' + response.status);

                const data = await response.json();
                console.log("Dados recebidos:", data);

                tabelaFinanceiroBody.innerHTML = '';

                if (data.results && data.results.length > 0) {
                    console.log(`✅ Encontrados ${data.results.length} título(s)`);

                    data.results.forEach((t, index) => {
                        const tr = document.createElement('tr');
                        // Removido estilos inline para suportar dark mode

                        let valorFormatado = 'R$ 0,00';
                        try {
                            valorFormatado = new Intl.NumberFormat('pt-BR', {
                                style: 'currency',
                                currency: 'BRL'
                            }).format(t.valor);
                        } catch (err) {
                            console.error("Erro ao formatar valor:", err);
                            valorFormatado = `R$ ${t.valor}`;
                        }

                        console.log(`Linha ${index + 1}:`, {
                            titulo: t.titulo,
                            parcela: t.parcela,
                            vencimento: t.vencimento,
                            valor: valorFormatado,
                            situacao: t.situacao
                        });

                        tr.innerHTML = `
                            <td style="padding: 8px;">${t.titulo || '-'}</td>
                            <td style="padding: 8px;">${t.parcela || '-'}</td>
                            <td style="padding: 8px;">${t.vencimento || '-'}</td>
                            <td style="padding: 8px;">${valorFormatado}</td>
                            <td style="padding: 8px;"><span class="badge ${t.situacao === 'Aberto' ? 'bg-warning text-dark' : 'bg-success text-white'}">${t.situacao || 'N/A'}</span></td>
                        `;
                        tabelaFinanceiroBody.appendChild(tr);
                    });

                    console.log(`✅ Tabela preenchida com ${data.results.length} linha(s)`);
                } else {
                    console.log('⚠️ Nenhum título encontrado');
                    tabelaFinanceiroBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted" style="padding: 15px;">Nenhum título encontrado para esta movimentação.</td></tr>';
                }

            } catch (e) {
                console.error("❌ Erro ao carregar financeiro:", e);
                tabelaFinanceiroBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger" style="padding: 15px;">Erro ao carregar dados: ${e.message}</td></tr>`;
            }
        }
    });
</script>
{% endblock %}