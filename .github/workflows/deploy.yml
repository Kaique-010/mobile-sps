name: Deploy Mobile e Web-SPS (Blue/Green)

on:
  push:
    branches: ['main']

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout completo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ” Debug - Verificar Secrets e VariÃ¡veis
        run: |
          echo "============================================"
          echo "ðŸ” DEBUG - INFORMAÃ‡Ã•ES DO REPOSITÃ“RIO"
          echo "============================================"
          echo "RepositÃ³rio atual: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo ""
          echo "============================================"
          echo "ðŸ”‘ DEBUG - VERIFICAÃ‡ÃƒO DOS SECRETS"
          echo "============================================"
          echo "TOKEN_SPARTACUS existe: ${{ secrets.MIRROR_TOKEN_SPARTACUS != '' }}"
          echo "TOKEN_KAIQUE existe: ${{ secrets.MIRROR_TOKEN_KAIQUE010 != '' }}"
          echo "Tamanho TOKEN_SPARTACUS: ${#TOKEN_SPARTACUS}"
          echo "Tamanho TOKEN_KAIQUE: ${#TOKEN_KAIQUE}"
          echo "Primeiros 4 chars TOKEN_SPARTACUS: ${TOKEN_SPARTACUS:0:4}..."
          echo "Ãšltimos 4 chars TOKEN_SPARTACUS: ...${TOKEN_SPARTACUS: -4}"
          echo ""
          echo "============================================"
          echo "ðŸŽ¯ DEBUG - LÃ“GICA DO ESPELHAMENTO"
          echo "============================================"
          if [ "${{ github.repository }}" = "Kaique-010/mobile-sps" ]; then
            echo "âœ… Detectado: RepositÃ³rio Kaique-010/mobile-sps"
            echo "ðŸŽ¯ Destino: spartacusWeb25/mobile-sps"
            echo "ðŸ”‘ Token usado: MIRROR_TOKEN_SPARTACUS"
          else
            echo "âœ… Detectado: RepositÃ³rio spartacusWeb25/mobile-sps"
            echo "ðŸŽ¯ Destino: Kaique-010/mobile-sps"
            echo "ðŸ”‘ Token usado: MIRROR_TOKEN_KAIQUE010"
          fi
          echo "============================================"
        env:
          TOKEN_SPARTACUS: ${{ secrets.MIRROR_TOKEN_SPARTACUS }}
          TOKEN_KAIQUE: ${{ secrets.MIRROR_TOKEN_KAIQUE010 }}

      - name: Espelhar para o outro repositÃ³rio
        continue-on-error: false
        env:
          REPO: ${{ github.repository }}
          TOKEN_SPARTACUS: ${{ secrets.MIRROR_TOKEN_SPARTACUS }}
          TOKEN_KAIQUE: ${{ secrets.MIRROR_TOKEN_KAIQUE010 }}
        run: |
          echo "ðŸš€ Iniciando espelhamento..."
          echo "RepositÃ³rio origem: $REPO"

          # Debug: verificar tokens recebidos
          echo "Debug - TOKEN_SPARTACUS length: ${#TOKEN_SPARTACUS}"
          echo "Debug - TOKEN_KAIQUE length: ${#TOKEN_KAIQUE}"

          if [ "$REPO" = "Kaique-010/mobile-sps" ]; then
            echo "ðŸ“ Rota: Kaique-010 â†’ spartacusWeb25"
            
            if [ -z "$TOKEN_SPARTACUS" ] || [ "${#TOKEN_SPARTACUS}" -lt 10 ]; then
              echo "âŒ ERRO: TOKEN_SPARTACUS estÃ¡ vazio ou invÃ¡lido!"
              echo "Tamanho: ${#TOKEN_SPARTACUS}"
              exit 1
            fi
            
            echo "âœ… Token SPARTACUS vÃ¡lido (${#TOKEN_SPARTACUS} caracteres)"
            MIRROR_TOKEN="$TOKEN_SPARTACUS"
            TARGET_REPO="spartacusWeb25/mobile-sps"
            
          else
            echo "ðŸ“ Rota: spartacusWeb25 â†’ Kaique-010"
            
            if [ -z "$TOKEN_KAIQUE" ] || [ "${#TOKEN_KAIQUE}" -lt 10 ]; then
              echo "âŒ ERRO: TOKEN_KAIQUE estÃ¡ vazio ou invÃ¡lido!"
              echo "Tamanho: ${#TOKEN_KAIQUE}"
              exit 1
            fi
            
          echo "âœ… Token KAIQUE vÃ¡lido (${#TOKEN_KAIQUE} caracteres)"
          MIRROR_TOKEN="$TOKEN_KAIQUE"
          TARGET_REPO="Kaique-010/mobile-sps"
          fi

          # ðŸš« NÃƒO ESPELHAR WORKFLOWS
          echo "ðŸ§¹ Removendo .github/workflows do espelhamento..."
          rm -rf .github/workflows

          # Testar 3 formatos diferentes de URL
          echo ""
          echo "ðŸ”— Tentando 3 formatos de autenticaÃ§Ã£o..."


          # Formato 1: x-access-token
          echo "ðŸ“Œ Formato 1: x-access-token"
          TARGET_URL="https://x-access-token:${MIRROR_TOKEN}@github.com/${TARGET_REPO}.git"
          git remote remove mirror 2>/dev/null || true
          git remote add mirror "$TARGET_URL"

          if git push mirror main --verbose 2>&1; then
            echo "âœ… Sucesso com formato x-access-token!"
            exit 0
          fi

          echo "âš ï¸ Formato 1 falhou, tentando formato 2..."

          # Formato 2: token direto
          echo "ðŸ“Œ Formato 2: token direto"
          TARGET_URL="https://${MIRROR_TOKEN}@github.com/${TARGET_REPO}.git"
          git remote set-url mirror "$TARGET_URL"

          if git push mirror main --verbose 2>&1; then
            echo "âœ… Sucesso com token direto!!!"
            exit 0
          fi

          echo "âš ï¸ Formato 2 falhou, tentando formato 3..."

          # Formato 3: oauth2
          echo "ðŸ“Œ Formato 3: oauth2"
          TARGET_URL="https://oauth2:${MIRROR_TOKEN}@github.com/${TARGET_REPO}.git"
          git remote set-url mirror "$TARGET_URL"

          if git push mirror main --verbose 2>&1; then
            echo "âœ… Sucesso com oauth2!"
            exit 0
          fi

          echo ""
          echo "âŒ Todos os formatos falharam!"
          echo "PossÃ­veis causas:"
          echo "  1. Token sem permissÃ£o 'repo' completa"
          echo "  2. Token expirado"
          echo "  3. RepositÃ³rio ${TARGET_REPO} nÃ£o existe"
          echo "  4. Token nÃ£o pertence ao usuÃ¡rio dono do repo"
          echo "  5. Token tem espaÃ§os ou caracteres invisÃ­veis"
          echo ""
          echo "ðŸ”§ SugestÃµes:"
          echo "  - Gere um NOVO token"
          echo "  - Certifique-se de copiar TODO o token (sem espaÃ§os)"
          echo "  - Marque APENAS a permissÃ£o 'repo'"
          echo "  - Use o token do usuÃ¡rio DONO do repositÃ³rio"
          exit 1

  deploy:
    needs: mirror
    runs-on: ubuntu-latest
    environment: Mobile-Sps

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          command_timeout: 30m
          timeout: 30m
          script: |
            BASE=/home/ubuntu/mobile-sps
            REPO=$BASE/repo
            REPO_URL=https://github.com/${{ github.repository }}.git

            if [ ! -d "$REPO/.git" ]; then
              rm -rf $REPO
              mkdir -p $REPO
              git clone $REPO_URL $REPO
            else
              cd $REPO
              git fetch origin
              git reset --hard origin/main
            fi

            if [ -L "$BASE/current" ]; then
              CURRENT=$(readlink -f $BASE/current)
            else
              CURRENT="$BASE/blue"
            fi

            [[ "$CURRENT" == *"blue"* ]] && TARGET="$BASE/green" || TARGET="$BASE/blue"

            rsync -av --delete --exclude ".git" --exclude "__pycache__" $REPO/ $TARGET/

            [ -f "$BASE/.env" ] && cp $BASE/.env $TARGET/.env

            source $BASE/venv/bin/activate

            REQ_HASH=$(sha256sum $TARGET/requirements.txt | awk '{print $1}')
            if [ ! -f "$BASE/.req_hash" ] || [ "$REQ_HASH" != "$(cat $BASE/.req_hash)" ]; then
              pip install -r $TARGET/requirements.txt
              echo "$REQ_HASH" > $BASE/.req_hash
            fi

            lsof -t -i:9000 | xargs -r kill -9 || true
            sleep 2

            cd $TARGET
            gunicorn core.wsgi:application --bind 127.0.0.1:9000 --daemon --pid guni_test.pid
            sleep 10

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/health/ || echo "000")
            [ "$STATUS" != "200" ] && kill $(cat guni_test.pid) && exit 1

            kill $(cat guni_test.pid)
            rm -f guni_test.pid

            ln -sfn $TARGET $BASE/current
            sudo systemctl restart gunicorn
            sudo systemctl restart daphne

      - name: Email â€” Sucesso
        if: success()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS â€” Sucesso (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy concluÃ­do com sucesso.
            CÃ³digo atualizado web e mobile.
            Repo: ${{ github.repository }}
            SHA: ${{ github.sha }}

      - name: Email â€” Falha
        if: failure()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS â€” Falha (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy falhou.
            Repo: ${{ github.repository }}
            SHA: ${{ github.sha }}
