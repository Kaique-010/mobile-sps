name: Deploy Mobile e Web-SPS (Blue/Green)

on:
  push:
    branches: ['main']

jobs:
  mirror:
    name: Mirror via GitHub App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo (com histórico)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Gerar Installation Token (GitHub App)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: spartacusWeb25
          repositories: mobile-sps

      - name: Espelhar para o repositório mirror (sem workflows)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          TARGET_REPO="spartacusWeb25/mobile-sps"

          # Remove workflows ANTES de adicionar ao commit
          rm -rf .github/workflows

          # Adiciona as mudanças ao git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Remove workflows for mirror" || true

          git remote remove mirror 2>/dev/null || true
          git remote add mirror "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git"

          git push mirror main --force

  deploy:
    name: Deploy Blue/Green (via Mirror)
    needs: mirror
    runs-on: ubuntu-latest
    environment: Mobile-Sps

    steps:
      - name: Deploy via SSH (Blue/Green + Python 3.11)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          command_timeout: 30m
          timeout: 30m
          script: |
            set -euo pipefail

            BASE=/home/ubuntu/mobile-sps
            REPO=$BASE/repo
            REPO_URL=https://github.com/spartacusWeb25/mobile-sps.git

            mkdir -p "$BASE"

            # Garantir que Python 3.11 está instalado
            if ! command -v python3.11 &> /dev/null; then
              echo "Instalando Python 3.11..."
              sudo apt update
              sudo apt install -y python3.11 python3.11-venv python3.11-dev
            fi

            # Clonar ou atualizar repositório
            if [ ! -d "$REPO/.git" ]; then
              rm -rf "$REPO"
              git clone "$REPO_URL" "$REPO"
            fi

            cd "$REPO"
            git fetch origin
            git reset --hard origin/main

            # Determinar ambiente atual e target
            if [ -L "$BASE/current" ]; then
              CURRENT=$(readlink -f "$BASE/current")
            else
              CURRENT="$BASE/blue"
            fi

            [[ "$CURRENT" == *blue ]] && TARGET="$BASE/green" || TARGET="$BASE/blue"

            # Rsync código para target
            rsync -av --delete \
              --exclude ".git" \
              --exclude "__pycache__" \
              "$REPO/" "$TARGET/"

            [ -f "$BASE/.env" ] && cp "$BASE/.env" "$TARGET/.env"

            # Verificar se venv existe e é Python 3.11
            VENV_PYTHON_VERSION=""
            if [ -f "$BASE/venv/bin/python" ]; then
              VENV_PYTHON_VERSION=$("$BASE/venv/bin/python" --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            fi

            # Recriar venv se não existir ou não for Python 3.11
            if [ ! -d "$BASE/venv" ] || [ "$VENV_PYTHON_VERSION" != "3.11" ]; then
              echo "Criando venv com Python 3.11..."
              rm -rf "$BASE/venv"
              python3.11 -m venv "$BASE/venv"
              source "$BASE/venv/bin/activate"
              pip install --upgrade pip setuptools wheel
            else
              source "$BASE/venv/bin/activate"
            fi

            # Instalar/atualizar dependências se necessário
            REQ_HASH=$(sha256sum "$TARGET/requirements.txt" | awk '{print $1}')
            if [ ! -f "$BASE/.req_hash" ] || [ "$REQ_HASH" != "$(cat "$BASE/.req_hash")" ]; then
              echo "Instalando dependências..."
              pip install -r "$TARGET/requirements.txt"
              echo "$REQ_HASH" > "$BASE/.req_hash"
            fi

            # Atualizar symlink
            ln -sfn "$TARGET" "$BASE/current"

            # Reiniciar serviços
            sudo systemctl daemon-reload
            sudo systemctl restart gunicorn
            sudo systemctl restart daphne

            sleep 5

            # Health check
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health/ || echo "000")
            if [ "$STATUS" != "200" ]; then
              echo "Health check falhou (Status: $STATUS)"
              sudo systemctl status gunicorn --no-pager
              exit 1
            fi

            echo "Deploy concluído com sucesso!"

      - name: Email — Sucesso
        if: success()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS — Sucesso (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy concluído com sucesso.
            Mirror: spartacusWeb25/mobile-sps
            Ambiente: ${{ github.ref }}
            Commit: ${{ github.sha }}

      - name: Email — Falha
        if: failure()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS — Falha (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy falhou.
            Mirror: spartacusWeb25/mobile-sps
            Erro no workflow: ${{ github.run_number }}
            Verifique os logs em: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
