name: Deploy Mobile-SPS (Blue/Green)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Mobile-Sps

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          command_timeout: 30m
          timeout: 30m
          script: |
            BASE=/home/ubuntu/mobile-sps
            REPO=$BASE/repo

            echo ">> Atualizando repositório local..."
            if [ ! -d "$REPO/.git" ]; then
              rm -rf $REPO
              mkdir -p $REPO
              git clone https://github.com/Kaique-010/mobile-sps.git $REPO
            else
              cd $REPO
              git fetch --all
              git reset --hard origin/main
            fi

            echo ">> Descobrindo ambiente atual..."
            if [ -L "$BASE/current" ]; then
              CURRENT=$(readlink -f $BASE/current)
            else
              CURRENT="$BASE/blue"
            fi

            if [[ "$CURRENT" == *"blue"* ]]; then
              TARGET="$BASE/green"
            else
              TARGET="$BASE/blue"
            fi

            echo ">> Atual: $CURRENT"
            echo ">> Target: $TARGET"

            echo ">> Sincronizando código..."
            rsync -av --delete \
              --exclude ".git" \
              --exclude "__pycache__" \
              $REPO/ $TARGET/

            echo ">> Copiando .env real para o TARGET..."
            if [ -f "$BASE/.env" ]; then
              cp $BASE/.env $TARGET/.env
              echo ">> .env copiado."
            else
              echo "!! .env não encontrado no servidor!"
            fi

            echo ">> Ativando venv..."
            source $BASE/venv/bin/activate

            echo ">> Checando hash de requirements..."
            REQ_HASH=$(sha256sum $TARGET/requirements.txt | awk '{print $1}')
            if [ -f "$BASE/.req_hash" ] && [ "$REQ_HASH" = "$(cat $BASE/.req_hash)" ]; then
              echo ">> requirements.txt inalterado — pulando pip install"
            else
              echo ">> Instalando dependências..."
              pip install -r $TARGET/requirements.txt
              echo "$REQ_HASH" > $BASE/.req_hash
            fi

            # Sem collectstatic e sem migrate/check neste fluxo

            echo ">> Subindo Gunicorn temporário para teste..."
            lsof -t -i:9000 | xargs -r kill -9 || true
            sleep 2

            # Criar arquivos de log antes
            touch $TARGET/guni_error.log $TARGET/guni_access.log

            echo ">> Verificando se gunicorn está disponível..."
            which gunicorn || { echo "!! Gunicorn não encontrado no PATH"; exit 1; }

            echo ">> Iniciando Gunicorn em $TARGET..."
            cd $TARGET
            gunicorn core.wsgi:application \
              --bind 127.0.0.1:9000 \
              --daemon \
              --pid $TARGET/guni_test.pid \
              --timeout 30 \
              --workers 2 \
              --error-logfile $TARGET/guni_error.log \
              --access-logfile $TARGET/guni_access.log \
              --log-level debug 2>&1 | tee -a $TARGET/guni_error.log || { \
                echo "!! Falha ao iniciar Gunicorn"; \
                echo ">> Conteúdo do erro:"; \
                cat $TARGET/guni_error.log 2>/dev/null || echo "(arquivo vazio)"; \
                exit 1; \
              }

            echo ">> Aguardando Gunicorn inicializar (10s)..."
            sleep 10

            if [ ! -f "$TARGET/guni_test.pid" ]; then
              echo "!! Gunicorn não iniciou. Verificando logs..."
              echo ">> Log de erro:"
              cat $TARGET/guni_error.log 2>/dev/null || echo "(arquivo vazio)"
              echo ""
              echo ">> Log de acesso:"
              cat $TARGET/guni_access.log 2>/dev/null || echo "(arquivo vazio)"
              echo ""
              echo ">> Processos Gunicorn:"
              ps aux | grep gunicorn || echo "(nenhum processo)"
              exit 1
            fi

            echo ">> Health-check no TARGET..."
            MAX_ATTEMPTS=10
            ATTEMPT=0
            STATUS=""

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo ">> Tentativa $ATTEMPT/$MAX_ATTEMPTS..."
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://127.0.0.1:9000/health/ || echo "000")
              
              if [ "$STATUS" = "200" ]; then
                echo ">> Health-check OK!"
                break
              fi
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo ">> Status: $STATUS - aguardando 3s..."
                sleep 3
              fi
            done

            if [ "$STATUS" != "200" ]; then
              echo "!! Health-check falhou ($STATUS). Abortando e limpando Gunicorn temporário."
              kill $(cat $TARGET/guni_test.pid) || true
              rm -f $TARGET/guni_test.pid
              exit 1
            fi

            echo ">> Health-check OK — limpando Gunicorn temporário..."
            kill $(cat $TARGET/guni_test.pid) || true
            rm -f $TARGET/guni_test.pid

            echo ">> Alternando versão..."
            ln -sfn $TARGET $BASE/current

            echo ">> Restart Gunicorn + Daphne..."
            sudo systemctl restart gunicorn
            sudo systemctl restart daphne

            echo ">> Deploy Blue/Green finalizado com sucesso!"

      - name: Email — Sucesso
        if: success()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: leokaique7@gmail.com
          password: eyicdldkhmjscwfw
          subject: 'Deploy SPS — Sucesso (${{ github.run_number }})'
          to: leokaique7@gmail.com
          from: leokaique7@gmail.com
          body: |
            Deploy concluído com sucesso.
            Ambiente alternado via Blue/Green.
            Repo: ${{ github.repository }}
            SHA: ${{ github.sha }}

      - name: Email — Falha
        if: failure()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: leokaique7@gmail.com
          password: eyicdldkhmjscwfw
          subject: 'Deploy SPS — Falha (${{ github.run_number }})'
          to: leokaique7@gmail.com
          from: leokaique7@gmail.com
          body: |
            Deploy falhou.
            Última versão mantida.
            Repo: ${{ github.repository }}
            SHA: ${{ github.sha }}
