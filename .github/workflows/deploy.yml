name: Deploy Mobile e Web-SPS (Blue/Green) - DEBUG

on:
  push:
    branches: ['main']

jobs:
  mirror:
    name: Mirror via GitHub App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo (com histórico)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Gerar Installation Token (GitHub App)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: spartacusWeb25
          repositories: mobile-sps

      # ==== NOVO: DEBUG STEP ====
      - name: Debug - Verificar autenticação e permissões
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "=== 1. Verificando qual usuário/app está autenticado ==="
          curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/user || echo "Falha ao verificar usuário"

          echo ""
          echo "=== 2. Verificando se o repo destino existe ==="
          curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/spartacusWeb25/mobile-sps || echo "Repo não encontrado ou sem acesso"

          echo ""
          echo "=== 3. Verificando permissões no repo ==="
          curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/spartacusWeb25/mobile-sps/collaborators/sps-mirror-app%5Bbot%5D/permission || echo "Falha ao verificar permissão"

          echo ""
          echo "=== 4. Listando instalações do app ==="
          curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/app/installations || echo "Falha ao listar instalações"

      - name: Espelhar para o repositório mirror
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          TARGET_REPO="spartacusWeb25/mobile-sps"

          # evita loop de CI
          rm -rf .github/workflows

          git remote remove mirror 2>/dev/null || true
          git remote add mirror "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git"

          git push mirror main --force

  deploy:
    name: Deploy Blue/Green (via Mirror.)
    needs: mirror
    runs-on: ubuntu-latest
    environment: Mobile-Sps

    steps:
      - name: Deploy via SSH (Blue/Green Blindado)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          command_timeout: 30m
          timeout: 30m
          script: |
            set -euo pipefail

            BASE=/home/ubuntu/mobile-sps
            REPO=$BASE/repo
            REPO_URL=https://github.com/spartacusWeb25/mobile-sps.git

            mkdir -p "$BASE"

            if [ ! -d "$REPO/.git" ]; then
              rm -rf "$REPO"
              git clone "$REPO_URL" "$REPO"
            fi

            cd "$REPO"
            git fetch origin
            git reset --hard origin/main

            if [ -L "$BASE/current" ]; then
              CURRENT=$(readlink -f "$BASE/current")
            else
              CURRENT="$BASE/blue"
            fi

            [[ "$CURRENT" == *blue ]] && TARGET="$BASE/green" || TARGET="$BASE/blue"

            rsync -av --delete \
              --exclude ".git" \
              --exclude "__pycache__" \
              "$REPO/" "$TARGET/"

            [ -f "$BASE/.env" ] && cp "$BASE/.env" "$TARGET/.env"

            source "$BASE/venv/bin/activate"

            REQ_HASH=$(sha256sum "$TARGET/requirements.txt" | awk '{print $1}')
            if [ ! -f "$BASE/.req_hash" ] || [ "$REQ_HASH" != "$(cat "$BASE/.req_hash")" ]; then
              pip install -r "$TARGET/requirements.txt"
              echo "$REQ_HASH" > "$BASE/.req_hash"
            fi

            ln -sfn "$TARGET" "$BASE/current"

            sudo systemctl daemon-reload
            sudo systemctl restart gunicorn
            sudo systemctl restart daphne

            sleep 5

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health/ || echo "000")
            if [ "$STATUS" != "200" ]; then
              echo "Health check falhou"
              sudo systemctl status gunicorn --no-pager
              exit 1
            fi

      - name: Email — Sucesso
        if: success()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS — Sucesso (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy concluído com sucesso.
            Mirror: spartacusWeb25/mobile-sps

      - name: Email — Falha
        if: failure()
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'Deploy SPS — Falha (#${{ github.run_number }})'
          to: ${{ secrets.SMTP_USER }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Deploy falhou.
            Mirror: spartacusWeb25/mobile-sps
